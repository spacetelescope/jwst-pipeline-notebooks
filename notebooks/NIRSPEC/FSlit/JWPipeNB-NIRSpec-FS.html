

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>NIRSpec FS Pipeline Notebook &#8212; JWST Pipeline Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRSPEC/FSlit/JWPipeNB-NIRSpec-FS';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="NIRSpec IFU Pipeline Notebook" href="../IFU/JWPipeNB-NIRSpec-IFU.html" />
    <link rel="prev" title="NIRSpec BOTS Pipeline Notebook" href="../BOTS/JWPipeNB-NIRSpec-BOTS.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="JWST Pipeline Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="JWST Pipeline Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../README.html">
                    JWST Pipeline Notebooks
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/Coronagraphy/JWPipeNB-MIRI-Coron.html">MIRI Coronagraphy Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/Imaging/JWPipeNB-MIRI-imaging.html">MIRI Imaging Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/Imaging-TSO/JWPipeNB-MIRI-imaging-TSO.html">MIRI Imaging TSO Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/LRS-slit/JWPipeNB-MIRI-LRS-slit.html">MIRI LRS Slit Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/LRS-slitless-TSO/JWPipeNB-MIRI-LRS-slitless-TSO.html">MIRI LRS Slitless TSO Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS/JWPipeNB-MIRI-MRS.html">MIRI MRS Notebook</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCAM</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCAM/Coronagraphy/JWPipeNB-nircam-coronagraphy.html">NIRCam Coronagraphy Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCAM/Imaging/JWPipeNB-nircam-imaging.html">NIRCam Imaging Notebook</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/AMI/JWPipeNB-niriss-ami.html">NIRISS AMI Pipeline Notebook</a></li>









<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/Imaging/JWPipeNB-niriss-imaging.html">NIRISS Imaging Pipeline Notebook</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../BOTS/JWPipeNB-NIRSpec-BOTS.html">NIRSpec BOTS Notebook</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">NIRSpec Fixed Slit Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../IFU/JWPipeNB-NIRSpec-IFU.html">NIRSpec IFU Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MOS/JWPipeNB-NIRSpec-MOS.html">NIRSpec MOS Notebook</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jwst-pipeline-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jwst-pipeline-notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRSPEC/FSlit/JWPipeNB-NIRSpec-FS.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRSPEC/FSlit/JWPipeNB-NIRSpec-FS.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>NIRSpec FS Pipeline Notebook</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">1. Configuration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-dependencies-and-parameters">Install dependencies and parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-the-basic-parameters-to-configure-the-notebook">Set the basic parameters to configure the notebook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-crds-context-and-server">Set CRDS Context and Server</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#package-imports">2. Package Imports</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-convenience-functions">Define Convenience Functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-mode-setup-ignore-if-not-using-demo-data">3. Demo Mode Setup (ignore if not using demo data)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-setup">4. Directory Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-1-detector1pipeline-calwebb-detector1">5. Stage 1: <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_detector1</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-detector1pipeline">5.1 Configure <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-detector1pipeline">5.2 Run <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrating-science-files">5.2.1 Calibrating Science Files</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrating-background-files">5.2.2 Calibrating Background Files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-2-spec2pipeline-calwebb-spec2">6. Stage 2: <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_spec2</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-spec2pipeline">6.1 Configure <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-spec2pipeline-association-files">6.2 Create <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> Association Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-spec2pipeline">6.3 Run <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">6.3.1 Calibrating Science Files</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">6.3.2 Calibrating Background Files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-3-spec3pipeline-calwebb-spec3">7. Stage 3: <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_spec3</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-spec3pipeline">7.1 Configure <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-spec3pipeline-association-files">7.2 Create <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> Association Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-spec3pipeline">7.3 Run <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-data">8. Visualize the Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#display-detector1pipeline-products">8.1 Display <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> Products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#display-spec2pipeline-products">8.2 Display <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> Products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#display-spec3pipeline-products">8.3 Display <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> Products</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-the-extract1d-reference-file-as-needed">9. Modifying the EXTRACT1D Reference File (as needed)</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <a class="reference internal image-reference" href="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_header.png"><img alt="stsci_logo" src="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_header.png" style="width: 900px;" /></a>
<p><font color="red">This notebook currently fails to execute, use as reference only</font></p>
<section id="nirspec-fs-pipeline-notebook">
<h1>NIRSpec FS Pipeline Notebook<a class="headerlink" href="#nirspec-fs-pipeline-notebook" title="Permalink to this heading">#</a></h1>
<p><strong>Authors</strong>: Elena Manjavacas (emanjavacas&#64;stsci.edu), building on the work of Peter Zeidler (zeidler&#64;stsci.edu), Kayli Glidic (kglidic&#64;stsci.edu), and James Muzerolle (muzerol&#64;stsci.edu); NIRSpec branch </br>
<strong>Last Updated</strong>: April 16, 2025 </br>
<strong>Pipeline Version</strong>: 1.18.0 (Build 11.3, Context jwst_1364.pmap)</p>
<p><strong>Purpose</strong>:<br>
This notebook provides a framework for processing generic Near-Infrared Spectrograph (NIRSpec) fixed slit (FS) data through the three stages of the JWST pipeline. It includes how to use associations for multi-exposure observations and how to interact and work with JWST datamodels. Data is assumed to be organized into two folders: science and background, as specified in the paths set up below. In most cases, editing cells outside the <span class="xref myst">Configuration</span> section is unnecessary unless the standard pipeline processing options or plot parameters need to be modified.</p>
<p><strong><span class="xref myst">Data</span></strong>: <br>
This notebook is set up to use observations of HD1808347 A3V standard star (point source) with the G235M grism obtained by Proposal ID (PID) 1128, Observation 6. The demo data will be automatically downloaded in the <code class="docutils literal notranslate"><span class="pre">demo_mode</span></code> unless disabled (i.e., to use local files instead).</p>
<p><strong><span class="xref myst">JWST pipeline version and CRDS context</span></strong>: <br>
This notebook was written for the calibration pipeline version given above and uses the context associated with this version of the JWST Calibration Pipeline. Information about this an other contexts can be found in the JWST Calibration Reference Data System (CRDS)
<a class="reference external" href="https://jwst-crds.stsci.edu/">server</a>. If you use different pipeline versions, please refer to the table <a class="reference external" href="https://jwst-crds.stsci.edu/display_build_contexts/">here</a> to determine what context to use. To learn more about the differences for the pipeline, read the relevant <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline/jwst-operations-pipeline-build-information#references">documentation</a></p>
<p>Please note that pipeline software development is a continuous process, so results in some cases may be slightly different if a subsequent version is used. <strong>For optimal results, users are strongly encouraged to reprocess their data using the most recent pipeline version and <a class="reference external" href="https://jwst-crds.stsci.edu/display_build_contexts/">associated CRDS context</a>, taking advantage of bug fixes and algorithm improvements.</strong>
Any <a class="reference external" href="https://jwst-docs.stsci.edu/known-issues-with-jwst-data/nirspec-known-issues/nirspec-fs-known-issues#gsc.tab=0">known issues</a> for this build are noted in the notebook.</p>
<p><strong>Updates</strong>: <br>
This notebook is regularly updated to incorporate the latest pipeline improvements. Find the most up-to-date version of this notebook <a class="reference external" href="https://github.com/spacetelescope/jwst-pipeline-notebooks/">here</a>.</p>
<p><strong>Recent Changes</strong>:</br></p>
<ul class="simple">
<li><p>October 15, 2024: Converted notebook to follow standard template (kglidic&#64;stsci.edu). </br></p></li>
<li><p>November 4, 2024: Notebook updated to JWST pipeline version 1.16.0 (Build 11.1).</p></li>
<li><p>January 6, 2025: Updated formatting and added examples for creating association files.</p></li>
<li><p>January 27, 2025: Notebook updated to JWST pipeline version 1.17.1 (Build 11.2) and added more association file information.</p></li>
<li><p>April 16, 2025: Updated JWST pipeline version 1.18.0 (Build 11.3) and added Jdaviz plotting options.</p></li>
</ul>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><span class="xref myst">1. Configuration</span></p></li>
<li><p><span class="xref myst">2. Package Imports</span></p></li>
<li><p><span class="xref myst">3. Demo Mode Setup</span></p></li>
<li><p><span class="xref myst">4. Directory Setup</span></p></li>
<li><p><span class="xref myst">5. Stage 1: <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_detector1</span></code>)</span></p>
<ul>
<li><p><span class="xref myst">5.1 Configure <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code></span></p></li>
<li><p><span class="xref myst">5.2 Run <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code></span></p>
<ul>
<li><p><span class="xref myst">5.2.1 Calibrating Science Files</span></p></li>
<li><p><span class="xref myst">5.2.2 Calibrating Background Files</span></p></li>
</ul>
</li>
</ul>
</li>
<li><p><span class="xref myst">6. Stage 2: <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_spec2</span></code>)</span></p>
<ul>
<li><p><span class="xref myst">6.1 Configure <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code></span></p></li>
<li><p><span class="xref myst">6.2 Create <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> Association Files</span></p></li>
<li><p><span class="xref myst">6.3 Run <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code></span></p>
<ul>
<li><p><span class="xref myst">6.3.1 Calibrating Science Files</span></p></li>
<li><p><span class="xref myst">6.3.2 Calibrating Background Files</span></p></li>
</ul>
</li>
</ul>
</li>
<li><p><span class="xref myst">7. Stage 3: <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_spec3</span></code>)</span></p>
<ul>
<li><p><span class="xref myst">7.1 Configure <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code></span></p></li>
<li><p><span class="xref myst">7.2 Create <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> Association Files</span></p></li>
<li><p><span class="xref myst">7.3 Run <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code></span></p></li>
</ul>
</li>
<li><p><span class="xref myst">8. Visualize the Data</span></p>
<ul>
<li><p><span class="xref myst">8.1 Display <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> Products</span></p></li>
<li><p><span class="xref myst">8.2 Display <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> Products</span></p></li>
<li><p><span class="xref myst">8.3 Display <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> Products</span></p></li>
</ul>
</li>
<li><p><span class="xref myst">9. Modifying the EXTRACT1D Reference File (as needed)</span></p></li>
</ul>
</section>
<hr class="docutils" />
<section id="configuration">
<h2>1. Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">#</a></h2>
<section id="install-dependencies-and-parameters">
<h3>Install dependencies and parameters<a class="headerlink" href="#install-dependencies-and-parameters" title="Permalink to this heading">#</a></h3>
<p>To make sure that the pipeline version is compatible with the steps discussed below and that the required dependencies and packages get installed, you can create a fresh conda environment and install the provided requirements.txt file before starting this notebook:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>conda create -n nirspec_fs_pipeline python=3.12
conda activate nirspec_fs_pipeline
pip install -r requirements.txt
</pre></div>
</div>
</section>
<section id="set-the-basic-parameters-to-configure-the-notebook">
<h3>Set the basic parameters to configure the notebook<a class="headerlink" href="#set-the-basic-parameters-to-configure-the-notebook" title="Permalink to this heading">#</a></h3>
<p>These parameters determine what data gets used, where data is located (if already on disk), and the type of background subtraction (if any). The list of parameters includes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">demo_mode</span></code>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: Downloads example data from the <a class="reference external" href="https://archive.stsci.edu/">Barbara A. Mikulski Archive for Space Telescopes (MAST)</a> and processes it through the pipeline. All processing will occur in a local directory unless modified in <span class="xref myst">Section 3</span> below.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code>: Process your own downloaded data; provide its location.<br><br></p></li>
</ul>
</li>
<li><p><strong>Directories with data</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">sci_dir</span></code>: Directory where science observation data is stored.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bg_dir</span></code>: Directory where dedicated background observation data is stored.<br><br></p></li>
</ul>
</li>
<li><p><strong><a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/background_subtraction/main.html#spectroscopic-modes:~:text=the%20calwebb_image3%20pipeline.-,Spectroscopic%20Modes,%EF%83%81,-Spectroscopic%20observations%20allow">Backgroud subtraction methods</a></strong>: <br></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">master_bg</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code>: Apply master-background subtraction in <code class="docutils literal notranslate"><span class="pre">calwebb_spec3</span></code>. For dedicated background observations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pixel_bg</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code>: Apply pixel-to-pixel background subtraction in <code class="docutils literal notranslate"><span class="pre">calwebb_spec2</span></code>.  This is the default pipeline setting. Typically uses noded observations.<br><br></p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic import necessary for configuration.</span>
<span class="c1"># Uncomment logging to hide log information.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="c1">#import logging</span>

<span class="c1"># Control logging level: INFO, WARNING, ERROR</span>
<span class="c1"># Run command logging.disable if want to hide logging</span>
<span class="c1"># ERROR messages.</span>
<span class="c1">#logging.disable(logging.ERROR)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
<p>Note that <code class="docutils literal notranslate"><span class="pre">demo_mode</span></code> must be set appropriately below.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set parameters for demo_mode, data mode directories, and processing steps.</span>

<span class="c1"># -------------------------------DEMO MODE-----------------------------------</span>
<span class="n">demo_mode</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running in demonstration mode using online example data!&#39;</span><span class="p">)</span>

<span class="c1"># ----------------------------User Mode Directories--------------------------</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># If demo_mode = False, look for user data in these paths.</span>

    <span class="c1"># Set directory paths for processing specific data; adjust to your local</span>
    <span class="c1"># directory setup (examples provided below).</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="c1"># Directory to science observation data; expects uncalibrated data in</span>
    <span class="c1"># sci_dir/uncal/ and results in stage1, stage2, and stage3 directories.</span>
    <span class="n">sci_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;fs_data_01128/Obs006&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Directory to background observation data; expects uncalibrated data in</span>
    <span class="c1"># bg_dir/uncal/ and results in stage1, stage2, and stage3 directories.</span>
    <span class="c1">#bg_dir = os.path.join(basedir, &#39;fs_data_02288/Obs002&#39;, &#39;&#39;)</span>
    <span class="n">bg_dir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># If no background observation, use an empty string.</span>

<span class="c1"># ---------------------------Set Processing Steps----------------------------</span>
<span class="c1"># Individual pipeline stages can be turned on/off here.  Note that a later</span>
<span class="c1"># stage won&#39;t be able to run unless data products have already been</span>
<span class="c1"># produced from the prior stage.</span>

<span class="c1"># Science processing.</span>
<span class="n">dodet1</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_detector1</span>
<span class="n">dospec2</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_spec2</span>
<span class="n">dospec3</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_spec3</span>
<span class="n">doviz</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Visualize calwebb outputs</span>

<span class="c1"># Background Processing.</span>
<span class="n">dodet1bg</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># calwebb_detector1</span>
<span class="n">dospec2bg</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># calwebb_spec2 (needed for Master Background subtraction)</span>

<span class="c1"># How should background subtraction be done?</span>
<span class="c1"># Set one or None of the flags below.</span>
<span class="c1"># If none are selected, data will not be background subtracted.</span>
<span class="c1"># If background subtraction is done in Spec2 it will be skipped in Spec3.</span>
<span class="c1"># Note: Master-background subtraction is for dedicated background observations.</span>
<span class="c1"># Dedicated backgrounds must be processed through spec2 first.</span>
<span class="n">master_bg</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Master-background subtraction in spec3.</span>
<span class="n">pixel_bg</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Pixel-based background subtraction in spec2.</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="set-crds-context-and-server">
<h3>Set CRDS Context and Server<a class="headerlink" href="#set-crds-context-and-server" title="Permalink to this heading">#</a></h3>
<p>Before importing <code class="docutils literal notranslate"><span class="pre">CRDS</span></code> and <code class="docutils literal notranslate"><span class="pre">JWST</span></code> modules, we need to configure our environment. This includes defining a CRDS cache directory in which to keep the reference files that will be used by the calibration pipeline. If the local CRDS cache directory has not been set, it will automatically be created in the home directory.</p>
<p><a class="reference external" href="https://jwst-crds.stsci.edu/display_build_contexts/">Build Context Table</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------------------------Set CRDS context and paths------------------------</span>
<span class="c1"># Each version of the calibration pipeline is associated with a specific CRDS</span>
<span class="c1"># context file. The pipeline will select the appropriate context file behind</span>
<span class="c1"># the scenes while running. However, if you wish to override the default context</span>
<span class="c1"># file and run the pipeline with a different context, you can set that using</span>
<span class="c1"># the CRDS_CONTEXT environment variable. Here, we show how this is done,</span>
<span class="c1"># although we leave the line commented out in order to use the default context.</span>
<span class="c1"># If you wish to specify a different context, uncomment the line below.</span>
<span class="c1">#os.environ[&#39;CRDS_CONTEXT&#39;] = &#39;jwst_1364.pmap&#39;  # CRDS context for 1.18.0</span>

<span class="c1"># Set CRDS cache directory to user home if not already set.</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;crds_cache&#39;</span><span class="p">)</span>

<span class="c1"># Check whether the CRDS server URL has been set. If not, set it.</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://jwst-crds.stsci.edu&#39;</span>

<span class="c1"># Output the current CRDS path and server URL in use.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CRDS local filepath:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CRDS file server:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="package-imports">
<h2>2. Package Imports<a class="headerlink" href="#package-imports" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the entire available screen width for this notebook.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">JSON</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;style&gt;.container { width:95% !important; }&lt;/style&gt;&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ----------------------General Imports----------------------</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># ----------------------Astropy Imports----------------------</span>
<span class="c1"># Astropy utilities for opening FITS files, downloading demo files, etc.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageNormalize</span><span class="p">,</span> <span class="n">ManualInterval</span><span class="p">,</span> <span class="n">LogStretch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearStretch</span><span class="p">,</span> <span class="n">AsinhStretch</span><span class="p">,</span> <span class="n">simple_norm</span>

<span class="c1"># ----------------------Astroquery Import----------------------</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Observations</span>

<span class="c1"># ----------------------Plotting Imports---------------------</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">PatchCollection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jdaviz</span><span class="w"> </span><span class="kn">import</span> <span class="n">Specviz2d</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p>Installation instructions for the JWST pipeline found in <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline-overview">JWST User Documentation</a> and
<a class="reference external" href="https://jwst-pipeline.readthedocs.io">ReadtheDocs</a> •
<a class="reference external" href="https://github.com/spacetelescope/jwst">Github</a></p>
</div> <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ----------------------JWST Calibration Pipeline Imports----------------------</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwst</span>  <span class="c1"># Import the base JWST and CRDS packages.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">crds</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">crds.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">stpipe</span><span class="w"> </span><span class="kn">import</span> <span class="n">crds_client</span>

<span class="c1"># JWST pipelines (each encompassing many steps).</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Detector1Pipeline</span>  <span class="c1"># calwebb_detector1</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spec2Pipeline</span>  <span class="c1"># calwebb_spec2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spec3Pipeline</span>  <span class="c1"># calwebb_spec3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.extract_1d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Extract1dStep</span>  <span class="c1"># Extract1D Step</span>

<span class="c1"># JWST pipeline utilities.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst</span><span class="w"> </span><span class="kn">import</span> <span class="n">datamodels</span>  <span class="c1"># JWST datamodels.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.associations</span><span class="w"> </span><span class="kn">import</span> <span class="n">asn_from_list</span> <span class="k">as</span> <span class="n">afl</span>  <span class="c1"># Tools for creating ASN files.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.associations.lib.rules_level2_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">DMSLevel2bBase</span>  <span class="c1"># Lvl2 ASN file.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.associations.lib.rules_level3_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">DMS_Level3_Base</span>  <span class="c1"># Lvl3 ASN file.</span>

<span class="n">default_context</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">get_default_context</span><span class="p">(</span><span class="s1">&#39;jwst&#39;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;build&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;JWST Calibration Pipeline Version = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jwst</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default CRDS Context for JWST Version </span><span class="si">{</span><span class="n">jwst</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">default_context</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using CRDS Context: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRDS_CONTEXT&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">default_context</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<section id="define-convenience-functions">
<h3>Define Convenience Functions<a class="headerlink" href="#define-convenience-functions" title="Permalink to this heading">#</a></h3>
<p>Define a function that filters a list of files based on a specific FITS header key-value condition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">filter_list</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter a list of files based on a specific FITS header key-value condition.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list</span>
<span class="sd">        List of file paths to FITS files.</span>
<span class="sd">    key : str</span>
<span class="sd">        The FITS header key to check.</span>
<span class="sd">    value : Any</span>
<span class="sd">        The value to match for the specified header key.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list : A list of file paths that satisfy the key-value condition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Define a function that filters files based on detector, filter, and grating.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_matching</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">detector</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">grating</span><span class="p">,</span> <span class="n">fxd_slit</span><span class="p">,</span> <span class="n">exp_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filters a list of FITS files to find those with matching </span>
<span class="sd">    detector, filter, and grating for a specified exposure type.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list of str</span>
<span class="sd">        Paths to FITS files to check.</span>
<span class="sd">    detector : str</span>
<span class="sd">        Expected value of the DETECTOR keyword.</span>
<span class="sd">    filt : str</span>
<span class="sd">        Expected value of the FILTER keyword.</span>
<span class="sd">    grating : str</span>
<span class="sd">        Expected value of the GRATING keyword.</span>
<span class="sd">    fxd_slit : str</span>
<span class="sd">        Fixed slit name.</span>
<span class="sd">    exp_type : str, optional</span>
<span class="sd">        The exposure type to match.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    files_regular : list of str</span>
<span class="sd">        Files with matching configuration and IS_IMPRT == False or missing.</span>
<span class="sd">    files_imprint : list of str)</span>
<span class="sd">        Files with matching configuration and IS_IMPRT == True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files_regular</span><span class="p">,</span> <span class="n">files_imprint</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="c1"># Skip if EXP_TYPE doesn&#39;t match the provided one.</span>
        <span class="k">if</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;EXP_TYPE&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">exp_type</span><span class="p">:</span>
            <span class="n">files_regular</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Check if DETECTOR, FILTER, and GRATING match</span>
        <span class="n">detector_match</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;DETECTOR&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">detector</span>
        <span class="n">filter_match</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;FILTER&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">filt</span>
        <span class="n">grating_match</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;GRATING&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">grating</span>
        <span class="n">slit_match</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;FXD_SLIT&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">fxd_slit</span>
        <span class="k">if</span> <span class="n">detector_match</span> <span class="ow">and</span> <span class="n">filter_match</span> <span class="ow">and</span> <span class="n">grating_match</span> <span class="ow">and</span> <span class="n">slit_match</span><span class="p">:</span>
            <span class="c1"># Only IFU and MOS observations have imprint exposures.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">is_imprt</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;IS_IMPRT&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">is_imprt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="p">(</span><span class="n">files_imprint</span> <span class="k">if</span> <span class="n">is_imprt</span> <span class="k">else</span> <span class="n">files_regular</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">files_regular</span><span class="p">,</span> <span class="n">files_imprint</span>
</pre></div>
</div>
</div>
</div>
<p>Define a function that checks the grating wheel tilt value between two files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">match_gwa</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if GWA tilt values match closely enough to be associated.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file1, file2 : str </span>
<span class="sd">        Input exposures FITS file paths.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    True if both GWA tilt values match within tolerance, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hdr1</span><span class="p">,</span> <span class="n">hdr2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">file1</span><span class="p">),</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">file2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
        <span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;GWA_XTIL&#39;</span><span class="p">],</span> <span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;GWA_YTIL&#39;</span><span class="p">]),</span>
        <span class="p">(</span><span class="n">hdr2</span><span class="p">[</span><span class="s1">&#39;GWA_XTIL&#39;</span><span class="p">],</span> <span class="n">hdr2</span><span class="p">[</span><span class="s1">&#39;GWA_YTIL&#39;</span><span class="p">]),</span>
        <span class="n">atol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start a timer to keep track of runtime.</span>
<span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="demo-mode-setup-ignore-if-not-using-demo-data">
<h2>3. Demo Mode Setup (ignore if not using demo data)<a class="headerlink" href="#demo-mode-setup-ignore-if-not-using-demo-data" title="Permalink to this heading">#</a></h2>
<div class="alert alert-block alert-info">
<p>The data in this notebook is public and does not require a token. For other data sets, you may need to provide a token. For more infomation visit <a class="reference external" href="https://astroquery.readthedocs.io/en/latest/index.html#">astroquery</a> documentation.</p>
</div> 
<p>If running in demonstration mode, set up the program information to retrieve the uncalibrated data (<code class="docutils literal notranslate"><span class="pre">_uncal.fits</span></code>) automatically from MAST using <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>. MAST provides flexibility by allowing searches based on proposal ID and observation ID, rather than relying solely on filenames. More information about the JWST file naming conventions can be found <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/file_naming.html">here</a>.</p>
<p>The FS demo data in this notebook is from the <a class="reference external" href="https://www.stsci.edu/jwst/science-execution/program-information?id=1128">NIRSpec calibration program 1128</a> and features observations of HD1808347 (point source) using the G235M grism. The program setup is briefly summarized in the table below.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head text-center"><p>Demo Target: HD1808347 A3V Standard Star</p></th>
<th class="head text-center"><p></p></th>
<th class="head text-center"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>PROGRAM</p></td>
<td class="text-center"><p>01128</p></td>
<td class="text-center"><p>Program number</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>OBSERVTN</p></td>
<td class="text-center"><p>006</p></td>
<td class="text-center"><p>Observation number</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p><a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-spectrograph/nirspec-observing-modes/nirspec-fixed-slits-spectroscopy#gsc.tab=0:~:text=%C2%A0Table%202.%20NIRSpec%20A%20fixed%20slit%C2%A0instrument%20configurations%2C%20resolutions%2C%20and%20wavelength%20ranges">GRATING/FILTER</a></p></td>
<td class="text-center"><p>G235M/F170LP</p></td>
<td class="text-center"><p>λ: 1.66–3.17 μm (a medium resolution, R ~ 1000)</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>SUBARRAY</p></td>
<td class="text-center"><p>SUBS200A1</p></td>
<td class="text-center"><p>Subarray used</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>NINTS</p></td>
<td class="text-center"><p>2</p></td>
<td class="text-center"><p>Number of integrations in exposure</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>NGROUPS</p></td>
<td class="text-center"><p>30</p></td>
<td class="text-center"><p>Number of groups in integration</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>DURATION</p></td>
<td class="text-center"><p>96.637 [s]</p></td>
<td class="text-center"><p>Total duration of one exposure</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>READPATT</p></td>
<td class="text-center"><p>NRSRAPID</p></td>
<td class="text-center"><p>Readout pattern</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>PATTTYPE</p></td>
<td class="text-center"><p>3-POINT-NOD</p></td>
<td class="text-center"><p>Primary dither pattern type</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>NUMDTHPT</p></td>
<td class="text-center"><p>3</p></td>
<td class="text-center"><p>Total number of points in pattern</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>SRCTYAPT</p></td>
<td class="text-center"><p>POINT</p></td>
<td class="text-center"><p>Source type selected in APT</p></td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<div><p><strong>Note:</strong> The presence of a physical gap between detectors affects high-resolution FS observations because the spectra are long enough to span both NIRSpec detectors. <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-spectrograph/nirspec-operations/nirspec-fs-operations/nirspec-fs-wavelength-ranges-and-gaps#gsc.tab=0">More Info …</a></p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the program information and directories to collect</span>
<span class="c1"># the data in demo_mode.</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running in demonstration mode. &#39;</span>
          <span class="s1">&#39;Example data will be downloaded from MAST!&#39;</span><span class="p">)</span>

    <span class="c1"># For non public data sets, you may need to provide a token.</span>
    <span class="c1"># However, for security it is not recommended to enter tokens into</span>
    <span class="c1"># a terminal or Jupyter notebook.</span>
    <span class="c1">#Observations.login(token=&quot;your-token&quot;)</span>

    <span class="c1"># --------------Program and observation information--------------</span>
    <span class="n">program</span> <span class="o">=</span> <span class="s2">&quot;01128&quot;</span>
    <span class="n">sci_observtn</span> <span class="o">=</span> <span class="s2">&quot;006&quot;</span>
    <span class="n">bg_observtn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;F170LP;G235M&quot;</span><span class="p">]</span>

    <span class="c1"># ----------Define the base and observation directories----------</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">sci_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;fs_data_</span><span class="si">{</span><span class="n">program</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sci_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Obs</span><span class="si">{</span><span class="n">sci_observtn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">uncal_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;uncal/&#39;</span><span class="p">)</span>

    <span class="c1"># If no background observation, leave blank.</span>
    <span class="n">bg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;fs_data_</span><span class="si">{</span><span class="n">program</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">bg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Obs</span><span class="si">{</span><span class="n">bg_observtn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">bg_observtn</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">uncal_bgdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="s1">&#39;uncal/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">bg_observtn</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># ------Ensure directories for downloading MAST data exists------</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Makes directory only when a background observation is provided.</span>
    <span class="k">if</span> <span class="n">bg_observtn</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">uncal_bgdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running with user provided data.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><br>Click on the following links to learn more about querying and downloading data:<br>
• <a class="reference external" href="https://astroquery.readthedocs.io/en/latest/mast/mast_obsquery.html#downloading-data">Downloading data</a><br>
• <a class="reference external" href="https://astroquery.readthedocs.io/en/latest/api/astroquery.mast.ObservationsClass.html">Observations Class</a><br>
• <a class="reference external" href="https://mast.stsci.edu/api/v0/_productsfields.html">Products Field Descriptions</a><br><br></p>
<p>Compile tables of files from MAST associated with the science (SCI) and, if applicable, background (BG) observations. Note that the demo data does not have BG observations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obtain a list of observation IDs for the specified demo program.</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    
    <span class="c1"># --------------------SCIENCE Observation--------------------</span>
    <span class="n">sci_obs_id_table</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">instrument_name</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NIRSPEC/SLIT&#39;</span><span class="p">],</span>
                                                   <span class="n">provenance_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CALJWST&quot;</span><span class="p">],</span>
                                                   <span class="n">obs_id</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;*</span><span class="si">{</span><span class="n">program</span><span class="si">}</span><span class="s1">*</span><span class="si">{</span><span class="n">sci_observtn</span><span class="si">}</span><span class="s1">*&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">bg_dir</span><span class="p">:</span>
        <span class="c1"># ------------------BACKGROUND Observation-------------------</span>
        <span class="n">bg_obs_id_table</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">instrument_name</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NIRSPEC/SLIT&#39;</span><span class="p">],</span>
                                                      <span class="n">provenance_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CALJWST&quot;</span><span class="p">],</span>
                                                      <span class="n">obs_id</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;*</span><span class="si">{</span><span class="n">program</span><span class="si">}</span><span class="s1">*</span><span class="si">{</span><span class="n">bg_observtn</span><span class="si">}</span><span class="s1">*&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>The demo dataset consists of six <code class="docutils literal notranslate"><span class="pre">_uncal.fits</span></code> files, each approximately 15 MB in size.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert visits into a list of uncalibrated data and ASN files.</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    
    <span class="n">file_criteria</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">filters</span><span class="p">,</span> <span class="s1">&#39;calib_level&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                     <span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">:</span> <span class="s1">&#39;UNCAL&#39;</span><span class="p">}</span>

    <span class="c1"># Initialize lists for science and background files.</span>
    <span class="n">sci_downloads</span><span class="p">,</span> <span class="n">bg_downloads</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">pfilter</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span>  <span class="c1"># Alias for filter_products method.</span>

    <span class="c1"># ----------Identify uncalibrated SCIENCE files associated with each visit----------</span>
    <span class="k">for</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="n">sci_obs_id_table</span><span class="p">:</span>
        <span class="n">sci_products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">exposure</span><span class="p">)</span>

        <span class="c1"># Filter for full-size science files (exclude smaller confirmation images).</span>
        <span class="n">avg_sci_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">sci_products</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
        <span class="n">sci_products</span> <span class="o">=</span> <span class="n">sci_products</span><span class="p">[</span><span class="n">sci_products</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">avg_sci_size</span><span class="p">]</span>
        <span class="n">sci_downloads</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pfilter</span><span class="p">(</span><span class="n">sci_products</span><span class="p">,</span> <span class="o">**</span><span class="n">file_criteria</span><span class="p">)[</span><span class="s1">&#39;dataURI&#39;</span><span class="p">])</span>

    <span class="c1"># --------Identify uncalibrated BACKGROUND files associated with each visit---------</span>
    <span class="k">if</span> <span class="n">bg_dir</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="n">bg_obs_id_table</span><span class="p">:</span>
            <span class="n">bg_products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">exposure</span><span class="p">)</span>

            <span class="c1"># Filter for full-size background files (exclude smaller confirmation images).</span>
            <span class="n">avg_bg_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">bg_products</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
            <span class="n">bg_products</span> <span class="o">=</span> <span class="n">sci_products</span><span class="p">[</span><span class="n">bg_products</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">avg_bg_size</span><span class="p">]</span>
            <span class="n">bg_downloads</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pfilter</span><span class="p">(</span><span class="n">bg_products</span><span class="p">,</span> <span class="o">**</span><span class="n">file_criteria</span><span class="p">)[</span><span class="s1">&#39;dataURI&#39;</span><span class="p">])</span>

    <span class="c1"># Filter out other observations and remove duplicates.</span>
    <span class="n">sci_downloads</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sci_downloads</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;jw</span><span class="si">{</span><span class="n">program</span><span class="si">}{</span><span class="n">sci_observtn</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">}</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Science files selected for downloading: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sci_downloads</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bg_dir</span><span class="p">:</span>
        <span class="n">bg_downloads</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">bg_downloads</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;jw</span><span class="si">{</span><span class="n">program</span><span class="si">}{</span><span class="n">bg_observtn</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Background files selected for downloading: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bg_downloads</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Background files selected for downloading: 0&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Download the data.</p>
<div class="alert alert-block alert-warning">
<p><strong>Warning</strong>: If this notebook is halted during this step, the downloaded file may be incomplete, and cause crashes later on!</p>
</div><div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download data and place them into the appropriate directories.</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sci_downloads</span><span class="p">:</span>
        <span class="n">sci_manifest</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">local_path</span><span class="o">=</span><span class="n">uncal_dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">bg_downloads</span><span class="p">:</span>
        <span class="n">bg_manifest</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">local_path</span><span class="o">=</span><span class="n">uncal_bgdir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="directory-setup">
<h2>4. Directory Setup<a class="headerlink" href="#directory-setup" title="Permalink to this heading">#</a></h2>
<p>Set up detailed paths to input/output stages here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define/create output subdirectories to keep data products organized.</span>

<span class="c1"># -----------------------------Science Directories------------------------------</span>
<span class="n">uncal_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;uncal/&#39;</span><span class="p">)</span>  <span class="c1"># Uncalibrated pipeline inputs.</span>
<span class="n">asn_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;asn/&#39;</span><span class="p">)</span>  <span class="c1"># Association files.</span>
<span class="n">det1_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage1/&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_detector1 pipeline outputs.</span>
<span class="n">spec2_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage2/&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_spec2 pipeline outputs.</span>
<span class="n">spec3_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage3/&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_spec3 pipeline outputs.</span>

<span class="c1"># Creates the directories if target directory does not exist.</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">asn_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">spec2_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">spec3_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># ---------------------------Background Directories-----------------------------</span>
<span class="k">if</span> <span class="n">bg_dir</span><span class="p">:</span>
    <span class="n">uncal_bgdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="s1">&#39;uncal/&#39;</span><span class="p">)</span>  <span class="c1"># Uncalibrated pipeline inputs.</span>
    <span class="n">asn_bgdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="s1">&#39;asn/&#39;</span><span class="p">)</span>  <span class="c1"># Association files.</span>
    <span class="n">det1_bgdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="s1">&#39;stage1/&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_detector1 pipeline outputs.</span>
    <span class="n">spec2_bgdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="s1">&#39;stage2/&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_spec2 pipeline outputs.</span>

    <span class="c1"># Creates directories if background observations are provided and do not already exist.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">det1_bgdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">asn_bgdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">spec2_bgdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark.</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">time1</span><span class="o">-</span><span class="n">time0</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="stage-1-detector1pipeline-calwebb-detector1">
<h2>5. Stage 1: <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_detector1</span></code>)<a class="headerlink" href="#stage-1-detector1pipeline-calwebb-detector1" title="Permalink to this heading">#</a></h2>
<p>In this section, we process the data through the <code class="docutils literal notranslate"><span class="pre">calwebb_detector1</span></code> pipeline to create Stage 1 <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/science_products.html">data products</a>.</p>
<ul class="simple">
<li><p><strong>Input</strong>: Raw exposure (<code class="docutils literal notranslate"><span class="pre">_uncal.fits</span></code>) containing original data from all detector readouts (ncols x nrows x ngroups x nintegrations).</p></li>
<li><p><strong>Output</strong>: Uncalibrated countrate (slope) image in units of DN/s:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">_rate.fits</span></code>: A single countrate image averaged over multiple integrations (if available).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_rateints.fits</span></code>: Countrate images for each integration, saved in multiple extensions.</p></li>
</ul>
</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> applies basic detector-level corrections on a group-by-group basis, followed by ramp fitting for all exposure types, commonly referred to as “ramps-to-slopes” processing.</p>
<hr class="docutils" />
<section id="configure-detector1pipeline">
<h3>5.1 Configure <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code><a class="headerlink" href="#configure-detector1pipeline" title="Permalink to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> has the following steps available for NIRSpec FS:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">group_scale</span></code> : Rescales pixel values to correct for improper onboard frame averaging.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dq_init</span></code> : Initializes the data quality (DQ) flags for the input data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">saturation</span></code> : Flags pixels at or below the A/D floor or above the saturation threshold.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">superbias</span></code> : Subtracts the superbias reference file from the input data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refpix</span></code> : Use reference pixels to correct bias drifts.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">linearity</span></code> : Applies a correction for non-linear detector response.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dark_current</span></code> : Subtracts the dark current reference file from the input data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jump</span></code> : Performs CR/jump detection on each ramp integration within an exposure.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clean_flicker_noise</span></code>: Removes flicker (1/f) noise from calibrated ramp images (similar to <code class="docutils literal notranslate"><span class="pre">nsclean</span></code> in spec2).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ramp_fit</span></code> : Determines the mean count rate (counts per second) for each pixel by performing a linear fit to the input data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gain_scale</span></code> : Corrects pixel values for non-standard gain settings, primarily in NIRSpec subarray data.</p></li>
</ul>
</div></blockquote>
<p>For more information about each step and a full list of step arguments, please refer to the official documentation: <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline-overview/stages-of-jwst-data-processing/calwebb_detector1">JDox</a> and
<a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/stable/jwst/pipeline/calwebb_detector1.html">ReadtheDocs</a></p>
<p>Below, we set up a dictionary that defines how the <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> should be configured for FS data.</p>
<div class="alert alert-warning">
  To override specific steps and reference files, use the examples below.
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the Detector1 pipeline should be configured.</span>

<span class="c1"># -------------------------Boilerplate dictionary setup-------------------------</span>
<span class="n">det1dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;group_scale&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;dq_init&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;saturation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;superbias&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;refpix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;linearity&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;dark_current&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;clean_flicker_noise&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;ramp_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;gain_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># ---------------------------Override reference files---------------------------</span>

<span class="c1"># Overrides for various reference files (example).</span>
<span class="c1"># Files should be in the base local directory or provide full path.</span>
<span class="c1">#det1dict[&#39;dq_init&#39;][&#39;override_mask&#39;] = &#39;myfile.fits&#39;  # Bad pixel mask</span>
<span class="c1">#det1dict[&#39;superbias&#39;][&#39;override_superbias&#39;] = &#39;myfile.fits&#39;  # Bias subtraction</span>
<span class="c1">#det1dict[&#39;dark_current&#39;][&#39;override_dark&#39;] = &#39;myfile.fits&#39;  # Dark current subtraction</span>

<span class="c1"># -----------------------------Set step parameters------------------------------</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped (example).</span>
<span class="c1">#det1dict[&#39;linearity&#39;][&#39;skip&#39;] = True  # This is the default.</span>

<span class="c1"># Suppress computations for saturated ramps with</span>
<span class="c1"># only one good (unsaturated) sample (default True).</span>
<span class="c1"># The demo data has some saturation.</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;ramp_fit&#39;</span><span class="p">][</span><span class="s1">&#39;suppress_one_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Turn on multi-core processing (off by default).</span>
<span class="c1"># Choose what fraction of cores to use (quarter, half, or all).</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">][</span><span class="s1">&#39;maximum_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;half&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-info">
<p>Many exposures are affected by artifacts known as <a class="reference external" href="https://jwst-docs.stsci.edu/known-issues-with-jwst-data/shower-and-snowball-artifacts#gsc.tab=0">snowballs</a> caused by large cosmic ray events. These artifacts are particularly significant in deep exposures with long integration times, with an estimated rate of one snowball per detector (FULL FRAME) per 20 seconds. To expand the number of pixels flagged as jumps around large cosmic ray events, set <code class="docutils literal notranslate"><span class="pre">expand_large_events</span></code> to True. An <code class="docutils literal notranslate"><span class="pre">expand_factor</span></code> of 3 works well for NIRSpec observations to cover most snowballs.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn on detection of cosmic ray snowballs (on by default).</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">][</span><span class="s1">&#39;expand_large_events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">][</span><span class="s1">&#39;expand_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># (default 2)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-info">
<p>JWST detector readout electronics (a.k.a. SIDECAR ASICs) generate significant 1/f noise during detector operations and signal digitization. This noise manifests as faint banding along the detector’s slow axis and varies from column to column. For NIRSpec data, the primary pipeline algorithm to address 1/f noise is <code class="docutils literal notranslate"><span class="pre">nsclean</span></code> in the <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> (Rauscher 2023) but is off by default.</p>
<p>An additional 1/f noise-cleaning algorithm, <code class="docutils literal notranslate"><span class="pre">clean_flicker_noise</span></code>, has been implemented at the group stage in the <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code>. This step is also off by default.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn on 1/f noise correction in Stage 1? (off by default).</span>
<span class="c1">#det1dict[&#39;clean_flicker_noise&#39;][&#39;skip&#39;] = False</span>
<span class="c1">#det1dict[&#39;clean_flicker_noise&#39;][&#39;fit_method&#39;] = &#39;fft&#39;</span>
<span class="c1">#det1dict[&#39;clean_flicker_noise&#39;][&#39;background_method&#39;] = None</span>
<span class="c1">#det1dict[&#39;clean_flicker_noise&#39;][&#39;mask_science_regions&#39;] = False</span>
<span class="c1">#det1dict[&#39;clean_flicker_noise&#39;][&#39;n_sigma&#39;] = False</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="run-detector1pipeline">
<h3>5.2 Run <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code><a class="headerlink" href="#run-detector1pipeline" title="Permalink to this heading">#</a></h3>
<p>Run the science files, nods, and, if available, any dedicated background files through the <code class="docutils literal notranslate"><span class="pre">calwebb_detector1</span></code> pipeline using the <code class="docutils literal notranslate"><span class="pre">.call()</span></code> method.</p>
<p>We use <code class="docutils literal notranslate"><span class="pre">.call()</span></code> instead of <code class="docutils literal notranslate"><span class="pre">.run()</span></code> to ensure that the latest default parameters defined via reference files in CRDS, are applied (<a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/stpipe/call_via_run.html">ReadtheDocs</a>).</p>
<p>This stage takes approximately 2 minutes to process six <code class="docutils literal notranslate"><span class="pre">_uncal.fits</span></code> files from the demo data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Final list of UNCAL files ready for Stage 1 processing.</span>
<span class="n">uncal_sci</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">uncal_dir</span> <span class="o">+</span> <span class="s1">&#39;*uncal.fits&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Science UNCAL Files:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uncal_sci</span><span class="p">))</span>

<span class="k">if</span> <span class="n">bg_dir</span><span class="p">:</span>
    <span class="n">uncal_bg</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">uncal_bgdir</span> <span class="o">+</span> <span class="s1">&#39;*uncal.fits&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Background UNCAL Files:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uncal_bg</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_det1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># Tracks runtime for Stage 1.</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<section id="calibrating-science-files">
<h4>5.2.1 Calibrating Science Files<a class="headerlink" href="#calibrating-science-files" title="Permalink to this heading">#</a></h4>
<p>Identify the input science files and execute the <code class="docutils literal notranslate"><span class="pre">calwebb_detector1</span></code> pipeline using the <code class="docutils literal notranslate"><span class="pre">call</span></code> method.</p>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Stage 1 pipeline on the science using the custom det1dict dictionary.</span>
<span class="k">if</span> <span class="n">dodet1</span><span class="p">:</span>

    <span class="c1">#--------------------------Science UNCAL files--------------------------</span>
    <span class="k">for</span> <span class="n">uncal_file</span> <span class="ow">in</span> <span class="n">uncal_sci</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying Stage 1 Corrections &amp; Calibrations to: &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">uncal_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">det1_result</span> <span class="o">=</span> <span class="n">Detector1Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">uncal_file</span><span class="p">,</span>
                                             <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">steps</span><span class="o">=</span><span class="n">det1dict</span><span class="p">,</span>
                                             <span class="n">output_dir</span><span class="o">=</span><span class="n">det1_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detector1 has been completed for SCI data! </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Detector1 processing for SCI data.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="calibrating-background-files">
<h4>5.2.2 Calibrating Background Files<a class="headerlink" href="#calibrating-background-files" title="Permalink to this heading">#</a></h4>
<p>Identify the input background files and execute the <code class="docutils literal notranslate"><span class="pre">calwebb_detector1</span></code> pipeline using the <code class="docutils literal notranslate"><span class="pre">call</span></code> method.</p>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Stage 1 pipeline on any background using the custom det1dict dictionary.</span>
<span class="k">if</span> <span class="n">dodet1bg</span><span class="p">:</span>

    <span class="c1">#------------------------Background UNCAL files-------------------------</span>
    <span class="k">for</span> <span class="n">uncal_file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">uncal_bgdir</span> <span class="o">+</span> <span class="s1">&#39;*uncal.fits&#39;</span><span class="p">)):</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying Stage 1 Corrections &amp; Calibrations to: &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">uncal_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">det1bg_result</span> <span class="o">=</span> <span class="n">Detector1Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">uncal_file</span><span class="p">,</span>
                                               <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">steps</span><span class="o">=</span><span class="n">det1dict</span><span class="p">,</span>
                                               <span class="n">output_dir</span><span class="o">=</span><span class="n">det1_bgdir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detector1 has been completed for BKG data! </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Detector1 processing for BKG data.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark.</span>
<span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">time2</span><span class="o">-</span><span class="n">time0</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for Stage 1: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">time2</span><span class="o">-</span><span class="n">time_det1</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Final list of RATE[INTS] files ready for Stage 2 processing.</span>
<span class="n">rate_sci</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">det1_dir</span> <span class="o">+</span> <span class="s1">&#39;*_rate.fits&#39;</span><span class="p">))</span>
<span class="n">rateints_sci</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">det1_dir</span> <span class="o">+</span> <span class="s1">&#39;*_rateints.fits&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SCIENCE | RATE[INTS] Files:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rate_sci</span> <span class="o">+</span> <span class="n">rateints_sci</span><span class="p">))</span>

<span class="k">if</span> <span class="n">bg_dir</span><span class="p">:</span>
    <span class="n">rate_bg</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">det1_bgdir</span> <span class="o">+</span> <span class="s1">&#39;*_rate.fits&#39;</span><span class="p">))</span>
    <span class="n">rateints_bg</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">det1_bgdir</span> <span class="o">+</span> <span class="s1">&#39;*_rateints.fits&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BACKGROUND | RATE[INTS] Files:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rate_bg</span> <span class="o">+</span> <span class="n">rateints_bg</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<hr class="docutils" />
<section id="stage-2-spec2pipeline-calwebb-spec2">
<h2>6. Stage 2: <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_spec2</span></code>)<a class="headerlink" href="#stage-2-spec2pipeline-calwebb-spec2" title="Permalink to this heading">#</a></h2>
<p>In this section, we process our countrate (slope) image products from Stage 1 (<code class="docutils literal notranslate"><span class="pre">calwebb_detector1</span></code>) through the Spec2 (<code class="docutils literal notranslate"><span class="pre">calwebb_spec2</span></code>) pipeline to create Stage 2 <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/science_products.html">data products</a>.</p>
<ul class="simple">
<li><p><strong>Input</strong>: A single countrate (slope) image (<code class="docutils literal notranslate"><span class="pre">_rate[ints].fits</span></code>) or an association file listing multiple inputs.</p></li>
<li><p><strong>Output</strong>: Calibrated products (rectified and unrectified) and 1D spectra.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">_cal[ints].fits</span></code>: Calibrated 2D (unrectified) spectra (ncols x nrows).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_s2d.fits</span></code>: Resampled (rectified) 2D spectra (ncols x nrows).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_x1d[ints].fits</span></code>: Extracted 1D spectroscopic data (wavelength vs. flux).</p></li>
</ul>
</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> applies additional instrumental corrections and calibrations (e.g., slit loss, path loss, etc.,) to countrate products that result in a fully calibrated individual exposure (per nod/dither position). The <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> also converts countrate products from units of DN/s to flux (Jy) for point sources and surface brightness (MJy/sr) for extended sources.</p>
<hr class="docutils" />
<section id="configure-spec2pipeline">
<h3>6.1 Configure <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code><a class="headerlink" href="#configure-spec2pipeline" title="Permalink to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> has the following steps available for NIRSpec FS:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">assign_wcs</span></code>: Assigns wavelength solution for spectra.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">badpix_selfcal</span></code>: Flags bad pixels in the input data using a self-calibration technique based on median filtering along the spectral axis.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nsclean</span></code>: Cleans 1/f noise.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bkg_subtract</span></code>: Performs image subtraction for background removal.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">extract_2d</span></code> : Extracts 2D arrays from spectral images.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">srctype</span></code>: Determines whether a spectroscopic source should be classified as a point or extended object.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wavecorr</span></code> : Updates wavelengths for FS and MOS point sources that are offset in the dispersion direction within their slit.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flat_field</span></code>: Applies flat-field corrections to the input science dataset.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pathloss</span></code>: Calculates and applies corrections for signal loss in spectroscopic data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">photom</span></code>: Applies photometric calibrations to convert data from countrate to surface brightness or flux density.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pixel_replace</span></code>: Interpolates and estimates flux values for pixels flagged as DO_NOT_USE in 2D extracted spectra.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resample_spec</span></code>: Resamples each input 2D spectral image using WCS and distortion information.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">extract_1d</span></code>: Extracts a 1D signal from 2D or 3D datasets.</p></li>
</ul>
<p>For more information about each step and a full list of step arguments, please refer to the official documentation: <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline-overview/stages-of-jwst-data-processing/calwebb_spec2">JDox</a> and
<a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_spec2.html">ReadtheDocs</a></p>
<p>Below, we set up a dictionary that defines how the <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> should be configured for FS data.</p>
<div class="alert alert-warning">
<p>If pixel-to-pixel background subtraction was chosen above, it will be applied during this stage.</br>
To override specific steps and reference files, use the examples below.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the Spec2 pipeline should be configured.</span>

<span class="c1"># -------------------------Boilerplate dictionary setup-------------------------</span>
<span class="n">spec2dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;assign_wcs&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;badpix_selfcal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;nsclean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;extract_2d&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;bkg_subtract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;srctype&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;wavecorr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;flat_field&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;pathloss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;photom&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;pixel_replace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;resample_spec&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;extract_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

<span class="c1"># ---------------------------Override reference files---------------------------</span>

<span class="c1"># Overrides for various reference files (example).</span>
<span class="c1"># Files should be in the base local directory or provide full path.</span>
<span class="c1">#spec2dict[&#39;extract_1d&#39;][&#39;override_extract1d&#39;] = &#39;myfile.json&#39;</span>

<span class="c1"># -----------------------------Set step parameters------------------------------</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped (example).</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;bkg_subtract&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">pixel_bg</span>  <span class="c1"># Runs if pixel-to-pixel bkg selected.</span>

<span class="c1"># Run pixel replacement code to extrapolate values for otherwise bad pixels.</span>
<span class="c1"># This can help mitigate 5-10% negative dips in spectra of bright sources.</span>
<span class="c1"># Use the &#39;fit_profile&#39; algorithm.</span>
<span class="c1">#spec2dict[&#39;pixel_replace&#39;][&#39;skip&#39;] = False</span>
<span class="c1">#spec2dict[&#39;pixel_replace&#39;][&#39;n_adjacent_cols&#39;] = 5</span>
<span class="c1">#spec2dict[&#39;pixel_replace&#39;][&#39;algorithm&#39;] = &#39;fit_profile&#39;</span>

<span class="c1"># Turn on bad pixel self-calibration, where all exposures on a given detector </span>
<span class="c1"># are used to find and flag bad pixels that may have been missed by the bad pixel mask.</span>
<span class="c1"># This step is experimental, and works best when dedicated background observations are included.</span>
<span class="c1">#spec2dict[&#39;badpix_selfcal&#39;][&#39;skip&#39;] = False</span>
<span class="c1">#spec2dict[&#39;badpix_selfcal&#39;][&#39;flagfrac_upper&#39;] = 0.005  # Fraction of pixels to flag.</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-info">
<p>Resampling 2D spectra can sometimes introduce artificial noise and reduce the signal-to-noise ratio (SNR) in the resulting 1D spectra when using <code class="docutils literal notranslate"><span class="pre">weight_type='ivm'</span></code> (<a class="reference external" href="https://jwst-docs.stsci.edu/known-issues-with-jwst-data/nirspec-known-issues/nirspec-fs-known-issues#NIRSpecFSKnownIssues-Resamplingof2-Dspectra:~:text=noise%20workaround%20notebook.-,Resampling%20of%202%2DD%20spectra,-Stages%202%20and">see known issues</a>). The default is now set to set weight type to ‘exptime’. Consider the following when selecting a <code class="docutils literal notranslate"><span class="pre">weight_type</span></code> parameter:</p>
<ul class="simple">
<li><p><strong>‘ivm’</strong>: Inverse variant scaling based on read noise (VAR_RNOISE), ideal for rejecting outliers and better suited for faint sources.</p></li>
<li><p><strong>‘exptime’</strong>: Uses exposure time for scaling, improving SNR for bright sources.</p></li>
</ul>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Resample weight_type.</span>
<span class="c1">#spec2dict[&#39;resample_spec&#39;][&#39;weight_type&#39;] = &#39;exptime&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-info">
<p>To correct for 1/f noise with <code class="docutils literal notranslate"><span class="pre">nsclean</span></code> in Stage 2, see the <strong>FS_NSClean_example</strong> demo notebook for FS data <a class="reference external" href="https://github.com/spacetelescope/jdat_notebooks/tree/main/notebooks/NIRSpec/NIRSpec_NSClean">here</a>.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run nsclean for 1/f noise.</span>
<span class="c1">#spec2dict[&#39;nsclean&#39;][&#39;skip&#39;] = False</span>
<span class="c1">#spec2dict[&#39;nsclean&#39;][&#39;n_sigma&#39;] = 2</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="create-spec2pipeline-association-files">
<h3>6.2 Create <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> Association Files<a class="headerlink" href="#create-spec2pipeline-association-files" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/stable/jwst/associations/overview.html">Association (ASN) files</a> define the relationships between multiple exposures, allowing them to get processed as a set rather than individually. Processing an ASN file enables the exposures to be calibrated, archived, retrieved, and reprocessed as a set rather than as individual objects.</p>
<p><a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/associations/level2_asn_technical.html">Stage 2 ASN files</a> for FS data can include <code class="docutils literal notranslate"><span class="pre">science</span></code>, <code class="docutils literal notranslate"><span class="pre">background</span></code>, and <code class="docutils literal notranslate"><span class="pre">selfcal</span></code> exposure types. A Stage 2 ASN file requires at least one <code class="docutils literal notranslate"><span class="pre">science</span></code> file but can contain multiple <code class="docutils literal notranslate"><span class="pre">background</span></code> and <code class="docutils literal notranslate"><span class="pre">selfcal</span></code> files that enable pixel-to-pixel background subtraction and bad pixel self-calibration in <code class="docutils literal notranslate"><span class="pre">calwebb_spec2</span></code>.</p>
<p>Here, we provide an example of manually creating Stage 2 ASN files.</p>
<div class="alert alert-block alert-warning">
<p>Background subtraction may not be correctly applied in Stage 2 if more than <em>one</em> <code class="docutils literal notranslate"><span class="pre">science</span></code> file is included in the association.</p>
<p>Additionally, pixel-to-pixel background subtraction will only be performed if the grating wheel has not moved between the target and off-scene associated background exposures. If the grating wheel moved between the target and background exposures (as would be the case if they were in different visits), pipeline processing will require a more involved “master background” subtraction done in Stage 3.</p>
</div><p>Association for nodded observations</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">asn_nod</span><span class="p">(</span><span class="n">asn</span><span class="p">,</span> <span class="n">onescifile</span><span class="p">,</span> <span class="n">sci</span><span class="p">,</span> <span class="n">sci_imprint</span><span class="p">,</span> <span class="n">nod_num</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Associate background, imprint, and selfcal exposures for nodded observations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    asn : dict</span>
<span class="sd">        The association dictionary to update.</span>
<span class="sd">    onescifile : str </span>
<span class="sd">        Path to the primary science file.</span>
<span class="sd">    sci : list of str</span>
<span class="sd">        List of science exposure file paths.</span>
<span class="sd">    sci_imprint : list of str</span>
<span class="sd">        List of science imprint exposure file paths.</span>
<span class="sd">    nod_num : int</span>
<span class="sd">        Position in dither pattern.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    asn : dict </span>
<span class="sd">        Updated association dictionary with members for applicable background, imprint, and selfcal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">members</span> <span class="o">=</span> <span class="n">asn</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">]</span>

    <span class="c1"># Assign background exposures.</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sci</span><span class="p">:</span>
        <span class="c1"># If dither position is different from the input position, use it as a background.</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;PATT_NUM&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;SUBPXPTS&#39;</span><span class="p">)))</span> <span class="o">!=</span> <span class="n">nod_num</span><span class="p">:</span>
            <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;background&#39;</span><span class="p">})</span>
    
    <span class="c1"># Assign imprint exposures (pipeline handles figuring out which one is best).</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sci_imprint</span><span class="p">:</span>
        <span class="c1"># Only IFU and MOS observations have imprint exposures.</span>
        <span class="k">if</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;EXP_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NRS_IFU&#39;</span> <span class="ow">or</span> <span class="s1">&#39;NRS_MSASPEC&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">match_gwa</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
                <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;imprint&#39;</span><span class="p">})</span>

    <span class="c1"># Assign selfcal exposures.</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sci</span> <span class="o">+</span> <span class="n">sci_imprint</span><span class="p">:</span>
        <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;selfcal&#39;</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">asn</span>
</pre></div>
</div>
</div>
</div>
<p>Define a function that associates background and selfcal exposures for dithered observations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">asn_dither</span><span class="p">(</span><span class="n">asn</span><span class="p">,</span> <span class="n">onescifile</span><span class="p">,</span> <span class="n">sci</span><span class="p">,</span> <span class="n">sci_imprint</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">bg_imprint</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Associate background, imprint, and selfcal exposures for dithered observations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    asn : dict</span>
<span class="sd">        The association dictionary to update.</span>
<span class="sd">    onescifile : str </span>
<span class="sd">        Path to the primary science file.</span>
<span class="sd">    sci : list of str</span>
<span class="sd">        List of science exposure file paths.</span>
<span class="sd">    sci_imprint : list of str</span>
<span class="sd">        List of science imprint exposure file paths.</span>
<span class="sd">    bg : list of str</span>
<span class="sd">        List of background exposure file paths.</span>
<span class="sd">    bg_imprint : list of str</span>
<span class="sd">        List of background imprint exposure file paths.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    asn : dict </span>
<span class="sd">        Updated association dictionary with members for applicable background, imprint, and selfcal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">members</span> <span class="o">=</span> <span class="n">asn</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">]</span>
    
    <span class="c1"># Assign background exposures.</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">bg</span><span class="p">:</span>
        <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;background&#39;</span><span class="p">})</span>

    <span class="c1"># Assign imprint exposures (pipeline handles figuring out which one is best).</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sci_imprint</span><span class="p">:</span>
        <span class="c1"># Only IFU and MOS observations have imprint exposures.</span>
        <span class="k">if</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;EXP_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NRS_IFU&#39;</span> <span class="ow">or</span> <span class="s1">&#39;NRS_MSASPEC&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">match_gwa</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
                <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;imprint&#39;</span><span class="p">})</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">bg_imprint</span><span class="p">:</span>
        <span class="c1"># Only IFU and MOS observations have imprint exposures.</span>
        <span class="k">if</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;EXP_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NRS_IFU&#39;</span> <span class="ow">or</span> <span class="s1">&#39;NRS_MSASPEC&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">match_gwa</span><span class="p">(</span><span class="n">bg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">file</span><span class="p">):</span>
                <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;imprint&#39;</span><span class="p">})</span>

    <span class="c1"># Assign selfcal exposures.</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sci</span> <span class="o">+</span> <span class="n">sci_imprint</span> <span class="o">+</span> <span class="n">bg</span> <span class="o">+</span> <span class="n">bg_imprint</span><span class="p">:</span>
        <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;selfcal&#39;</span><span class="p">})</span>
    
    <span class="k">return</span> <span class="n">asn</span>
</pre></div>
</div>
</div>
</div>
<p>Function to write the association file</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">writel2asn</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="n">allscifiles</span><span class="p">,</span> <span class="n">bgfiles</span><span class="p">,</span> <span class="n">asnfile</span><span class="p">,</span> <span class="n">product_name</span><span class="p">,</span> <span class="n">exp_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Level 2 association file for each science exposure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    onescifile : str</span>
<span class="sd">        Path to the primary science exposure file.</span>
<span class="sd">    allscifiles : list of str</span>
<span class="sd">        List of all science exposure files.</span>
<span class="sd">    bgfiles : list of str</span>
<span class="sd">        List of background exposure files.</span>
<span class="sd">    asnfile : str</span>
<span class="sd">        Path to write the output association file.</span>
<span class="sd">    product_name : str</span>
<span class="sd">        Name of the product for the association.</span>
<span class="sd">    exp_type : str, optional</span>
<span class="sd">        Exposure type to match against.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    True if the association was written successfully, and False otherwise </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define a basic association with the science file.</span>
    <span class="c1"># Wrap in array since input was single exposure.</span>
    <span class="n">asn</span> <span class="o">=</span> <span class="n">afl</span><span class="o">.</span><span class="n">asn_from_list</span><span class="p">([</span><span class="n">onescifile</span><span class="p">],</span> <span class="n">rule</span><span class="o">=</span><span class="n">DMSLevel2bBase</span><span class="p">,</span> <span class="n">product_name</span><span class="o">=</span><span class="n">product_name</span><span class="p">)</span>
    <span class="n">asn</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;program&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">program</span> <span class="k">if</span> <span class="s1">&#39;program&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;9999&quot;</span>

    <span class="c1"># Grab header information from the science file.</span>
    <span class="n">exp_type</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="s1">&#39;EXP_TYPE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">exp_type</span> <span class="o">==</span> <span class="n">exp_type</span><span class="p">):</span>
        <span class="n">detector</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="s1">&#39;DETECTOR&#39;</span><span class="p">)</span>
        <span class="n">grating</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="s1">&#39;GRATING&#39;</span><span class="p">)</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="s1">&#39;FILTER&#39;</span><span class="p">)</span>
        <span class="n">fxd_slit</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="s1">&#39;FXD_SLIT&#39;</span><span class="p">)</span>
        <span class="n">patttype</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="s1">&#39;PATTTYPE&#39;</span><span class="p">)</span>  <span class="c1"># Dither pattern type.</span>
        <span class="n">pattnum</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="s1">&#39;PATT_NUM&#39;</span><span class="p">)</span>  <span class="c1"># Dither pattern number.</span>
        <span class="c1"># primary_dithpts = fits.getval(onescifile, &#39;PRIDTPTS&#39;)  # Points in primary dither pattern.</span>
        <span class="n">subpxpts</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="s1">&#39;SUBPXPTS&#39;</span><span class="p">)</span>  <span class="c1"># Points in subpixel dither pattern.</span>
        <span class="c1"># Position number within primary dither pattern.</span>
        <span class="n">nod_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">pattnum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">subpxpts</span><span class="p">)</span>

    <span class="c1"># If the exposure type does not match, fail out </span>
    <span class="c1"># to ensure TA images don&#39;t get processed by accident.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Find all files matching the input configuration and split into regular/imprint.</span>
    <span class="n">use_sci</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_matching</span><span class="p">(</span><span class="n">allscifiles</span><span class="p">,</span> <span class="n">detector</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">grating</span><span class="p">,</span> <span class="n">fxd_slit</span><span class="p">,</span> <span class="n">exp_type</span><span class="p">)</span>
    <span class="n">use_bg</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_matching</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">,</span> <span class="n">detector</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">grating</span><span class="p">,</span> <span class="n">fxd_slit</span><span class="p">,</span> <span class="n">exp_type</span><span class="p">)</span> <span class="k">if</span> <span class="n">bgfiles</span> <span class="k">else</span> <span class="p">([],</span> <span class="p">[])</span>

    <span class="c1"># If this uses nodded exposures set up pixel-based background subtraction accordingly.</span>
    <span class="n">is_nod</span> <span class="o">=</span> <span class="s1">&#39;NOD&#39;</span> <span class="ow">in</span> <span class="n">patttype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_nod</span><span class="p">:</span>
        <span class="n">asn</span> <span class="o">=</span> <span class="n">asn_nod</span><span class="p">(</span><span class="n">asn</span><span class="p">,</span> <span class="n">onescifile</span><span class="p">,</span> <span class="n">use_sci</span><span class="p">,</span> <span class="p">[],</span> <span class="n">nod_num</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise handle as dithered exposures.</span>
        <span class="n">asn</span> <span class="o">=</span> <span class="n">asn_dither</span><span class="p">(</span><span class="n">asn</span><span class="p">,</span> <span class="n">onescifile</span><span class="p">,</span> <span class="n">use_sci</span><span class="p">,</span> <span class="p">[],</span> <span class="n">use_bg</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># Write the association to a json file.</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">serialized</span> <span class="o">=</span> <span class="n">asn</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---------------------Sort science and background files---------------------</span>
<span class="c1"># &#39;rate_sci&#39; includes files marked as science targets.</span>
<span class="c1"># &#39;rate_bg&#39; includes files marked as backgrounds in the science observation</span>
<span class="c1"># or dedicated background observations.</span>
<span class="n">rate_sci</span> <span class="o">=</span> <span class="n">filter_list</span><span class="p">(</span><span class="n">rate_sci</span><span class="p">,</span> <span class="s1">&#39;BKGDTARG&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
<span class="n">rate_bg</span> <span class="o">=</span> <span class="n">filter_list</span><span class="p">(</span><span class="n">rate_sci</span><span class="p">,</span> <span class="s1">&#39;BKGDTARG&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rate_bg</span> <span class="k">if</span> <span class="n">bg_dir</span> <span class="k">else</span> <span class="p">[])</span>

<span class="c1"># Special case for FS S1600A1 with a 5-POINT-NOD.</span>
<span class="c1"># Exclude the top and bottom dithers [1, 5] that are close to slit edges.</span>
<span class="n">excluded_files</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">rate_sci</span> <span class="o">+</span> <span class="n">rate_bg</span>
    <span class="c1"># Considering number of points in primary dither pattern and</span>
    <span class="c1"># Position number within primary dither pattern.</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">header</span> <span class="o">:=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FXD_SLIT&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;S1600A1&#39;</span> <span class="ow">and</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PRIDTPTS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATT_NUM&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SUBPXPTS&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Filter excluded files from both lists.</span>
<span class="n">rate_sci</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">rate_sci</span> <span class="k">if</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_files</span><span class="p">]</span>
<span class="n">rate_bg</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">rate_bg</span> <span class="k">if</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_files</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="run-spec2pipeline">
<h3>6.3 Run <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code><a class="headerlink" href="#run-spec2pipeline" title="Permalink to this heading">#</a></h3>
<p>Run the science files, associated nods and, if available, any background files through the <code class="docutils literal notranslate"><span class="pre">calwebb_spec2</span></code> pipeline using the <code class="docutils literal notranslate"><span class="pre">.call()</span></code> method.</p>
<div class="alert alert-block alert-warning">
Perform pixel-to-pixel background subtraction (if desired) here in Stage 2. Otherwise, reduce the backgrounds individually for master background subtraction in Stage 3 (if desired).
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_spec2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<section id="id1">
<h4>6.3.1 Calibrating Science Files<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h4>
<p>Identify the Stage 2 ASN files and execute the <code class="docutils literal notranslate"><span class="pre">calwebb_spec2</span></code> pipeline using the <code class="docutils literal notranslate"><span class="pre">call</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To save on runtime turns off creation of quicklook 2d/1d spectra for science data.</span>
<span class="c1"># Any master background subtraction in spec3 will require the 1d spectra from spec2.</span>
<span class="c1">#spec2dict[&#39;resample_spec&#39;][&#39;skip&#39;] = True  # S2D products.</span>
<span class="c1">#spec2dict[&#39;extract_1d&#39;][&#39;skip&#39;] = True  # X1D products.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Stage 2 pipeline using the custom spec2dict dictionary.</span>
<span class="k">if</span> <span class="n">dospec2</span><span class="p">:</span>

    <span class="c1"># --------------------------Science files--------------------------</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">rate_sci</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Create ASN files.</span>
            <span class="n">asnfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asn_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;rate.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;l2asn.json&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">writel2asn</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">rate_sci</span><span class="p">,</span> <span class="n">rate_bg</span><span class="p">,</span> <span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;Level2&#39;</span><span class="p">,</span> <span class="s1">&#39;NRS_FIXEDSLIT&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying Stage 2 Corrections &amp; Calibrations to: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">spec2sci_result</span> <span class="o">=</span> <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span>
                                                     <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">steps</span><span class="o">=</span><span class="n">spec2dict</span><span class="p">,</span>
                                                     <span class="n">output_dir</span><span class="o">=</span><span class="n">spec2_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># A handle for when no slits fall on NRS2.</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped processing </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">asnfile</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spec2 has been completed for SCI data! </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Spec2 processing for SCI data.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id2">
<h4>6.3.2 Calibrating Background Files<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h4>
<p>Prepare background files for master background subtraction in Stage 3.</p>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Stage 2 pipeline using the custom spec2dict dictionary.</span>
<span class="c1"># Process dedicated background data to use in the master background step.</span>
<span class="k">if</span> <span class="n">dospec2bg</span> <span class="ow">and</span> <span class="n">master_bg</span><span class="p">:</span>

    <span class="c1"># ------------------------Background RATE files------------------------</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">rate_bg</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Create ASN files.</span>
            <span class="n">asnfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asn_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;rate.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;l2asn.json&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">writel2asn</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">rate_bg</span><span class="p">,</span> <span class="p">[],</span> <span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;Level2&#39;</span><span class="p">,</span> <span class="s1">&#39;NRS_FIXEDSLIT&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying Stage 2 Corrections &amp; Calibrations to: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">spec2sci_result</span> <span class="o">=</span> <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span>
                                                     <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">steps</span><span class="o">=</span><span class="n">spec2dict</span><span class="p">,</span>
                                                     <span class="n">output_dir</span><span class="o">=</span><span class="n">spec2_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># A handle for when no slices fall on NRS2.</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped processing </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">asnfile</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spec2 has been completed for BKG data! </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping Spec2 for BKG data. </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmarks.</span>
<span class="n">time3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">time3</span><span class="o">-</span><span class="n">time0</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for Spec2: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">time3</span><span class="o">-</span><span class="n">time_spec2</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List the Stage 2 products.</span>

<span class="c1"># -----------------------------Science files-----------------------------</span>
<span class="n">sci_cal</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec2_dir</span> <span class="o">+</span> <span class="s1">&#39;*_cal.fits&#39;</span><span class="p">))</span>
<span class="n">sci_s2d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec2_dir</span> <span class="o">+</span> <span class="s1">&#39;*_s2d.fits&#39;</span><span class="p">))</span>
<span class="n">sci_x1d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec2_dir</span> <span class="o">+</span> <span class="s1">&#39;*_x1d.fits&#39;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SCIENCE | Stage 2 CAL Products:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_cal</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SCIENCE | Stage 2 S2D Products:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_s2d</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SCIENCE | Stage 2 X1D Products:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_x1d</span><span class="p">))</span>

<span class="k">if</span> <span class="n">dospec2bg</span><span class="p">:</span>
    <span class="c1"># ----------------------------Background files---------------------------</span>
    <span class="n">bg_cal</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec2_bgdir</span> <span class="o">+</span> <span class="s1">&#39;*_cal.fits&#39;</span><span class="p">))</span>
    <span class="n">bg_s2d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec2_bgdir</span> <span class="o">+</span> <span class="s1">&#39;*_s2d.fits&#39;</span><span class="p">))</span>
    <span class="n">bg_x1d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec2_bgdir</span> <span class="o">+</span> <span class="s1">&#39;*_x1d.fits&#39;</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BACKGROUND | Stage 2 CAL Products:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_cal</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BACKGROUND | Stage 2 S2D Products:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_s2d</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BACKGROUND | Stage 2 X1D Products:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_x1d</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<hr class="docutils" />
<section id="stage-3-spec3pipeline-calwebb-spec3">
<h2>7. Stage 3: <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_spec3</span></code>)<a class="headerlink" href="#stage-3-spec3pipeline-calwebb-spec3" title="Permalink to this heading">#</a></h2>
<p>In this section, we process our calibrated spectra from Stage 2 (<code class="docutils literal notranslate"><span class="pre">calwebb_spec2</span></code>) through the Spec3 (<code class="docutils literal notranslate"><span class="pre">calwebb_spec3</span></code>) pipeline to create Stage 3 <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/science_products.html">data products</a>.</p>
<ul class="simple">
<li><p><strong>Input</strong>: An ASN file that lists multiple calibrated exposures (<code class="docutils literal notranslate"><span class="pre">_cal.fits</span></code>) in addition to any background exposures (<code class="docutils literal notranslate"><span class="pre">_x1d.fits</span></code>).</p></li>
<li><p><strong>Output</strong>: A single calibrated product (rectified and unrectified) and 1D spectrum. These data products have units of MJy/sr (or Jy for extracted point-source spectra).</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">_cal.fits</span></code>: Calibrated 2D (unrectified) spectra (ncols x nrows).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_crf.fits</span></code>: Calibrated 2D (unrectified) spectra whose DQ array has been updated to flag pixels detected as outliers (ncols x nrows).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_s2d.fits</span></code>: Resampled (rectified) 2D spectra (ncols x nrows).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_x1d.fits</span></code>: Extracted 1D spectroscopic data.</p></li>
</ul>
</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> performs additional corrections (e.g., outlier detection, background subtraction) and combines calibrated data from multiple exposures (e.g. a dither/nod pattern) into a single 2D spectral product, as well as a combined 1D spectrum.</p>
<hr class="docutils" />
<section id="configure-spec3pipeline">
<h3>7.1 Configure <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code><a class="headerlink" href="#configure-spec3pipeline" title="Permalink to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> has the following steps available for NIRSpec FS:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">assign_mtwcs</span></code>: Modifies the WCS output frame in each exposure of a Moving Target (MT) observation association.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">master_background</span></code>: Master background subtraction.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">outlier_detection</span></code> : Identification of bad pixels or cosmic-rays that remain in each of the input images.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pixel_replace</span></code>: Interpolates and estimates flux values for pixels flagged as DO_NOT_USE in 2D extracted spectra.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resample_spec</span></code>: Resamples each input 2D spectral image using WCS and distortion information.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">extract_1d</span></code>: Extracts a 1D signal from 2D or 3D datasets</p></li>
</ul>
</div></blockquote>
<p>For more information about each step and a full list of step arguments, please refer to the official documentation: <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline-overview/stages-of-jwst-data-processing/calwebb_spec3">JDox</a> and
<a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_spec3.html">ReadtheDocs</a></p>
<p>Below, we set up a dictionary that defines how the <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> should be configured for FS data.</p>
<div class="alert alert-warning">
<p>If master background subtraction was chosen above, it will be applied during this stage.</br>
To override specific steps and reference files, use the examples below.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the Spec3 pipeline should be configured.</span>

<span class="c1"># -------------------------Boilerplate dictionary setup-------------------------</span>
<span class="n">spec3dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;assign_mtwcs&#39;</span><span class="p">],</span> <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;master_background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;outlier_detection&#39;</span><span class="p">],</span> <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;pixel_replace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;resample_spec&#39;</span><span class="p">],</span> <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;extract_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

<span class="c1"># ---------------------------Override reference files---------------------------</span>
<span class="c1"># Overrides for various reference files.</span>
<span class="c1"># Files should be in the base local directory or provide full path.</span>
<span class="c1">#spec3dict[&#39;extract_1d&#39;][&#39;override_extract1d&#39;] = &#39;myfile.json&#39;</span>

<span class="c1"># -----------------------------Set step parameters------------------------------</span>
<span class="c1"># Overrides for whether or not certain steps should be skipped (example).</span>
<span class="c1">#spec3dict[&#39;outlier_detection&#39;][&#39;skip&#39;] = True</span>

<span class="c1"># Master background usage was set up above, propagate that here.</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;master_background&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">master_bg</span>

<span class="c1"># Run pixel replacement code to extrapolate values for otherwise bad pixels.</span>
<span class="c1"># This can help mitigate 5-10% negative dips in spectra of bright sources.</span>
<span class="c1"># Use the &#39;fit_profile&#39; algorithm.</span>
<span class="c1">#spec3dict[&#39;pixel_replace&#39;][&#39;skip&#39;] = False</span>
<span class="c1">#spec3dict[&#39;pixel_replace&#39;][&#39;n_adjacent_cols&#39;] = 5</span>
<span class="c1">#spec3dict[&#39;pixel_replace&#39;][&#39;algorithm&#39;] = &#39;fit_profile&#39;</span>

<span class="c1"># Resample weight_type.</span>
<span class="c1">#spec3dict[&#39;resample_spec&#39;][&#39;weight_type&#39;] = &#39;exptime&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="create-spec3pipeline-association-files">
<h3>7.2 Create <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> Association Files<a class="headerlink" href="#create-spec3pipeline-association-files" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/associations/level3_asn_technical.html">Stage 3 ASN files</a> for FS data can include <code class="docutils literal notranslate"><span class="pre">science</span></code> and <code class="docutils literal notranslate"><span class="pre">background</span></code> exposure types. A Stage 3 ASN file requires at least one <code class="docutils literal notranslate"><span class="pre">science</span></code> file (there is usually more than one) but can contain multiple <code class="docutils literal notranslate"><span class="pre">background</span></code> files that enable master background subtraction in <code class="docutils literal notranslate"><span class="pre">calwebb_spec3</span></code>. <strong>Note that the science exposures should be in the <code class="docutils literal notranslate"><span class="pre">_cal.fits</span></code> format, while the background exposures must be in the <code class="docutils literal notranslate"><span class="pre">_x1d.fits</span></code> format.</strong></p>
<p>In practice, Stage 3 ASN files can be downloaded directly from MAST, however, here we provide an example of manually creating Stage 3 ASN files. Below we create an ASN files for each GRATING/FILTER combination.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">writel3asn</span><span class="p">(</span><span class="n">scifiles</span><span class="p">,</span> <span class="n">bgfiles</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Level 3 association file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scifiles : list of str</span>
<span class="sd">        List of all science exposure files.</span>
<span class="sd">    bgfiles : list of str</span>
<span class="sd">        List of background exposure files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Filter based on GRATING/FILTER.</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sci&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;bg&#39;</span><span class="p">:</span> <span class="p">[]})</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">scifiles</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;FILTER&#39;</span><span class="p">),</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;GRATING&#39;</span><span class="p">),</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;FXD_SLIT&#39;</span><span class="p">))</span>
        <span class="n">grouped</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;sci&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">bgfiles</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;FILTER&#39;</span><span class="p">),</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;GRATING&#39;</span><span class="p">),</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;FXD_SLIT&#39;</span><span class="p">))</span>
        <span class="n">grouped</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;bg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Make ASN for each FILTER/GRATING.</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">grat</span><span class="p">,</span> <span class="n">slit</span><span class="p">),</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">grouped</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slit</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">grat</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">asnfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asn_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_l3asn.json&quot;</span><span class="p">)</span>
        <span class="n">asn</span> <span class="o">=</span> <span class="n">afl</span><span class="o">.</span><span class="n">asn_from_list</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;sci&#39;</span><span class="p">],</span> <span class="n">rule</span><span class="o">=</span><span class="n">DMS_Level3_Base</span><span class="p">,</span> <span class="n">product_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bg</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;bg&#39;</span><span class="p">]:</span>
            <span class="n">asn</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">bg</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;background&#39;</span><span class="p">})</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">asn</span><span class="o">.</span><span class="n">dump</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Level 3 ASN creation complete!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dospec3</span><span class="p">:</span>
    <span class="n">writel3asn</span><span class="p">(</span><span class="n">sci_cal</span><span class="p">,</span> <span class="n">bg_x1d</span> <span class="k">if</span> <span class="n">bg_dir</span> <span class="k">else</span> <span class="p">[])</span>

<span class="c1"># Get list of all spec3 ASN files.</span>
<span class="n">spec3_asn</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asn_dir</span><span class="si">}</span><span class="s2">*l3asn.json&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage 3 ASN Files:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spec3_asn</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open an ASN file as an example.</span>
<span class="c1"># Check that file paths have been correctly updated.</span>
<span class="k">if</span> <span class="n">dospec3</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">spec3_asn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_obj</span><span class="p">:</span>
        <span class="n">asnfile_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f_obj</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">JSON</span><span class="p">(</span><span class="n">asnfile_data</span><span class="p">,</span> <span class="n">expanded</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="run-spec3pipeline">
<h3>7.3 Run <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code><a class="headerlink" href="#run-spec3pipeline" title="Permalink to this heading">#</a></h3>
<p>Run the science files and, if available, any background files through the <code class="docutils literal notranslate"><span class="pre">calwebb_spec3</span></code> pipeline using the <code class="docutils literal notranslate"><span class="pre">.call()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_spec3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Stage 3 pipeline using the custom spec3dict dictionary.</span>
<span class="k">if</span> <span class="n">dospec3</span><span class="p">:</span>

    <span class="c1"># --------------------------Spec3 ASN files--------------------------</span>
    <span class="k">for</span> <span class="n">s3_asn</span> <span class="ow">in</span> <span class="n">spec3_asn</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying Stage 3 Corrections &amp; Calibrations to: &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">s3_asn</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">spec3_result</span> <span class="o">=</span> <span class="n">Spec3Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">s3_asn</span><span class="p">,</span>
                                          <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">steps</span><span class="o">=</span><span class="n">spec3dict</span><span class="p">,</span>
                                          <span class="n">output_dir</span><span class="o">=</span><span class="n">spec3_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spec3 has been completed! </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping Spec3. </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmarks.</span>
<span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">time4</span><span class="o">-</span><span class="n">time0</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for Spec3: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">time4</span><span class="o">-</span><span class="n">time_spec3</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List the Stage 3 products.</span>
<span class="n">stage3_cal</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec3_dir</span> <span class="o">+</span> <span class="s1">&#39;*_cal.fits&#39;</span><span class="p">))</span>
<span class="n">stage3_s2d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec3_dir</span> <span class="o">+</span> <span class="s1">&#39;*_s2d.fits&#39;</span><span class="p">))</span>
<span class="n">stage3_x1d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec3_dir</span> <span class="o">+</span> <span class="s1">&#39;*_x1d.fits&#39;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage 3 CAL Products:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stage3_cal</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage 3 S3D Products:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stage3_s2d</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage 3 X1D Products:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stage3_x1d</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="visualize-the-data">
<h2>8. Visualize the Data<a class="headerlink" href="#visualize-the-data" title="Permalink to this heading">#</a></h2>
<p>Define convenience funcitons for visualization. For some plots we utilize <a class="reference external" href="https://jdaviz.readthedocs.io/en/stable/index.html"><code class="docutils literal notranslate"><span class="pre">jdaviz</span></code></a>, a package of astronomical data analysis visualization tools designed to work in Jupyter notebooks.</p>
<p>Define a function to display Stage 1 products.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to display the rate files produced by Stage 1 in the</span>
<span class="c1"># JWST Calibration Pipeline.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">display_rate</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span>
                 <span class="n">slits_models</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">integration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">extname</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                 <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                 <span class="n">bad_color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
                 <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;asinh&#39;</span><span class="p">,</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                 <span class="n">title_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">title_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display countrate images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rates : list of str</span>
<span class="sd">        A list of RATE[INTS] files to be displayed.</span>
<span class="sd">    slits_models : list of str, optional</span>
<span class="sd">        A list of CAL[INTS] or S2D files containing the slit models.</span>
<span class="sd">        If provided, slit cutouts will be overlaid on the countrate images.</span>
<span class="sd">    integration : {None, &#39;min&#39;, int}, optional</span>
<span class="sd">        Specifies the integration to use for multi-integration data.</span>
<span class="sd">        If &#39;min&#39;, the minimum value across all integrations is used.</span>
<span class="sd">        If an integer, the specific integration index is used (default 0).</span>
<span class="sd">    extname : str, optional</span>
<span class="sd">        The name of the data extension to extract from (&#39;data&#39;, &#39;dq&#39;, etc.).</span>
<span class="sd">    cmap : str, optional</span>
<span class="sd">        Colormap to use for displaying the image. Default is &#39;viridis&#39;.</span>
<span class="sd">    bad_color : tuple of float, optional</span>
<span class="sd">        Color to use for NaN pixels. Default is light red (1, 0.7, 0.7).</span>
<span class="sd">    vmin : float, optional</span>
<span class="sd">        Minimum value for color scaling. If None, determined from the data.</span>
<span class="sd">    vmax : float, optional</span>
<span class="sd">        Maximum value for color scaling. If None, determined from the data.</span>
<span class="sd">    scale : {&#39;linear&#39;, &#39;log&#39;, &#39;asinh&#39;}, optional</span>
<span class="sd">        Scale to use for the image normalization. Default is &#39;asinh&#39;.</span>
<span class="sd">    aspect : str, optional</span>
<span class="sd">        Aspect ratio of the plot. Default is &#39;auto&#39;.</span>
<span class="sd">    title_prefix : str, optional</span>
<span class="sd">        Optional prefix for the plot title.</span>
<span class="sd">    title_path : bool, optional</span>
<span class="sd">        If True, uses the full file path for the title;</span>
<span class="sd">        otherwise, uses the basename. Default is False.</span>
<span class="sd">    save_plot : bool, optional</span>
<span class="sd">        If True, saves the plot as a PNG file. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -------------------------------Check Inputs-------------------------------</span>
    <span class="n">rates</span> <span class="o">=</span> <span class="p">[</span><span class="n">rates</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">rates</span>
    <span class="n">slits_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">slits_models</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slits_models</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">slits_models</span>
    <span class="n">nrates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span>

    <span class="c1"># ------------------------------Set up figures------------------------------</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrates</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">nrates</span><span class="p">),</span>
                             <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrates</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span> <span class="k">if</span> <span class="n">nrates</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axes</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>  <span class="c1"># Set up colormap and bad pixel color.</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">bad_color</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># ---------------------------Plot countrate image---------------------------</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">cal</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span>
                                                          <span class="n">slits_models</span><span class="p">,</span>
                                                          <span class="n">fillvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">)):</span>

        <span class="c1"># -------------------Open files as JWST datamodels-------------------</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
        <span class="n">slits_model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span> <span class="k">if</span> <span class="n">cal</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># -----------------------Extract the 2D/3D data----------------------</span>
        <span class="n">data_2d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">extname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_2d</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Handle multi-integration data.</span>
            <span class="k">if</span> <span class="n">integration</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                <span class="n">data_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data_2d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">integration</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">integration</span> <span class="o">&lt;</span> <span class="n">data_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">data_2d</span> <span class="o">=</span> <span class="n">data_2d</span><span class="p">[</span><span class="n">integration</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid integration &#39;</span><span class="si">{</span><span class="n">integration</span><span class="si">}</span><span class="s2">&#39; for 3D data.&quot;</span><span class="p">)</span>

        <span class="c1"># ---------------------------Scale the data-------------------------</span>
        <span class="n">sigma_clipped_data</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">data_2d</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vmin</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vmax</span>
        <span class="n">stretch_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="n">LogStretch</span><span class="p">(),</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="n">LinearStretch</span><span class="p">(),</span>
                       <span class="s1">&#39;asinh&#39;</span><span class="p">:</span> <span class="n">AsinhStretch</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">stretch_map</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">,</span>
                                  <span class="n">interval</span><span class="o">=</span><span class="n">ManualInterval</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span>
                                  <span class="n">stretch</span><span class="o">=</span><span class="n">stretch_map</span><span class="p">[</span><span class="n">scale</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

        <span class="c1"># ----------------Plot the countrate image &amp; colorbar---------------</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_2d</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                            <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">bunit_data</span>
        <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x1</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span>
                                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span>
                                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="c1"># -----------------Draw slits and label source ids------------------</span>
        <span class="c1"># slits_model can be s2d/cal from spec2 - contains slit models for all sources.</span>
        <span class="k">if</span> <span class="n">slits_model</span><span class="p">:</span>
            <span class="n">slit_patches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">slit</span> <span class="ow">in</span> <span class="n">slits_model</span><span class="o">.</span><span class="n">slits</span><span class="p">:</span>
                <span class="n">slit_patch</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">slit</span><span class="o">.</span><span class="n">xstart</span><span class="p">,</span> <span class="n">slit</span><span class="o">.</span><span class="n">ystart</span><span class="p">),</span>
                                       <span class="n">slit</span><span class="o">.</span><span class="n">xsize</span><span class="p">,</span> <span class="n">slit</span><span class="o">.</span><span class="n">ysize</span><span class="p">)</span>
                <span class="n">slit_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slit_patch</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">slit</span><span class="o">.</span><span class="n">ystart</span> <span class="o">+</span> <span class="n">slit</span><span class="o">.</span><span class="n">ysize</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">slit</span><span class="o">.</span><span class="n">xstart</span> <span class="k">if</span> <span class="s1">&#39;nrs1&#39;</span> <span class="ow">in</span> <span class="n">rate</span> <span class="k">else</span> <span class="n">slit</span><span class="o">.</span><span class="n">xstart</span> <span class="o">+</span> <span class="n">slit</span><span class="o">.</span><span class="n">xsize</span>
                <span class="n">ha</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span> <span class="k">if</span> <span class="s1">&#39;nrs1&#39;</span> <span class="ow">in</span> <span class="n">rate</span> <span class="k">else</span> <span class="s1">&#39;left&#39;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">slit</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">ha</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                         <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">path_effects</span><span class="o">=</span><span class="p">[],</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">PatchCollection</span><span class="p">(</span><span class="n">slit_patches</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">))</span>

        <span class="c1"># -----------------Construct title and axis labels------------------</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title_prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">title_prefix</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">title_path</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">integration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;rateints&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;rateints[</span><span class="si">{</span><span class="n">integration</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Column&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Pixel Row&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="c1"># -------------------------Save the figure?-------------------------</span>
        <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
            <span class="n">save_plot</span> <span class="o">=</span> <span class="n">rate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">integration</span><span class="p">:</span>
                <span class="n">save_plot</span> <span class="o">=</span> <span class="n">save_plot</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">integration</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to display the spectra generated in stage 2/3 of the</span>
<span class="c1"># JWST Calibration Pipeline.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">display_spectra</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span>
                    <span class="n">compare_x1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">compare_mast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">integration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">extname</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">source_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">source_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">expand_wavelength_gap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">plot_resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">plot_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                    <span class="n">bad_color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;asinh&#39;</span><span class="p">,</span>
                    <span class="n">title_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">title_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">y_limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">is_stage3</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display 2D and 1D spectra (Stage 2/3).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectra : list of str</span>
<span class="sd">        A list of data products (e.g., CAL, S2D, X1D files).</span>
<span class="sd">    compare_x1d : list of str, optional</span>
<span class="sd">        A list of 1D spectra for comparison (X1D files).</span>
<span class="sd">    compare_mast : list of str, optional</span>
<span class="sd">        A list of 1D spectra from MAST for comparison (X1D files).</span>
<span class="sd">    integration : {None, &#39;min&#39;, int}, optional</span>
<span class="sd">        Specifies the integration to use for multi-integration data.</span>
<span class="sd">        If &#39;min&#39;, the minimum value across all integrations is used.</span>
<span class="sd">        If an integer, the specific integration index is used (default 0).</span>
<span class="sd">     extname : str, optional</span>
<span class="sd">        The name of the data extension to extract (&#39;data&#39;, &#39;dq&#39;, etc.).</span>
<span class="sd">    source_id : int or str, optional</span>
<span class="sd">        Identifier for the source/slit to be displayed. Default is 1.</span>
<span class="sd">    source_type : str, optional</span>
<span class="sd">        Override data source type (&#39;POINT&#39; or &#39;EXTENDED&#39;).</span>
<span class="sd">    expand_wavelength_gap : bool, optional</span>
<span class="sd">        If True, expands gaps in the wavelength data for better visualization.</span>
<span class="sd">    plot_resample : bool, optional</span>
<span class="sd">        If True, plots resampled (S2D) data products;</span>
<span class="sd">        otherwise, plots calibrated (CAL) data. Default is True.</span>
<span class="sd">    plot_errors : bool, optional</span>
<span class="sd">        If True, plots the error bands for the 1D spectra. Default is False.</span>
<span class="sd">    cmap : str, optional</span>
<span class="sd">        Colormap to use for displaying the images. Default is &#39;viridis&#39;.</span>
<span class="sd">    bad_color : tuple of float, optional</span>
<span class="sd">        Color to use for bad pixels. Default is light red (1, 0.7, 0.7).</span>
<span class="sd">    aspect : str, optional</span>
<span class="sd">        Aspect ratio of the plot. Default is &#39;auto&#39;.</span>
<span class="sd">    vmin : float, optional</span>
<span class="sd">        Minimum value for color scaling. If None, determined from the data.</span>
<span class="sd">    vmax : float, optional</span>
<span class="sd">        Maximum value for color scaling. If None, determined from the data.</span>
<span class="sd">    scale : {&#39;linear&#39;, &#39;log&#39;, &#39;asinh&#39;}, optional</span>
<span class="sd">        Scale to use for the image normalization. Default is &#39;asinh&#39;.</span>
<span class="sd">    title_prefix : str, optional</span>
<span class="sd">        Optional prefix for the plot title.</span>
<span class="sd">    title_path : bool, optional</span>
<span class="sd">        If True, uses the full file path for the title;</span>
<span class="sd">        otherwise, uses the basename. Default is False.</span>
<span class="sd">    y_limits : tuple of float, optional</span>
<span class="sd">        Limits for the y-axis of the 1D spectrum plot.</span>
<span class="sd">        If None, limits are determined from the data.</span>
<span class="sd">    is_stage3 : bool, optional</span>
<span class="sd">        Plot stage 3 products? Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------------Check Inputs---------------------------------</span>
    <span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">spectra</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">spectra</span>
    <span class="n">compare_x1d</span> <span class="o">=</span> <span class="p">[</span><span class="n">compare_x1d</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compare_x1d</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">compare_x1d</span>
    <span class="n">compare_mast</span> <span class="o">=</span> <span class="p">[</span><span class="n">compare_mast</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compare_mast</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">compare_mast</span>

    <span class="c1"># Plot stage 3 products?</span>
    <span class="k">if</span> <span class="n">is_stage3</span><span class="p">:</span>

        <span class="c1"># Stage 3 products should include the source_id in the filename.</span>
        <span class="c1"># Sort based on filename rather than open all.</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">filter_prod</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">source_id</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Filter products based on the source_id.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">products</span> <span class="k">if</span> <span class="n">source_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;FXD_SLIT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;FXD_SLIT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">source_id</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>

        <span class="n">spectra</span> <span class="o">=</span> <span class="n">filter_prod</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>
        <span class="n">compare_x1d</span> <span class="o">=</span> <span class="n">filter_prod</span><span class="p">(</span><span class="n">compare_x1d</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">compare_x1d</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">compare_mast</span> <span class="o">=</span> <span class="n">filter_prod</span><span class="p">(</span><span class="n">compare_mast</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">compare_mast</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">ftypes</span> <span class="o">=</span> <span class="p">{</span><span class="n">ftype</span><span class="p">:</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">spectra</span>
                      <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cal&quot;</span><span class="p">,</span> <span class="s2">&quot;s2d&quot;</span><span class="p">,</span> <span class="s2">&quot;x1d&quot;</span><span class="p">]}</span>
    <span class="n">products</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ftypes</span><span class="p">[</span><span class="s1">&#39;s2d&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">plot_resample</span> <span class="k">else</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ftypes</span><span class="p">[</span><span class="s1">&#39;cal&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">products</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid data products found for plotting.&quot;</span><span class="p">)</span>

    <span class="c1"># --------------------------------Set up figures-------------------------------</span>
    <span class="n">total_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">products</span><span class="p">)</span> <span class="o">+</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ftypes</span><span class="p">[</span><span class="s1">&#39;x1d&#39;</span><span class="p">])</span>
    <span class="n">height_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">products</span><span class="p">)</span> <span class="o">+</span> <span class="p">([</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ftypes</span><span class="p">[</span><span class="s1">&#39;x1d&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">total_plots</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">total_plots</span><span class="p">),</span>
                             <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="n">height_ratios</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">ax2d</span><span class="p">,</span> <span class="n">ax1d</span> <span class="o">=</span> <span class="p">(</span><span class="n">axes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ftypes</span><span class="p">[</span><span class="s1">&#39;x1d&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>  <span class="c1"># Set up colormap and bad pixel color.</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">bad_color</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;tab10&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">colors</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

    <span class="c1"># ---------------------------------Plot spectra--------------------------------</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">products</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>  <span class="c1"># Open files as JWST datamodels.</span>

        <span class="c1"># Extract the correct 2D source spectrum if there are multiple.</span>
        <span class="n">slit_m</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">if</span> <span class="s1">&#39;slits&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
            <span class="n">slits</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">slits</span>
            <span class="n">slit_m</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slits</span>
                           <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">source_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">slit_m</span> <span class="o">=</span> <span class="n">slit_m</span> <span class="ow">or</span> <span class="nb">next</span><span class="p">((</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">slits</span>
                                     <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">source_id</span> <span class="o">==</span> <span class="n">source_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slit_m</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span><span class="s2">&#39; not found/invalid in </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">product</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available source_ids: </span><span class="si">{</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">source_id</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">slits</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># Check if &#39;fixed_slit&#39; exists, otherwise fall back to &#39;slitlet_id&#39;</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SLIT: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">slit_m</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">slit_m</span><span class="o">.</span><span class="n">slitlet_id</span><span class="si">}</span><span class="s2">, &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;SOURCE: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">slit_m</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># -----------------------Extract the 2D/3D data----------------------</span>
        <span class="n">data_2d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">slit_m</span><span class="p">,</span> <span class="n">extname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_2d</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Handle multi-integration data.</span>
            <span class="k">if</span> <span class="n">integration</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                <span class="n">data_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data_2d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">integration</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">integration</span> <span class="o">&lt;</span> <span class="n">data_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">data_2d</span> <span class="o">=</span> <span class="n">data_2d</span><span class="p">[</span><span class="n">integration</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid integration &#39;</span><span class="si">{</span><span class="n">integration</span><span class="si">}</span><span class="s2">&#39; for 3D data.&quot;</span><span class="p">)</span>

        <span class="c1"># -----------Convert from pixels to wavelength (x-axis)--------------</span>
        <span class="n">wcsobj</span> <span class="o">=</span> <span class="n">slit_m</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span>  <span class="c1"># Obtaining the WCS object from the meta data.</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="n">slit_m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">slit_m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1"># Coordinate transform from detector space (pixels) to sky (RA, DEC).</span>
        <span class="n">det2sky</span> <span class="o">=</span> <span class="n">wcsobj</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;detector&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">)</span>
        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">s2dwave</span> <span class="o">=</span> <span class="n">det2sky</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># RA/Dec, wavelength (microns) for each pixel.</span>
        <span class="n">s2dwaves</span> <span class="o">=</span> <span class="n">s2dwave</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Single row since this is the rectified spectrum.</span>
        <span class="n">x_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">slit_m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slit_m</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">wav</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">s2dwaves</span><span class="p">[</span><span class="n">x_arr</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Populating the wavelength array.</span>
        <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_arr</span><span class="p">,</span> <span class="n">wav</span><span class="p">)</span>

        <span class="c1"># xticks = np.arange(np.ceil(wave_1d[0]), wave_1d[-1], 0.2)</span>
        <span class="c1"># xtick_pos = np.interp(xticks, wave_1d, np.arange(num_waves))</span>
        <span class="c1"># ax1d.set_xticks(xtick_pos)</span>
        <span class="c1"># ax1d.set_xticklabels([f&#39;{xtick:.1f}&#39; for xtick in xticks])</span>

        <span class="c1"># ---------------------------Scale the data-------------------------</span>
        <span class="n">sigma_clipped_data</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">data_2d</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vmin</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vmax</span>
        <span class="n">stretch_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="n">LogStretch</span><span class="p">(),</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="n">LinearStretch</span><span class="p">(),</span>
                       <span class="s1">&#39;asinh&#39;</span><span class="p">:</span> <span class="n">AsinhStretch</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">stretch_map</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">,</span>
                                  <span class="n">interval</span><span class="o">=</span><span class="n">ManualInterval</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span>
                                  <span class="n">stretch</span><span class="o">=</span><span class="n">stretch_map</span><span class="p">[</span><span class="n">scale</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

        <span class="c1"># -------------------------Plot 1D Spectra-------------------------</span>
        <span class="k">for</span> <span class="n">prods_1d</span><span class="p">,</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ftypes</span><span class="p">[</span><span class="s1">&#39;x1d&#39;</span><span class="p">]),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title_prefix</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">),</span>
                                 <span class="p">(</span><span class="n">compare_x1d</span><span class="p">,</span> <span class="s1">&#39;RE-EXTRACTION &#39;</span><span class="p">),</span>
                                 <span class="p">(</span><span class="n">compare_mast</span><span class="p">,</span> <span class="s1">&#39;MAST &#39;</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">prods_1d</span><span class="p">:</span>

                <span class="n">model_1d</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">prods_1d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">specs</span> <span class="o">=</span> <span class="n">model_1d</span><span class="o">.</span><span class="n">spec</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span> <span class="k">if</span>
                             <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">source_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span> <span class="ow">or</span> <span class="nb">next</span><span class="p">((</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span>
                                     <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">source_id</span> <span class="o">==</span> <span class="n">source_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">spec</span><span class="p">:</span>
                    <span class="n">tab</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">spec_table</span>
                    <span class="n">source_type</span> <span class="o">=</span> <span class="n">source_type</span> <span class="k">if</span> <span class="n">source_type</span> <span class="k">else</span> <span class="n">slit_m</span><span class="o">.</span><span class="n">source_type</span>
                    <span class="n">wave</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">WAVELENGTH</span>
                    <span class="n">flux</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">FLUX</span> <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s1">&#39;POINT&#39;</span> <span class="k">else</span> <span class="n">tab</span><span class="o">.</span><span class="n">SURF_BRIGHT</span>
                    <span class="n">errs</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">FLUX_ERROR</span> <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s1">&#39;POINT&#39;</span> <span class="k">else</span> <span class="n">tab</span><span class="o">.</span><span class="n">SB_ERROR</span>

                    <span class="c1"># Expand the array to visualize the wavelength gap.</span>
                    <span class="k">if</span> <span class="n">expand_wavelength_gap</span><span class="p">:</span>
                        <span class="n">dx1d_wave</span> <span class="o">=</span> <span class="n">wave</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">wave</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">igap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dx1d_wave</span><span class="p">)</span>
                        <span class="n">dx_replace</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx1d_wave</span><span class="p">[</span><span class="n">igap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx1d_wave</span><span class="p">[</span><span class="n">igap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
                        <span class="n">nfill</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dx1d_wave</span><span class="p">)</span> <span class="o">/</span> <span class="n">dx_replace</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">nfill</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expanding wavelength gap </span><span class="si">{</span><span class="n">wave</span><span class="p">[</span><span class="n">igap</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;-- </span><span class="si">{</span><span class="n">wave</span><span class="p">[</span><span class="n">igap</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> μm&quot;</span><span class="p">)</span>

                            <span class="n">wave_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">wave</span><span class="p">[</span><span class="n">igap</span><span class="p">]:</span><span class="n">wave</span><span class="p">[</span><span class="n">igap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:(</span><span class="n">nfill</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">]</span>
                            <span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wave</span><span class="p">[:</span><span class="n">igap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">wave_fill</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">wave</span><span class="p">[</span><span class="n">igap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]])</span>

                            <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s1">&#39;RE-EXTRACTION &#39;</span><span class="p">:</span>
                                <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_waves</span> <span class="o">=</span> <span class="n">data_2d</span><span class="o">.</span><span class="n">shape</span>
                                <span class="n">fill_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">nfill</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                                <span class="n">data_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_2d</span><span class="p">[:,</span> <span class="p">:</span><span class="n">igap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                                          <span class="n">fill_2d</span><span class="p">,</span> <span class="n">data_2d</span><span class="p">[:,</span> <span class="n">igap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]],</span>
                                                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                            <span class="n">fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nfill</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">flux</span><span class="p">[:</span><span class="n">igap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">fill</span><span class="p">,</span> <span class="n">flux</span><span class="p">[</span><span class="n">igap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]])</span>
                            <span class="n">errs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">errs</span><span class="p">[:</span><span class="n">igap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">fill</span><span class="p">,</span> <span class="n">errs</span><span class="p">[</span><span class="n">igap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nfill</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1"># ----------------Construct legends and annotations-----------------</span>
                    <span class="n">detector</span> <span class="o">=</span> <span class="n">slit_m</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span>
                    <span class="n">ffilter</span> <span class="o">=</span> <span class="n">slit_m</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span>
                    <span class="n">grating</span> <span class="o">=</span> <span class="n">slit_m</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">grating</span>
                    <span class="n">dither</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">dither</span><span class="o">.</span><span class="n">position_number</span>
                    <span class="n">label_2d</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grating</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">ffilter</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">label_1d</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">detector</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">grating</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">ffilter</span><span class="si">}</span><span class="s1">)&#39;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_stage3</span><span class="p">:</span>
                        <span class="n">label_2d</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Dither/Nod </span><span class="si">{</span><span class="n">dither</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">label_2d</span><span class="si">}</span><span class="s1">)&#39;</span>
                        <span class="n">label_1d</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1"> Dither/Nod </span><span class="si">{</span><span class="n">dither</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">label_1d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">label_1d</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">label_1d</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">label_2d</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                                     <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                                     <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.3&quot;</span><span class="p">,</span>
                                               <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
                                               <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">),</span>
                                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

                    <span class="n">title_2d</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title_prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">title_prefix</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">slit_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">integration</span><span class="p">:</span>
                        <span class="n">title_2d</span> <span class="o">=</span> <span class="n">title_2d</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">integration</span><span class="si">}</span><span class="s1">].fits&#39;</span><span class="p">)</span>
                    <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_2d</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ftypes</span><span class="p">[</span><span class="s1">&#39;x1d&#39;</span><span class="p">]):</span>
                        <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (μm)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Pixel Row&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

                    <span class="c1"># ------------------------------------------------------------------</span>

                    <span class="n">num_waves</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">color_cycle</span><span class="p">)</span>
                    <span class="n">ax1d</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_1d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">plot_errors</span><span class="p">:</span>
                        <span class="n">ax1d</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_waves</span><span class="p">),</span> <span class="n">flux</span> <span class="o">-</span> <span class="n">errs</span><span class="p">,</span>
                                          <span class="n">flux</span> <span class="o">+</span> <span class="n">errs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                    <span class="n">ax1d</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">ax1d</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title_prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">title_prefix</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;Extracted 1D Spectra | </span><span class="si">{</span><span class="n">slit_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">ax1d</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flux (Jy)&quot;</span> <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s1">&#39;POINT&#39;</span>
                                    <span class="k">else</span> <span class="s2">&quot;Surface Brightness (MJy/sr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">ax1d</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (μm)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

                    <span class="n">ax1d</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_limits</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                               <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)))</span>

                    <span class="c1"># --------------------Plot the 2D spectra &amp; colorbar---------------</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_2d</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                                        <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="n">slit_m</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">bunit_data</span>
                    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x1</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span>
                                            <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span>
                                            <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
                    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
                    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

                    <span class="c1"># ----------------------Add extraction region---------------------</span>
                    <span class="n">ystart</span><span class="p">,</span> <span class="n">ystop</span><span class="p">,</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">xstop</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">extraction_ystart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">spec</span><span class="o">.</span><span class="n">extraction_ystop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">spec</span><span class="o">.</span><span class="n">extraction_xstart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">spec</span><span class="o">.</span><span class="n">extraction_xstop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">extract_width</span> <span class="o">=</span> <span class="n">ystop</span> <span class="o">-</span> <span class="n">ystart</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">box</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">xstart</span><span class="p">,</span> <span class="n">ystart</span><span class="p">),</span> <span class="n">xstop</span> <span class="o">-</span> <span class="n">xstart</span> <span class="o">+</span> <span class="n">nfill</span><span class="p">,</span>
                                    <span class="n">extract_width</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                    <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                    <span class="n">ax2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<section id="display-detector1pipeline-products">
<h3>8.1 Display <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> Products<a class="headerlink" href="#display-detector1pipeline-products" title="Permalink to this heading">#</a></h3>
<p>Inspect the Stage 1 slope products.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="n">rate_file</span> <span class="o">=</span> <span class="n">rate_sci</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Show the last rate file, as an example.</span>
    <span class="n">display_rate</span><span class="p">(</span><span class="n">rate_file</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;asinh&#39;</span><span class="p">,</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">title_prefix</span><span class="o">=</span><span class="s1">&#39;REPROCESSED&#39;</span><span class="p">)</span>  <span class="c1"># , extname=&#39;dq&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="display-spec2pipeline-products">
<h3>8.2 Display <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> Products<a class="headerlink" href="#display-spec2pipeline-products" title="Permalink to this heading">#</a></h3>
<p>Inspect the Stage 2 calibrated spectra. Use Jdaviz <a class="reference external" href="https://jdaviz.readthedocs.io/en/stable/specviz2d/index.html">Specviz2D</a> to visualize and analyze the Stage 2 2D and 1D calibrated spectra. For more information on these visualization tools and plotting capabilities, refer to the official documentation linked.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the Stage 2 FS spectra with Specviz2D.</span>
<span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">specviz2d</span> <span class="o">=</span> <span class="n">Specviz2d</span><span class="p">()</span>
        <span class="n">spectrum_1d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec2_dir</span> <span class="o">+</span> <span class="s1">&#39;*x1d.fits&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">spectrum_2d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec2_dir</span> <span class="o">+</span> <span class="s1">&#39;*s2d.fits&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">specviz2d</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">spectrum_1d</span><span class="p">)</span>
        <span class="n">specviz2d</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to run Specviz2D, using matplotlib instead. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">display_spectra</span><span class="p">(</span><span class="n">sci_s2d</span> <span class="o">+</span> <span class="n">sci_x1d</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="s1">&#39;S200A1&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
                        <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.1e-9</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">3e-8</span><span class="p">,</span> <span class="n">title_prefix</span><span class="o">=</span><span class="s1">&#39;REPROCESSED&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="display-spec3pipeline-products">
<h3>8.3 Display <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> Products<a class="headerlink" href="#display-spec3pipeline-products" title="Permalink to this heading">#</a></h3>
<p>Inspect the Stage 3 combined calibrated spectra.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the Stage 3 FS spectra with Specviz2D.</span>
<span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">specviz2d</span> <span class="o">=</span> <span class="n">Specviz2d</span><span class="p">()</span>
        <span class="n">spectrum_1d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec3_dir</span> <span class="o">+</span> <span class="s1">&#39;*x1d.fits&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spectrum_2d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec3_dir</span> <span class="o">+</span> <span class="s1">&#39;*s2d.fits&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">specviz2d</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">spectrum_2d</span><span class="o">=</span><span class="n">spectrum_2d</span><span class="p">,</span> <span class="n">spectrum_1d</span><span class="o">=</span><span class="n">spectrum_1d</span><span class="p">)</span>
        <span class="n">specviz2d</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unable to display spectra with Specviz2d&quot;</span><span class="p">)</span>
        <span class="n">display_spectra</span><span class="p">(</span><span class="n">stage3_s2d</span> <span class="o">+</span> <span class="n">stage3_x1d</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="s1">&#39;S200A1&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
                        <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.1e-9</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">3e-8</span><span class="p">,</span> <span class="n">title_prefix</span><span class="o">=</span><span class="s1">&#39;REPROCESSED&#39;</span><span class="p">,</span> <span class="n">is_stage3</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="modifying-the-extract1d-reference-file-as-needed">
<h2>9. Modifying the EXTRACT1D Reference File (as needed)<a class="headerlink" href="#modifying-the-extract1d-reference-file-as-needed" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">extract_1d</span></code> step’s <code class="docutils literal notranslate"><span class="pre">use_source_pos</span></code> parameter in Stage 2 generally centers the 1D extraction box on the actual source location effectively and thus doesn’t usually require manual adjustment. However, in some cases, adjusting the position of the extraction box by modifying the EXTRACT1D reference file may be useful. The following section demonstrates how to do this.</p>
<p>The EXTRACT1D reference file, along with several other parameter files, can be found in the <code class="docutils literal notranslate"><span class="pre">CRDS_PATH</span></code> directory. While some files, like <code class="docutils literal notranslate"><span class="pre">.json</span></code> files, can be manually edited, we modify them using Python.</p>
<div class="alert alert-block alert-danger">
<p><strong>Warning</strong>: Currently, there is no aperture correction in place for NIRSpec, so the <code class="docutils literal notranslate"><span class="pre">extract_width</span></code> parameter <strong>MUST</strong> remain unchanged (6 pixels wide; 5 for S1600A1) to ensure proper flux calibration! The extraction box limits (<code class="docutils literal notranslate"><span class="pre">ystart</span></code> and <code class="docutils literal notranslate"><span class="pre">ystop</span></code>) can be modified; however, if <code class="docutils literal notranslate"><span class="pre">ystart</span></code> and <code class="docutils literal notranslate"><span class="pre">ystop</span></code> do not match the <code class="docutils literal notranslate"><span class="pre">extract_width</span></code>, the <code class="docutils literal notranslate"><span class="pre">extract_width</span></code> takes precedence and is applied symmetrically around the midpoint between <code class="docutils literal notranslate"><span class="pre">ystart</span></code> and <code class="docutils literal notranslate"><span class="pre">ystop</span></code>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Modify the EXTRACT1D reference file.</span>

<span class="c1"># If you don&#39;t know the reference file name this should work.</span>
<span class="c1"># extract_1d_ref = Spec3Pipeline().get_reference_file(stage3_s2d, &#39;extract1d&#39;)</span>

<span class="n">refs</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">dump_references</span><span class="p">(</span><span class="n">crds_client</span><span class="o">.</span><span class="n">get_context_used</span><span class="p">(</span><span class="s1">&#39;jwst&#39;</span><span class="p">),</span>
                           <span class="p">[</span><span class="s1">&#39;jwst_nirspec_extract1d_0008.json&#39;</span><span class="p">])</span>
<span class="n">extract_1d_ref</span> <span class="o">=</span> <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;jwst_nirspec_extract1d_0008.json&#39;</span><span class="p">]</span>

<span class="c1"># Open EXTRACT1D reference file in read-mode.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ref_file</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ref_file</span><span class="p">)</span>

    <span class="n">yshift</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>  <span class="c1"># Applied shift in pixels as example.</span>

    <span class="c1"># S200A1</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;extract_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ystart&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">yshift</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ystop&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">yshift</span>

    <span class="c1"># S200B1</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;extract_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;ystart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">26.5</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;ystop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">31.5</span>

    <span class="c1"># S200A2</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;extract_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;ystart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">26.5</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;ystop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">31.5</span>

    <span class="c1"># S400A1</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s2">&quot;extract_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s2">&quot;ystart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s2">&quot;ystop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">36</span>

    <span class="c1"># S1600A1</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="s2">&quot;extract_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="s2">&quot;ystart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="s2">&quot;ystop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">18</span>

<span class="c1"># Write changes to a new file.</span>
<span class="n">newData</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="c1"># Add the suffix &#39;_fs&#39; to distinguish the file from the default version.</span>
<span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
<span class="n">extract_1d_ref_mod</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;_fs.json&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">extract_1d_ref_mod</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newData</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inspect the EXTRACT1D reference file.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">extract_1d_ref_mod</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_obj</span><span class="p">:</span>
    <span class="n">extract_1d_ref_mod_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f_obj</span><span class="p">)</span>

<span class="n">JSON</span><span class="p">(</span><span class="n">extract_1d_ref_mod_data</span><span class="p">,</span> <span class="n">expanded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we re-extract the 1D spectrum by running the <code class="docutils literal notranslate"><span class="pre">Extract1dStep</span></code> and overriding the reference file.</p>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Extract1dStep</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">stage3_s2d</span><span class="p">,</span>
                   <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">output_dir</span><span class="o">=</span><span class="n">spec3_dir</span><span class="p">,</span>
                   <span class="n">output_use_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;x1d_mod&#39;</span><span class="p">,</span>  <span class="c1"># Change suffix to easily find modified file.</span>
                   <span class="n">use_source_posn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">override_extract1d</span><span class="o">=</span><span class="n">extract_1d_ref_mod</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stage3_x1ds_mod</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">spec3_dir</span> <span class="o">+</span> <span class="s1">&#39;*_x1d_mod.fits&#39;</span><span class="p">))</span>
<span class="n">display_spectra</span><span class="p">(</span><span class="n">stage3_s2d</span> <span class="o">+</span> <span class="n">stage3_x1d</span><span class="p">,</span> <span class="n">compare_x1d</span><span class="o">=</span><span class="n">stage3_x1ds_mod</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="s1">&#39;S200A1&#39;</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.1e-9</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">3e-8</span><span class="p">,</span>
                <span class="n">title_prefix</span><span class="o">=</span><span class="s1">&#39;REPROCESSED&#39;</span><span class="p">,</span> <span class="n">is_stage3</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As expected, the demo spectrum extracted in the shifted location has lower flux that the spectrum extracted in the center of the 2D spectral trace.</p>
<hr class="docutils" />
<figure>
       <img src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" alt="Space Telescope Logo\" align="right" style="width: 200px"/>
</figure>
<p><span class="xref myst">Top of Page</span></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jwst-pipeline-notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRSPEC/FSlit"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../BOTS/JWPipeNB-NIRSpec-BOTS.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">NIRSpec BOTS Pipeline Notebook</p>
      </div>
    </a>
    <a class="right-next"
       href="../IFU/JWPipeNB-NIRSpec-IFU.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">NIRSpec IFU Pipeline Notebook</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">1. Configuration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-dependencies-and-parameters">Install dependencies and parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-the-basic-parameters-to-configure-the-notebook">Set the basic parameters to configure the notebook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-crds-context-and-server">Set CRDS Context and Server</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#package-imports">2. Package Imports</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-convenience-functions">Define Convenience Functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-mode-setup-ignore-if-not-using-demo-data">3. Demo Mode Setup (ignore if not using demo data)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-setup">4. Directory Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-1-detector1pipeline-calwebb-detector1">5. Stage 1: <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_detector1</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-detector1pipeline">5.1 Configure <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-detector1pipeline">5.2 Run <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrating-science-files">5.2.1 Calibrating Science Files</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrating-background-files">5.2.2 Calibrating Background Files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-2-spec2pipeline-calwebb-spec2">6. Stage 2: <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_spec2</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-spec2pipeline">6.1 Configure <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-spec2pipeline-association-files">6.2 Create <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> Association Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-spec2pipeline">6.3 Run <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">6.3.1 Calibrating Science Files</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">6.3.2 Calibrating Background Files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-3-spec3pipeline-calwebb-spec3">7. Stage 3: <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> (<code class="docutils literal notranslate"><span class="pre">calwebb_spec3</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-spec3pipeline">7.1 Configure <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-spec3pipeline-association-files">7.2 Create <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> Association Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-spec3pipeline">7.3 Run <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-data">8. Visualize the Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#display-detector1pipeline-products">8.1 Display <code class="docutils literal notranslate"><span class="pre">Detector1Pipeline</span></code> Products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#display-spec2pipeline-products">8.2 Display <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> Products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#display-spec3pipeline-products">8.3 Display <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code> Products</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-the-extract1d-reference-file-as-needed">9. Modifying the EXTRACT1D Reference File (as needed)</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>