

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>NIRISS AMI Pipeline Notebook &#8212; JWST Pipeline Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRISS/AMI/JWPipeNB-niriss-ami';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="NIRISS Imaging Pipeline Notebook" href="../Imaging/JWPipeNB-niriss-imaging.html" />
    <link rel="prev" title="NIRCam Imaging Pipeline Notebook" href="../../NIRCAM/Imaging/JWPipeNB-nircam-imaging.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="JWST Pipeline Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="JWST Pipeline Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../README.html">
                    JWST Pipeline Notebooks
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/Coronagraphy/JWPipeNB-MIRI-Coron.html">MIRI Coronagraphy Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/Imaging/JWPipeNB-MIRI-imaging.html">MIRI Imaging Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/Imaging-TSO/JWPipeNB-MIRI-imaging-TSO.html">MIRI Imaging TSO Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/LRS-slit/JWPipeNB-MIRI-LRS-slit.html">MIRI LRS Slit Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/LRS-slitless-TSO/JWPipeNB-MIRI-LRS-slitless-TSO.html">MIRI LRS Slitless TSO Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS/JWPipeNB-MIRI-MRS.html">MIRI MRS Notebook</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCAM</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCAM/Coronagraphy/JWPipeNB-nircam-coronagraphy.html">NIRCam Coronagraphy Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCAM/Imaging/JWPipeNB-nircam-imaging.html">NIRCam Imaging Notebook</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">NIRISS AMI Pipeline Notebook</a></li>









<li class="toctree-l1"><a class="reference internal" href="../Imaging/JWPipeNB-niriss-imaging.html">NIRISS Imaging Pipeline Notebook</a></li>

<li class="toctree-l1"><a class="reference internal" href="../WFSS/JWPipeNB-niriss-wfss.html">NIRISS Wide Field Slitless Spectroscopy (WFSS) Pipeline Notebook</a></li>










</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSPEC/BOTS/JWPipeNB-NIRSpec-BOTS.html">NIRSpec BOTS Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSPEC/FSlit/JWPipeNB-NIRSpec-FS.html">NIRSpec Fixed Slit Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSPEC/IFU/JWPipeNB-NIRSpec-IFU.html">NIRSpec IFU Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSPEC/MOS/JWPipeNB-NIRSpec-MOS.html">NIRSpec MOS Notebook</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jwst-pipeline-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jwst-pipeline-notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRISS/AMI/JWPipeNB-niriss-ami.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRISS/AMI/JWPipeNB-niriss-ami.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>NIRISS AMI Pipeline Notebook</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">NIRISS AMI Pipeline Notebook</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">1. Configuration</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-dependencies-and-parameters">Install dependencies and parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-crds-context-and-server">Set CRDS context and server</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#package-imports">2. Package Imports</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-convenience-functions">Define convenience functions</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-mode-setup-ignore-if-not-using-demo-data">3. Demo Mode Setup (ignore if not using demo data)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-setup">4. Directory Setup</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#detector1-pipeline">5. Detector1 Pipeline</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-data">Exploring the data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#image2-pipeline">6. Image2 Pipeline</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ami3-pipeline">7. AMI3 Pipeline</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-asdf-file">Create ASDF File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-association-files">Create Association Files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-ami3-stage-of-the-pipeline">Run AMI3 stage of the pipeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-which-pipeline-steps-were-run">Verify which pipeline steps were run</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-results">8. Visualize the results</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-interferometric-observables">Plot interferometric observables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#display-the-best-fit-model">Display the best-fit model</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <a class="reference internal image-reference" href="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_header.png"><img alt="stsci_logo" src="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_header.png" style="width: 900px;" /></a>
<p><font color="red">This notebook currently fails to execute, use as reference only</font></p>
<section id="niriss-ami-pipeline-notebook">
<h1>NIRISS AMI Pipeline Notebook<a class="headerlink" href="#niriss-ami-pipeline-notebook" title="Permalink to this heading">#</a></h1>
<p><strong>Authors</strong>: R. Cooper<br>
<strong>Last Updated</strong>: July 16, 2025<br>
<strong>Pipeline Version</strong>: 1.19.1 (Build 12.0)</p>
<p><strong>Purpose</strong>:<br>
This notebook provides a framework for processing Near-Infrared
Imager and Slitless Spectrograph (NIRISS) Aperture Masking Interferometry (AMI) data through all
three James Webb Space Telescope (JWST) pipeline stages.  Data is assumed
to be located in one observation folder according to paths set up below.
It should not be necessary to edit any cells other than in the
<span class="xref myst">Configuration</span> section unless modifying the standard
pipeline processing options.</p>
<p><strong>Data</strong>:
This notebook uses an example dataset from
<a class="reference external" href="https://www.stsci.edu/jwst/science-execution/program-information">Program ID</a>
1093 (PI: Thatte) which is the AMI commissioning program. For illustrative
purposes, we will use a single target and reference star pair. Each exposure
was taken in the F480W filter filter with the non-redundant mask (NRM) that
enables AMI in the pupil. The observations used are
observation 12 for the target and observation 15 for the reference star.</p>
<p>Example input data to use will be downloaded automatically unless
disabled (i.e., to use local files instead).</p>
<p><strong>JWST pipeline version and CRDS context</strong>:<br>
This notebook was written for the above-specified pipeline version and associated
build context for this version of the JWST Calibration Pipeline. Information about
this and other contexts can be found in the JWST Calibration Reference Data System
(CRDS <a class="reference external" href="https://jwst-crds.stsci.edu/">server</a>). If you use different pipeline versions,
please refer to the table <a class="reference external" href="https://jwst-crds.stsci.edu/display_build_contexts/">here</a>
to determine what context to use. To learn more about the differences for the pipeline,
read the relevant
<a class="reference external" href="https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline/jwst-operations-pipeline-build-information#references">documentation</a>.<br></p>
<p>Please note that pipeline software development is a continuous process, so results
in some cases may be slightly different if a subsequent version is used. <strong>For optimal
results, users are strongly encouraged to reprocess their data using the most recent
pipeline version and
<a class="reference external" href="https://jwst-crds.stsci.edu/display_build_contexts/">associated CRDS context</a>,
taking advantage of bug fixes and algorithm improvements.</strong>
Any <a class="reference external" href="https://jwst-docs.stsci.edu/known-issues-with-jwst-data/niriss-known-issues/niriss-ami-known-issues">known issues</a> for this build are noted in the notebook.<BR></p>
<p><strong>Updates</strong>:<br>
This notebook is regularly updated as improvements are made to the
pipeline. Find the most up to date version of this notebook at:
https://github.com/spacetelescope/jwst-pipeline-notebooks/</p>
<p><strong>Recent Changes</strong>:<br>
March 31, 2025: original notebook released<br>
July 16, 2025: Updated to jwst 1.19.1 (no significant changes)</p>
<hr style="border:1px solid gray"> </hr></section>
<section id="table-of-contents">
<h1>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h1>
<ol class="arabic simple">
<li><p><span class="xref myst">Configuration</span></p></li>
<li><p><span class="xref myst">Package Imports</span></p></li>
<li><p><span class="xref myst">Demo Mode Setup (ignore if not using demo data)</span></p></li>
<li><p><span class="xref myst">Directory Setup</span></p></li>
<li><p><span class="xref myst">Detector 1 Pipeline</span></p></li>
<li><p><span class="xref myst">Image2 Pipeline</span></p></li>
<li><p><span class="xref myst">AMI3 Pipeline</span></p></li>
<li><p><span class="xref myst">Visualize the data</span></p></li>
</ol>
<hr style="border:1px solid gray"> </hr></section>
<section id="configuration">
<h1>1. Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">#</a></h1>
<hr class="docutils" />
<section id="install-dependencies-and-parameters">
<h2>Install dependencies and parameters<a class="headerlink" href="#install-dependencies-and-parameters" title="Permalink to this heading">#</a></h2>
<p>To make sure that the pipeline version is compatabile with the steps
discussed below and the required dependencies and packages are installed,
you can create a fresh conda environment and install the provided
<code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">niriss_ami_pipeline</span> <span class="n">python</span><span class="o">=</span><span class="mf">3.11</span>
<span class="n">conda</span> <span class="n">activate</span> <span class="n">niriss_ami_pipeline</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>Set the basic parameters to use with this notebook. These will affect
what data is used, where data is located (if already in disk), and
pipeline modules run in this data. The list of parameters are:</p>
<ul class="simple">
<li><p>demo_mode</p></li>
<li><p>directories with data</p></li>
<li><p>pipeline modules</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic import necessary for configuration</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
Note that <code>demo_mode</code> must be set appropriately below.
</div>
<p>Set <code>demo_mode = True </code> to run in demonstration mode. In this
mode this notebook will download example data from the Barbara A.
Mikulski Archive for Space Telescopes (<a class="reference external" href="https://archive.stsci.edu/">MAST</a>)
and process it through the
pipeline. This will all happen in a local directory unless modified
in <span class="xref myst">Section 3</span>
below.</p>
<p>Set <code>demo_mode = False</code> if you want to process your own data
that has already been downloaded and provide the location of the data.<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set parameters for demo_mode, channel, band, data mode directories, and </span>
<span class="c1"># processing steps.</span>

<span class="c1"># -----------------------------Demo Mode---------------------------------</span>
<span class="n">demo_mode</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running in demonstration mode using online example data!&#39;</span><span class="p">)</span>

<span class="c1"># --------------------------User Mode Directories------------------------</span>
<span class="c1"># If demo_mode = False, look for user data in these paths</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="c1"># Set directory paths for processing specific data; these will need</span>
    <span class="c1"># to be changed to your local directory setup (below are given as</span>
    <span class="c1"># examples)</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Point to location of science observation data.</span>
    <span class="c1"># Assumes both science and PSF reference data are in the same directory</span>
    <span class="c1"># with uncalibrated data in sci_dir/uncal/ and results in stage1,</span>
    <span class="c1"># stage2, stage3 directories</span>
    <span class="n">sci_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;JWSTData/PID_1093/&#39;</span><span class="p">)</span>

<span class="c1"># Set which filter to process (empty will process all)</span>
<span class="n">use_filter</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># E.g., F480M</span>

<span class="c1"># --------------------------Set Processing Steps--------------------------</span>
<span class="c1"># Individual pipeline stages can be turned on/off here.  Note that a later</span>
<span class="c1"># stage won&#39;t be able to run unless data products have already been</span>
<span class="c1"># produced from the prior stage.</span>

<span class="c1"># Science processing</span>
<span class="n">dodet1</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_detector1</span>
<span class="n">doimage2</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_image2</span>
<span class="n">doami3</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_ami3</span>
<span class="n">doviz</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Visualize calwebb_ami3 output</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-crds-context-and-server">
<h2>Set CRDS context and server<a class="headerlink" href="#set-crds-context-and-server" title="Permalink to this heading">#</a></h2>
<p>Before importing <code>CRDS</code> and <code>JWST</code> modules, we need
to configure our environment. This includes defining a CRDS cache
directory in which to keep the reference files that will be used by the
calibration pipeline.</p>
<p>If the root directory for the local CRDS cache directory has not been set
already, it will be set to create one in the home directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------------------------Set CRDS context and paths----------------------</span>
<span class="c1"># Each version of the calibration pipeline is associated with a specific CRDS</span>
<span class="c1"># context file. The pipeline will select the appropriate context file behind</span>
<span class="c1"># the scenes while running. However, if you wish to override the default context</span>
<span class="c1"># file and run the pipeline with a different context, you can set that using</span>
<span class="c1"># the CRDS_CONTEXT environment variable. Here we show how this is done,</span>
<span class="c1"># although we leave the line commented out in order to use the default context.</span>
<span class="c1"># If you wish to specify a different context, uncomment the line below.</span>
<span class="c1">#os.environ[&#39;CRDS_CONTEXT&#39;] = &#39;jwst_1322.pmap&#39;  # CRDS context for 1.16.0</span>

<span class="c1"># Check whether the local CRDS cache directory has been set.</span>
<span class="c1"># If not, set it to the user home directory</span>
<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;crds&#39;</span><span class="p">)</span>
    
<span class="c1"># Check whether the CRDS server URL has been set.  If not, set it.</span>
<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://jwst-crds.stsci.edu&#39;</span>

<span class="c1"># Echo CRDS path in use</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRDS local filepath: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRDS file server: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="package-imports">
<h1>2. Package Imports<a class="headerlink" href="#package-imports" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the entire available screen width for this notebook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;style&gt;.container { width:95% !important; }&lt;/style&gt;&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic system utilities for interacting with files</span>
<span class="c1"># ----------------------General Imports------------------------------------</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># Numpy for doing calculations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># -----------------------Astroquery Imports--------------------------------</span>
<span class="c1"># ASCII files, and downloading demo files</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Observations</span>

<span class="c1"># For visualizing data</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">MinMaxInterval</span><span class="p">,</span> <span class="n">SqrtStretch</span><span class="p">,</span>
                                   <span class="n">ImageNormalize</span><span class="p">)</span>

<span class="c1"># For file manipulation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asdf</span>

<span class="c1"># for JWST calibration pipeline</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwst</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">crds</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Detector1Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image2Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ami3Pipeline</span>

<span class="c1"># JWST pipeline utilities</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst</span><span class="w"> </span><span class="kn">import</span> <span class="n">datamodels</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.associations</span><span class="w"> </span><span class="kn">import</span> <span class="n">asn_from_list</span>  <span class="c1"># Tools for creating association files</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.associations.lib.rules_level3_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">DMS_Level3_Base</span>  <span class="c1"># Definition of a Lvl3 association file</span>

<span class="c1"># Echo pipeline version and CRDS context in use</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JWST Calibration Pipeline Version: </span><span class="si">{</span><span class="n">jwst</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using CRDS Context: </span><span class="si">{</span><span class="n">crds</span><span class="o">.</span><span class="n">get_context_name</span><span class="p">(</span><span class="s1">&#39;jwst&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="define-convenience-functions">
<h2>Define convenience functions<a class="headerlink" href="#define-convenience-functions" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a convenience function to select only files of a given filter from an input set</span>
<span class="k">def</span><span class="w"> </span><span class="nf">select_filter_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">use_filter</span><span class="p">):</span>
    <span class="n">files_culled</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">use_filter</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">filt</span> <span class="o">==</span> <span class="n">use_filter</span><span class="p">):</span>
                <span class="n">files_culled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files_culled</span> <span class="o">=</span> <span class="n">files</span>
        
    <span class="k">return</span> <span class="n">files_culled</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a convenience function to separate a list of input files into science and PSF reference exposures</span>
<span class="k">def</span><span class="w"> </span><span class="nf">split_scipsf_files</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="n">psffiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scifiles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">psf_reference</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">psffiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scifiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">scifiles</span><span class="p">,</span> <span class="n">psffiles</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start a timer to keep track of runtime</span>
<span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="demo-mode-setup-ignore-if-not-using-demo-data">
<h1>3. Demo Mode Setup (ignore if not using demo data)<a class="headerlink" href="#demo-mode-setup-ignore-if-not-using-demo-data" title="Permalink to this heading">#</a></h1>
<hr class="docutils" />
<p>If running in demonstration mode, set up the program information to
retrieve the uncalibrated data automatically from MAST using
<a class="reference external" href="https://astroquery.readthedocs.io/en/latest/mast/mast.html">astroquery</a>.
MAST has a dedicated service for JWST data retrieval, so the archive can
be searched by instrument keywords rather than just filenames or proposal IDs.<br></p>
<p>The list of searchable keywords for filtered JWST MAST queries
is <a class="reference external" href="https://mast.stsci.edu/api/v0/_jwst_inst_keywd.html">here</a>.<br></p>
<p>For illustrative purposes, we will use a single target and reference star pair. Each exposure was taken in the <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-imager-and-slitless-spectrograph/niriss-instrumentation/niriss-filters">F480W filter</a> filter with the <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-imager-and-slitless-spectrograph/niriss-instrumentation/niriss-non-redundant-mask">non-redundant mask (NRM)</a> that enables AMI in the pupil.</p>
<p>We will start with uncalibrated data products. The files are named
<code class="docutils literal notranslate"><span class="pre">jw010930nn001_03102_00001_nis_uncal.fits</span></code>, where <em>nn</em> refers to the
observation number: in this case, observation 12 for the target and
observation 15 for the reference star.</p>
<p>More information about the JWST file naming conventions can be found at:
https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/file_naming.html</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the program information and paths for demo program</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running in demonstration mode and will download example data from MAST!&#39;</span><span class="p">)</span>
    
    <span class="c1"># --------------Program and observation information--------------</span>
    <span class="n">program</span> <span class="o">=</span> <span class="s1">&#39;01093&#39;</span>
    <span class="n">sci_observtn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;012&#39;</span><span class="p">,</span> <span class="s1">&#39;015&#39;</span><span class="p">]</span>  <span class="c1"># Obs 12 is the target, Obs 15 is the reference star</span>
    <span class="n">visit</span> <span class="o">=</span> <span class="s1">&#39;001&#39;</span>
    <span class="n">visitgroup</span> <span class="o">=</span> <span class="s1">&#39;03&#39;</span>
    <span class="n">seq_id</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
    <span class="n">act_id</span> <span class="o">=</span> <span class="s1">&#39;02&#39;</span>
    <span class="n">expnum</span> <span class="o">=</span> <span class="s1">&#39;00001&#39;</span>

    <span class="c1"># --------------Program and observation directories--------------</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;nis_ami_demo_data&#39;</span><span class="p">)</span>
    <span class="n">sci_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;PID_1093&#39;</span><span class="p">)</span>
    <span class="n">uncal_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;uncal&#39;</span><span class="p">)</span>  <span class="c1"># Uncalibrated pipeline inputs should be here</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">)</span>

    <span class="c1"># Create directory if it does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Identify list of science (SCI) uncalibrated files associated with visits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obtain a list of observation IDs for the specified demo program</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="c1"># Science data</span>
    <span class="n">sci_obs_id_table</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">instrument_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;NIRISS/AMI&quot;</span><span class="p">],</span>
                                                   <span class="n">proposal_id</span><span class="o">=</span><span class="p">[</span><span class="n">program</span><span class="p">],</span>
                                                   <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;F480M;NRM&#39;</span><span class="p">],</span>  <span class="c1"># Data for Specific Filter</span>
                                                   <span class="n">obs_id</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jw&#39;</span> <span class="o">+</span> <span class="n">program</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn the list of visits into a list of uncalibrated data files</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="c1"># Define types of files to select</span>
    <span class="n">file_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uncal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;product_type&#39;</span><span class="p">:</span> <span class="s1">&#39;SCIENCE&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">:</span> <span class="s1">&#39;UNCAL&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;calib_level&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]}}</span>

    <span class="c1"># Science files</span>
    <span class="n">sci_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop over visits identifying uncalibrated files that are associated</span>
    <span class="c1"># with them</span>
    <span class="k">for</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sci_obs_id_table</span><span class="p">):</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">exposure</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filetype</span><span class="p">,</span> <span class="n">query_dict</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">filtered_products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">productType</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;product_type&#39;</span><span class="p">],</span>
                                                             <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">],</span>
                                                             <span class="n">calib_level</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;calib_level&#39;</span><span class="p">])</span>
            <span class="n">sci_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filtered_products</span><span class="p">[</span><span class="s1">&#39;dataURI&#39;</span><span class="p">])</span>

    <span class="c1"># Select only the exposures we want to use based on filename</span>
    <span class="c1"># Construct the filenames and select files based on them</span>
    <span class="n">filestrings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;jw&#39;</span> <span class="o">+</span> <span class="n">program</span> <span class="o">+</span> <span class="n">sciobs</span> <span class="o">+</span> <span class="n">visit</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">visitgroup</span> <span class="o">+</span> <span class="n">seq_id</span> <span class="o">+</span> <span class="n">act_id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">expnum</span> <span class="k">for</span> <span class="n">sciobs</span> <span class="ow">in</span> <span class="n">sci_observtn</span><span class="p">]</span>
    <span class="n">sci_files_to_download</span> <span class="o">=</span> <span class="p">[</span><span class="n">scifile</span> <span class="k">for</span> <span class="n">scifile</span> <span class="ow">in</span> <span class="n">sci_files</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">filestr</span> <span class="ow">in</span> <span class="n">scifile</span> <span class="k">for</span> <span class="n">filestr</span> <span class="ow">in</span> <span class="n">filestrings</span><span class="p">)]</span>
    <span class="n">sci_files_to_download</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sci_files_to_download</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Science files selected for downloading: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sci_files_to_download</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Download all the uncal files and place them into the appropriate
directories.</p>
<div class="alert alert-block alert-warning">
Warning: If this notebook is halted during this step the downloaded file
may be incomplete, and cause crashes later on!
</div><div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">sci_files_to_download</span><span class="p">:</span>
        <span class="n">sci_manifest</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                                  <span class="n">local_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
<section id="directory-setup">
<h1>4. Directory Setup<a class="headerlink" href="#directory-setup" title="Permalink to this heading">#</a></h1>
<hr class="docutils" />
<p>Set up detailed paths to input/output stages here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define output subdirectories to keep science data products organized</span>
<span class="c1"># -----------------------------Science Directories------------------------------</span>
<span class="n">uncal_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;uncal&#39;</span><span class="p">)</span>  <span class="c1"># Uncalibrated pipeline inputs should be here</span>
<span class="n">det1_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage1&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_detector1 pipeline outputs will go here</span>
<span class="n">image2_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage2&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_image2 pipeline outputs will go here</span>
<span class="n">ami3_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage3&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_ami3 pipeline outputs will go here</span>

<span class="c1"># We need to check that the desired output directories exist, and if not create them</span>
<span class="c1"># Ensure filepaths for input data exist</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">)</span>
 
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image2_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">image2_dir</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ami3_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ami3_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Print the exposure parameters of all potential input files:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uncal_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">,</span> <span class="s1">&#39;*_uncal.fits&#39;</span><span class="p">)))</span>
<span class="c1"># Restrict to selected filter if applicable</span>
<span class="n">uncal_files</span> <span class="o">=</span> <span class="n">select_filter_files</span><span class="p">(</span><span class="n">uncal_files</span><span class="p">,</span> <span class="n">use_filter</span><span class="p">)</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">uncal_files</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="c1"># print file name</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># Print out exposure info</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instrument: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filter: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pupil: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">pupil</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of integrations: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">nints</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of groups: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">ngroups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Readout pattern: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">readpatt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dither position number: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">dither</span><span class="o">.</span><span class="n">position_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>For the demo data, files should be for the NIRISS instrument
using the <code class="docutils literal notranslate"><span class="pre">F480M</span></code> filter in the <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-imager-and-slitless-spectrograph/niriss-instrumentation/niriss-pupil-and-filter-wheels">Filter Wheel</a>
and the <code class="docutils literal notranslate"><span class="pre">NRM</span></code> in the Pupil Wheel.</p>
<p>Likewise, both demo exposures use the <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-imager-and-slitless-spectrograph/niriss-instrumentation/niriss-detector-overview/niriss-detector-readout-patterns"><code class="docutils literal notranslate"><span class="pre">NISRAPID</span></code> readout pattern</a>. The target has 5 groups per integration, and 69 integrations per exposure. The reference star has 12 groups per integration, and 61 integrations per exposure. They were taken at the same dither position; primary dither pattern position 1.</p>
<p>For more information about how JWST exposures are defined by up-the-ramp sampling, see the
<a class="reference external" href="https://jwst-docs.stsci.edu/understanding-exposure-times">Understanding Exposure Times JDox article</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
<section id="detector1-pipeline">
<h1>5. Detector1 Pipeline<a class="headerlink" href="#detector1-pipeline" title="Permalink to this heading">#</a></h1>
<p>Run the datasets through the
<a class="reference external" href="https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline-overview/stages-of-jwst-data-processing/calwebb_detector1">Detector1</a>
stage of the pipeline to apply detector level calibrations and create a
countrate data product where slopes are fitted to the integration ramps.
These <code class="docutils literal notranslate"><span class="pre">*_rateints.fits</span></code> products are 3D (nintegrations x nrows x ncols)
and contain the fitted ramp slopes for each integration.
2D countrate data products (<code class="docutils literal notranslate"><span class="pre">*_rate.fits</span></code>) are also
created (nrows x ncols) which have been averaged over all
integrations.</p>
<p>By default, all steps in the Detector1 stage of the pipeline are run for
NIRISS except: the <code class="docutils literal notranslate"><span class="pre">ipc</span></code> correction step and the <code class="docutils literal notranslate"><span class="pre">gain_scale</span></code> step. Note
that while the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/persistence/description.html"><code class="docutils literal notranslate"><span class="pre">persistence</span></code> step</a>
is set to run by default, this step does not automatically correct the
science data for persistence. The <code class="docutils literal notranslate"><span class="pre">persistence</span></code> step creates a
<code class="docutils literal notranslate"><span class="pre">*_trapsfilled.fits</span></code> file which is a model that records the number
of traps filled at each pixel at the end of an exposure. This file would be
used as an input to the <code class="docutils literal notranslate"><span class="pre">persistence</span></code> step, via the <code class="docutils literal notranslate"><span class="pre">input_trapsfilled</span></code>
argument, to correct a science exposure for persistence. Since persistence
is not well calibrated for NIRISS, we do not perform a persistence
correction and thus turn off this step to speed up calibration and to not
create files that will not be used in the subsequent analysis. This step
can be turned off when running the pipeline in Python by doing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rate_result</span> <span class="o">=</span> <span class="n">Detector1Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">uncal</span><span class="p">,</span><span class="n">steps</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;persistence&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;skip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>
</pre></div>
</div>
<p>or as indicated in the cell bellow using a dictionary.</p>
<p>The <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/charge_migration/index.html#charge-migration-step">charge_migration step</a>
is particularly important for NIRISS images to mitigate apparent flux loss
in resampled images due to the spilling of charge from a central pixel into
its neighboring pixels (see <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2023arXiv231116301G/abstract">Goudfrooij et al. 2023</a>
for details). Charge migration occurs when the accumulated charge in a
central pixel exceeds a certain signal limit, which is ~25,000 ADU. This
step is turned on by default for NIRISS imaging mode when using CRDS
contexts of <code class="docutils literal notranslate"><span class="pre">jwst_1159.pmap</span></code> or later. Different signal limits for each filter are provided by the
<a class="reference external" href="https://jwst-crds.stsci.edu">pars-chargemigrationstep parameter files</a>.
Users can specify a different signal limit by running this step with the
<code class="docutils literal notranslate"><span class="pre">signal_threshold</span></code> flag and entering another signal limit in units of ADU.
The effect is stronger when there is high contrast between a bright pixel and neighboring faint pixel,
as is the case for the strongly peaked AMI PSF.</p>
<p>For AMI mode, preliminary investigation shows that dark subtraction does not improve calibration,
and may in fact have a detrimental effect, so we turn it off here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the Detector1 pipeline should be configured</span>

<span class="c1"># Boilerplate dictionary setup</span>
<span class="n">det1dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

<span class="c1"># Step names are copied here for reference</span>
<span class="n">det1_steps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group_scale&#39;</span><span class="p">,</span> <span class="s1">&#39;dq_init&#39;</span><span class="p">,</span> <span class="s1">&#39;saturation&#39;</span><span class="p">,</span> <span class="s1">&#39;ipc&#39;</span><span class="p">,</span> <span class="s1">&#39;superbias&#39;</span><span class="p">,</span> <span class="s1">&#39;refpix&#39;</span><span class="p">,</span>
              <span class="s1">&#39;linearity&#39;</span><span class="p">,</span> <span class="s1">&#39;persistence&#39;</span><span class="p">,</span> <span class="s1">&#39;dark_current&#39;</span><span class="p">,</span> <span class="s1">&#39;charge_migration&#39;</span><span class="p">,</span>
              <span class="s1">&#39;jump&#39;</span><span class="p">,</span> <span class="s1">&#39;ramp_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;gain_scale&#39;</span><span class="p">]</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped</span>
<span class="c1"># skipping the ipc, persistence, and dark steps</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;ipc&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;persistence&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;dark_current&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Overrides for various reference files</span>
<span class="c1"># Files should be in the base local directory or provide full path</span>
<span class="c1">#det1dict[&#39;dq_init&#39;][&#39;override_mask&#39;] = &#39;myfile.fits&#39;  # Bad pixel mask</span>
<span class="c1">#det1dict[&#39;saturation&#39;][&#39;override_saturation&#39;] = &#39;myfile.fits&#39;  # Saturation</span>
<span class="c1">#det1dict[&#39;linearity&#39;][&#39;override_linearity&#39;] = &#39;myfile.fits&#39;  # Linearity</span>
<span class="c1">#det1dict[&#39;dark_current&#39;][&#39;override_dark&#39;] = &#39;myfile.fits&#39;  # Dark current subtraction</span>
<span class="c1">#det1dict[&#39;jump&#39;][&#39;override_gain&#39;] = &#39;myfile.fits&#39;  # Gain used by jump step</span>
<span class="c1">#det1dict[&#39;ramp_fit&#39;][&#39;override_gain&#39;] = &#39;myfile.fits&#39;  # Gain used by ramp fitting step</span>
<span class="c1">#det1dict[&#39;jump&#39;][&#39;override_readnoise&#39;] = &#39;myfile.fits&#39;  # Read noise used by jump step</span>
<span class="c1">#det1dict[&#39;ramp_fit&#39;][&#39;override_readnoise&#39;] = &#39;myfile.fits&#39;  # Read noise used by ramp fitting step</span>

<span class="c1"># Turn on multi-core processing (off by default). Choose what fraction of cores to use (quarter, half, or all)</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">][</span><span class="s1">&#39;maximum_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;half&#39;</span>

<span class="c1"># Alter parameters of certain steps (example)</span>
<span class="c1">#det1dict[&#39;charge_migration&#39;][&#39;signal_threshold&#39;] = X</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">clean_flicker_noise</span></code> step removes 1/f noise from calibrated ramp images, after the jump step and prior to performing the ramp_fitting step. By default, this step is skipped in the calwebb_detector1 pipeline for all instruments and modes. Although available, this step has not been extensively tested for the NIRISS AMI subarray and is thus not recommended at the present time.</p>
<p>Run Detector1 stage of pipeline</p>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Detector1 stage of pipeline, specifying:</span>
<span class="c1"># output directory to save *_rateints.fits files</span>
<span class="c1"># save_results flag set to True so the *rateints.fits files are saved</span>
<span class="c1"># save_calibrated_ramp set to True so *ramp.fits files are saved</span>

<span class="k">if</span> <span class="n">dodet1</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">uncal</span> <span class="ow">in</span> <span class="n">uncal_files</span><span class="p">:</span>
        <span class="n">rate_result</span> <span class="o">=</span> <span class="n">Detector1Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">uncal</span><span class="p">,</span>
                                             <span class="n">output_dir</span><span class="o">=</span><span class="n">det1_dir</span><span class="p">,</span>
                                             <span class="n">steps</span><span class="o">=</span><span class="n">det1dict</span><span class="p">,</span>
                                             <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">save_calibrated_ramp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Detector1 processing&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for Detector1: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="exploring-the-data">
<h2>Exploring the data<a class="headerlink" href="#exploring-the-data" title="Permalink to this heading">#</a></h2>
<p>Identify <code class="docutils literal notranslate"><span class="pre">*_rateints.fits</span></code> files and verify which pipeline steps were run and
which calibration reference files were applied.</p>
<p>The header contains information about which calibration steps were
completed and skipped and which reference files were used to process the
data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dodet1</span><span class="p">:</span>
    <span class="c1"># find rateints files</span>
    <span class="n">rateints_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">,</span> <span class="s1">&#39;*_rateints.fits&#39;</span><span class="p">)))</span>
    <span class="c1"># Restrict to selected filter if applicable</span>
    <span class="n">rateints_files</span> <span class="o">=</span> <span class="n">select_filter_files</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">,</span> <span class="n">use_filter</span><span class="p">)</span>
    
    <span class="c1"># Read in the first file as datamodel as an example</span>
    <span class="n">rateints</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Check which steps were run</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">rateints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">cal_step</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check which CRDS version and reference files were used to calibrate the dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dodet1</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">rateints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">rateints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">rateints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="image2-pipeline">
<h1>6. Image2 Pipeline<a class="headerlink" href="#image2-pipeline" title="Permalink to this heading">#</a></h1>
<p>In the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_image2.html">Image2 stage of the pipeline</a>,
calibrated data products are created (<code class="docutils literal notranslate"><span class="pre">*_cal.fits</span></code> or
<code class="docutils literal notranslate"><span class="pre">*_calints.fits</span></code> files, depending on whether the input files are
<code class="docutils literal notranslate"><span class="pre">*_rate.fits</span></code> or <code class="docutils literal notranslate"><span class="pre">*_rateints.fits</span></code>).</p>
<p>In this pipeline processing stage, the data are <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/flatfield/index.html#flatfield-step">flat fielded</a>. For AMI, we do not perform any of the other <code class="docutils literal notranslate"><span class="pre">Image2</span></code> steps such as photometric calibration, so our output data products still have units of countrate (ADU/s).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_image2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the Image2 pipeline should be configured.</span>

<span class="c1"># Boilerplate dictionary setup</span>
<span class="n">image2dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

<span class="n">image2steps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;assign_wcs&#39;</span><span class="p">,</span> <span class="s1">&#39;flat_field&#39;</span><span class="p">,</span> <span class="s1">&#39;photom&#39;</span><span class="p">,</span> <span class="s1">&#39;resample&#39;</span><span class="p">]</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped (example)</span>
<span class="n">image2dict</span><span class="p">[</span><span class="s1">&#39;photom&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">image2dict</span><span class="p">[</span><span class="s1">&#39;resample&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Overrides for various reference files</span>
<span class="c1"># Files should be in the base local directory or provide full path</span>
<span class="c1">#image2dict[&#39;flat_field&#39;][&#39;override_flat&#39;] = &#39;myfile.fits&#39;  # Pixel flatfield</span>
</pre></div>
</div>
</div>
</div>
<p>Find and sort the input files, ensuring use of absolute paths:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use files from the detector1 output folder</span>
<span class="n">rateints_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">,</span> <span class="s1">&#39;jw*rateints.fits&#39;</span><span class="p">)))</span>
<span class="c1"># Restrict to selected filter if applicable</span>
<span class="n">rateints_files</span> <span class="o">=</span> <span class="n">select_filter_files</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">,</span> <span class="n">use_filter</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">)):</span>
    <span class="n">rateints_files</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">))</span><span class="si">}</span><span class="s2"> science files&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Image2 stage of pipeline, specifying:</span>
<span class="c1"># output directory to save *_calints.fits files</span>
<span class="c1"># save_results flag set to True so the calints files are saved</span>

<span class="k">if</span> <span class="n">doimage2</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">rateints</span> <span class="ow">in</span> <span class="n">rateints_files</span><span class="p">:</span>
        <span class="n">calints_result</span> <span class="o">=</span> <span class="n">Image2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">rateints</span><span class="p">,</span>
                                             <span class="n">output_dir</span><span class="o">=</span><span class="n">image2_dir</span><span class="p">,</span>
                                             <span class="n">steps</span><span class="o">=</span><span class="n">image2dict</span><span class="p">,</span>
                                             <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping Image2 processing.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for Image2: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_image2</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Verify which pipeline steps were run:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doimage2</span><span class="p">:</span>
    <span class="c1"># Identify *_calints.fits files</span>
    <span class="n">calints_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image2_dir</span><span class="p">,</span> <span class="s1">&#39;*_calints.fits&#39;</span><span class="p">)))</span>
    <span class="c1"># Restrict to selected filter if applicable</span>
    <span class="n">calints_files</span> <span class="o">=</span> <span class="n">select_filter_files</span><span class="p">(</span><span class="n">calints_files</span><span class="p">,</span> <span class="n">use_filter</span><span class="p">)</span>

    <span class="c1"># Read in the first file as datamodel as an example</span>
    <span class="n">calints</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">calints_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Check which steps were run</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">calints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">cal_step</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check which reference files were used to calibrate the dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doimage2</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">calints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">calints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">calints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
<section id="ami3-pipeline">
<h1>7. AMI3 Pipeline<a class="headerlink" href="#ami3-pipeline" title="Permalink to this heading">#</a></h1>
<p>In the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_ami3.html">AMI3 stage of the pipeline</a>,
the target and reference star <code class="docutils literal notranslate"><span class="pre">*_calints.fits</span></code> files are analyzed to extract interferometric observables, and then the targets observables are normalized by those of the reference star to produce a final set of calibrated observables.</p>
<p>In order to run the AMI3 stage, an <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/associations/overview.html">Association</a> file
needs to be created to inform the pipeline which exposures should be treated as targets and which as reference stars.</p>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">AMI3</span></code> stage of the pipeline performs the following steps on NIRISS data:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/ami_analyze/description.html">ami_analyze</a> - fits a model to each integration of the input image and computes interferometric observables (fringe phases, amplitudes, and derived quantities).</p></li>
<li><p><a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/ami_normalize/index.html">ami_normalize</a> - normalizes the targets observables by the reference star observables.</p></li>
</ul>
<p>While a previous version of the AMI3 pipeline included an intermediate step to average together the observables from multiple exposures (<code class="docutils literal notranslate"><span class="pre">ami_average</span></code>), the step is not currently supported.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_ami3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="create-asdf-file">
<h2>Create ASDF File<a class="headerlink" href="#create-asdf-file" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ami_analyze</span></code> step has several <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/stable/jwst/ami_analyze/description.html">optional arguments</a>, some can be provided in an ASDF file containing a particular data tree. In here we will modify this file to provide an specific affine distortion matrix (<code class="docutils literal notranslate"><span class="pre">affine2d</span></code>).</p>
<p>For <code class="docutils literal notranslate"><span class="pre">affine2d</span></code> the default parameters from commissioning are accessed with a special string: commissioning. If <code class="docutils literal notranslate"><span class="pre">affine2d</span> <span class="pre">=</span> <span class="pre">None</span></code>, it will perform a search for the best-fit rotation only. To use a different affine distortion, such as one measured directly from the data or an ideal distortion, it must be specified in an ASDF file as shown here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example of writing an ASDF file specifying an affine distortion matrix to use</span>

<span class="c1"># Create an ASDF file</span>
<span class="n">asdf_affine2d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;affine2d_ideal.asdf&#39;</span><span class="p">)</span>

<span class="n">aff_tree</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mx&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>  <span class="c1"># dimensionless x-magnification</span>
            <span class="s1">&#39;my&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>  <span class="c1"># dimensionless y-magnification</span>
            <span class="s1">&#39;sx&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># dimensionless x shear</span>
            <span class="s1">&#39;sy&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># dimensionless y shear</span>
            <span class="s1">&#39;xo&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># x-offset in pupil space</span>
            <span class="s1">&#39;yo&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># y-offset in pupil space</span>
            <span class="s1">&#39;rotradccw&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asdf_affine2d</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">af</span> <span class="o">=</span> <span class="n">asdf</span><span class="o">.</span><span class="n">AsdfFile</span><span class="p">(</span><span class="n">aff_tree</span><span class="p">)</span>
    <span class="n">af</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    
<span class="n">af</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>An example of using the affine distortion ASDF file created above is shown below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the AMI3 pipeline should be configured</span>
<span class="c1"># Boilerplate dictionary setup</span>
<span class="n">ami3dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

<span class="c1"># Options for ami_analyze step</span>
<span class="c1">#ami3dict[&#39;ami_analyze&#39;][&#39;firstfew&#39;] = 5  # Analyze only the first 5 integrations to speed up demo</span>
<span class="c1">#ami3dict[&#39;ami_analyze&#39;][&#39;affine2d&#39;] = 11  # Increase oversampling of image plane fit (increases runtime)</span>
<span class="c1">#ami3dict[&#39;ami_analyze&#39;][&#39;bandpass&#39;] = &#39;myfile.asdf&#39;  # Provide a custom bandpass (e.g., from synphot)</span>
<span class="n">ami3dict</span><span class="p">[</span><span class="s1">&#39;ami_analyze&#39;</span><span class="p">][</span><span class="s1">&#39;affine2d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdf_affine2d</span>  <span class="c1"># Use the affine distortion ASDF file we created</span>
<span class="n">ami3dict</span><span class="p">[</span><span class="s1">&#39;ami_analyze&#39;</span><span class="p">][</span><span class="s1">&#39;save_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Turn on optional output results for display purposes</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped (example)</span>
<span class="c1">#ami3dict[&#39;ami_normalize&#39;][&#39;skip&#39;] = True</span>

<span class="c1"># Overrides for various reference files</span>
<span class="c1"># Files should be in the base local directory or provide full path</span>
<span class="c1">#ami3dict[&#39;ami_analyze&#39;][&#39;override_nrm&#39;] = &#39;mynrmfile.fits&#39;  # NRM mask geometry file</span>
</pre></div>
</div>
</div>
</div>
<p>Find and sort all of the input files, ensuring use of absolute paths</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># AMI3 takes the calints.fits files</span>
<span class="n">calints_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image2_dir</span><span class="p">,</span> <span class="s1">&#39;jw*calints.fits&#39;</span><span class="p">)))</span>
<span class="c1"># Restrict to selected filter if applicable</span>
<span class="n">calints_files</span> <span class="o">=</span> <span class="n">select_filter_files</span><span class="p">(</span><span class="n">calints_files</span><span class="p">,</span> <span class="n">use_filter</span><span class="p">)</span>
    
<span class="n">calints_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">calints</span><span class="p">)</span> <span class="k">for</span> <span class="n">calints</span> <span class="ow">in</span> <span class="n">calints_files</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calints_files</span><span class="p">))</span><span class="si">}</span><span class="s1"> science files to process&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-association-files">
<h2>Create Association Files<a class="headerlink" href="#create-association-files" title="Permalink to this heading">#</a></h2>
<p>An association file lists the exposures to calibrate together in <code class="docutils literal notranslate"><span class="pre">Stage</span> <span class="pre">3</span></code>
of the pipeline. Note that an association file is available for download
from MAST, with a filename of <code class="docutils literal notranslate"><span class="pre">*_asn.json</span></code>, though it may require additional manipulation for AMI.</p>
<p>Here we create association files for each pairing of input science and reference PSF exposures.
Note that the final output products will have a rootname that is specified by the <code class="docutils literal notranslate"><span class="pre">product_name</span></code>
in the association file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create Level 3 Associations</span>
<span class="k">if</span> <span class="n">doami3</span><span class="p">:</span>
    <span class="c1"># Separate inputs into science and PSF reference exposures</span>
    <span class="n">scifiles</span><span class="p">,</span> <span class="n">psffiles</span> <span class="o">=</span> <span class="n">split_scipsf_files</span><span class="p">(</span><span class="n">calints_files</span><span class="p">)</span>
    
    <span class="c1"># Make an association file for every valid science/psf file pair</span>
    <span class="k">for</span> <span class="n">sci</span> <span class="ow">in</span> <span class="n">scifiles</span><span class="p">:</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">sci</span><span class="p">)</span>
        <span class="n">thisfilter</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span>
        <span class="c1"># Potential PSF calibration files are those for which filter matches</span>
        <span class="n">psfoptions</span> <span class="o">=</span> <span class="n">select_filter_files</span><span class="p">(</span><span class="n">psffiles</span><span class="p">,</span> <span class="n">thisfilter</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">psf</span> <span class="ow">in</span> <span class="n">psfoptions</span><span class="p">:</span>
            <span class="c1"># Construct product name from the input headers</span>
            <span class="n">prodname</span> <span class="o">=</span> <span class="s1">&#39;ami3_&#39;</span> <span class="o">+</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TARGPROP&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ACT_ID&#39;</span><span class="p">]</span>
            <span class="n">prodname</span> <span class="o">=</span> <span class="n">prodname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    
            <span class="n">asn</span> <span class="o">=</span> <span class="n">asn_from_list</span><span class="o">.</span><span class="n">asn_from_list</span><span class="p">([</span><span class="n">sci</span><span class="p">],</span>
                                              <span class="n">rule</span><span class="o">=</span><span class="n">DMS_Level3_Base</span><span class="p">,</span>
                                              <span class="n">product_name</span><span class="o">=</span><span class="n">prodname</span><span class="p">)</span>
    
            <span class="c1"># Set the second observation as the psf reference star</span>
            <span class="n">asn</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">psf</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;psf&#39;</span><span class="p">})</span>
            <span class="n">asn</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;asn_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ami3&#39;</span>
            <span class="n">asn</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;program&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PROGRAM&#39;</span><span class="p">]</span>    
    
            <span class="c1"># Format association as .json file</span>
            <span class="n">asn_filename</span> <span class="o">=</span> <span class="n">prodname</span> <span class="o">+</span> <span class="s1">&#39;_asn.json&#39;</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">serialized</span> <span class="o">=</span> <span class="n">asn</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>

            <span class="c1"># Write out association file</span>
            <span class="n">association_ami3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="n">asn_filename</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">association_ami3</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span>

    <span class="c1"># List all associations            </span>
    <span class="n">all_asn</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;*_asn.json&#39;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Check that file paths have been correctly updated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open an ASN file as an example.</span>
<span class="k">if</span> <span class="n">doami3</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_asn</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">all_asn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_obj</span><span class="p">:</span>
            <span class="n">asnfile_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f_obj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_asn</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">all_asn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_obj</span><span class="p">:</span>
            <span class="n">asnfile_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f_obj</span><span class="p">)</span>
    <span class="n">expanded_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asnfile_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># &#39;expanded=True&#39; maps to &#39;indent&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">expanded_json</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-ami3-stage-of-the-pipeline">
<h2>Run AMI3 stage of the pipeline<a class="headerlink" href="#run-ami3-stage-of-the-pipeline" title="Permalink to this heading">#</a></h2>
<p>For the target and reference star exposures listed in the association file, the
<code class="docutils literal notranslate"><span class="pre">AMI3</span></code> stage of the pipeline will produce:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">*ami-oi.fits</span></code> files (one for the target, one for the reference star) from the <code class="docutils literal notranslate"><span class="pre">ami_analyze</span></code> step containing averaged interferometric observables</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">*aminorm-oi.fits</span></code> file from the <code class="docutils literal notranslate"><span class="pre">ami_normalize</span></code> step containing normalized interferometric observables</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">*ami-oi.fits</span></code> and <code class="docutils literal notranslate"><span class="pre">*aminorm-oi.fits</span></code> files adhere to the <a class="reference external" href="https://doi.org/10.1051/0004-6361/201526405">OIFITS2</a> format, which is a registered FITS standard for optical and infrared interferometry data.</p>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Stage 3</span>
<span class="k">if</span> <span class="n">doami3</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">asn</span> <span class="ow">in</span> <span class="n">all_asn</span><span class="p">:</span>
        <span class="n">ami3_result</span> <span class="o">=</span> <span class="n">Ami3Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">asn</span><span class="p">,</span>
                                        <span class="n">output_dir</span><span class="o">=</span><span class="n">ami3_dir</span><span class="p">,</span>
                                        <span class="n">steps</span><span class="o">=</span><span class="n">ami3dict</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping AMI3 processing&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for AMI3: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_ami3</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="verify-which-pipeline-steps-were-run">
<h2>Verify which pipeline steps were run<a class="headerlink" href="#verify-which-pipeline-steps-were-run" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doami3</span><span class="p">:</span>
    <span class="c1"># Identify *ami-oi.fits file and open as datamodel</span>
    <span class="n">ami_oi</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ami3_dir</span><span class="p">,</span> <span class="s2">&quot;*_ami-oi.fits&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ami_oi</span><span class="p">)</span> <span class="k">as</span> <span class="n">oi_f</span><span class="p">:</span>
        <span class="c1"># Check which steps were run</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">oi_f</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">cal_step</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check which reference files were used to calibrate the dataset</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doami3</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">oi_f</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">oi_f</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">oi_f</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="visualize-the-results">
<h1>8. Visualize the results<a class="headerlink" href="#visualize-the-results" title="Permalink to this heading">#</a></h1>
<section id="plot-interferometric-observables">
<h2>Plot interferometric observables<a class="headerlink" href="#plot-interferometric-observables" title="Permalink to this heading">#</a></h2>
<p>We will now plot the interferometric observables for the target, reference star, and normalized target.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a function for plotting observables</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_observables</span><span class="p">(</span><span class="n">ami_oimodel</span><span class="p">):</span>
    <span class="c1"># Read the observables from the datamodel</span>
    <span class="c1"># Squared visibilities and uncertainties</span>
    <span class="n">vis2</span> <span class="o">=</span> <span class="n">ami_oimodel</span><span class="o">.</span><span class="n">vis2</span><span class="p">[</span><span class="s2">&quot;VIS2DATA&quot;</span><span class="p">]</span>
    <span class="n">vis2_err</span> <span class="o">=</span> <span class="n">ami_oimodel</span><span class="o">.</span><span class="n">vis2</span><span class="p">[</span><span class="s2">&quot;VIS2ERR&quot;</span><span class="p">]</span>
    <span class="c1"># Closure phases and uncertainties</span>
    <span class="n">t3phi</span> <span class="o">=</span> <span class="n">ami_oimodel</span><span class="o">.</span><span class="n">t3</span><span class="p">[</span><span class="s2">&quot;T3PHI&quot;</span><span class="p">]</span>
    <span class="n">t3phi_err</span> <span class="o">=</span> <span class="n">ami_oimodel</span><span class="o">.</span><span class="n">t3</span><span class="p">[</span><span class="s2">&quot;T3PHIERR&quot;</span><span class="p">]</span>

    <span class="c1"># Construct baselines between the U and V coordinates of sub-apertures</span>
    <span class="n">baselines</span> <span class="o">=</span> <span class="p">(</span><span class="n">ami_oimodel</span><span class="o">.</span><span class="n">vis2</span><span class="p">[</span><span class="s1">&#39;UCOORD&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ami_oimodel</span><span class="o">.</span><span class="n">vis2</span><span class="p">[</span><span class="s1">&#39;VCOORD&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="c1"># Construct baselines between combinations of three sub-apertures</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">ami_oimodel</span><span class="o">.</span><span class="n">t3</span><span class="p">[</span><span class="s1">&#39;U1COORD&#39;</span><span class="p">]</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">ami_oimodel</span><span class="o">.</span><span class="n">t3</span><span class="p">[</span><span class="s1">&#39;U2COORD&#39;</span><span class="p">]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">ami_oimodel</span><span class="o">.</span><span class="n">t3</span><span class="p">[</span><span class="s1">&#39;V1COORD&#39;</span><span class="p">]</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">ami_oimodel</span><span class="o">.</span><span class="n">t3</span><span class="p">[</span><span class="s1">&#39;V2COORD&#39;</span><span class="p">]</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">u1</span> <span class="o">+</span> <span class="n">u2</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span>
    <span class="n">baselines_t3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u1</span><span class="p">)):</span>
        <span class="n">B1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">B2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">B3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u3</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v3</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Use longest baseline of the three for plotting</span>
        <span class="n">baselines_t3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">B1</span><span class="p">,</span> <span class="n">B2</span><span class="p">,</span> <span class="n">B3</span><span class="p">]))</span> 
    <span class="n">baselines_t3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">baselines_t3</span><span class="p">)</span>

    <span class="c1"># Plot closure phases, squared visibilities against their baselines </span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">baselines_t3</span><span class="p">,</span> <span class="n">t3phi</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">t3phi_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;go&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">baselines</span><span class="p">,</span> <span class="n">vis2</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">vis2_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;go&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$B_</span><span class="si">{max}</span><span class="s2">$ [m]&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Closure phase [deg]&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Closure Phase&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Squared Visibility&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$B_</span><span class="si">{max}</span><span class="s2">$ [m]&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Squared Visibility&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">ami_oimodel</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span> 
</pre></div>
</div>
</div>
</div>
<p>First well look at the target and reference stars squared visibilities and closure phases. We plot the squared visibilities against their corresponding baselines (units of meters projected back to the primary meter). We plot the closure phases against the longest of the three baselines that forms the closure triangle whose phases were summed to calculate the closure phase.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="c1"># Get the first target ami-oi.fits file</span>
    <span class="n">oi_scifile</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ami3_dir</span><span class="p">,</span> <span class="s2">&quot;jw*_ami-oi.fits&quot;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oi_scifile</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">oi_scifile</span> <span class="o">=</span> <span class="n">oi_scifile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="c1"># Get the first PSF reference ami-oi fits file</span>
    <span class="n">oi_psffile</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ami3_dir</span><span class="p">,</span> <span class="s2">&quot;jw*psf-ami-oi.fits&quot;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oi_psffile</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">oi_psffile</span> <span class="o">=</span> <span class="n">oi_psffile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Open them as datamodels</span>
    <span class="n">amioi_targ</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">oi_scifile</span><span class="p">)</span>
    <span class="n">amioi_ref</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">oi_psffile</span><span class="p">)</span>

    <span class="c1"># Plot the observables</span>
    <span class="n">plot_observables</span><span class="p">(</span><span class="n">amioi_targ</span><span class="p">)</span>
    <span class="n">plot_observables</span><span class="p">(</span><span class="n">amioi_ref</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The top two scatter plots show the observables from the target observation, and the lower two show the observables from the reference star. For a perfect point source observation at single wavelength, we would expect to recover closure phases of zero and squared visibilites of unity.</p>
<p>Since the closure phases are sensitive to asymmetries in the source brightness distribution, we can tell from the larger scatter of the target that it is likely not a point source; i.e, there is a faint companion. On the other hand, the reference star has closure phases with a much smaller scatter around zero. The squared visibilities of both decrease at longer wavelengths due to an effect called bandpass smearing. We expect that calibrating the target by the reference star should correct for this, as well as other systematics.</p>
<p>Now we will plot the final calibrated data product; the target normalized by the reference star. The reference star closure phases are subtracted from the target closure phases, and the target squared visibilities are divided by the reference star squared visibilities.</p>
<p>Further scientific analysis on these calibrated OIFITS files can be done with community-developed analysis software like <a class="reference external" href="https://github.com/amerand/CANDID">CANDID</a> (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2015A%26A...579A..68G/abstract">Gallenne et al. 2015</a>) or <a class="reference external" href="https://github.com/kammerje/fouriever">Fouriever</a> to extract binary parameters, or an image reconstruction code like <a class="reference external" href="https://github.com/fabienbaron/squeeze">SQUEEZE</a> (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2010SPIE.7734E..2IB/abstract">Baron et al. 2010</a>) or BSMEM (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1984MNRAS.211..111S/abstract">Skilling &amp; Bryan 1984</a>, <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1994IAUS..158...91B/abstract">Buscher 1994</a>, <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2008SPIE.7013E..3XB/abstract">Baron &amp; Young 2008</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="c1"># Identify calibrated *_aminorm-oi.fits file and open as datamodel</span>
    <span class="n">abdor_oifits</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ami3_dir</span><span class="p">,</span> <span class="s2">&quot;*_aminorm-oi.fits&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">amioi_norm</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">abdor_oifits</span><span class="p">)</span>

    <span class="c1"># Plot the observables</span>
    <span class="n">plot_observables</span><span class="p">(</span><span class="n">amioi_norm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="display-the-best-fit-model">
<h2>Display the best-fit model<a class="headerlink" href="#display-the-best-fit-model" title="Permalink to this heading">#</a></h2>
<p>We can also look at the cleaned data, model, and residual images that are saved in the auxiliary <code class="docutils literal notranslate"><span class="pre">*amilg.fits</span></code> data products:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="c1"># Find the data files</span>
    <span class="n">amilg</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ami3_dir</span><span class="p">,</span> <span class="s1">&#39;*amilg.fits&#39;</span><span class="p">)))</span>

    <span class="c1"># Open the first one as an AmiLGModel</span>
    <span class="n">firstfile</span> <span class="o">=</span> <span class="n">amilg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">amilgmodel</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">firstfile</span><span class="p">)</span>

    <span class="c1"># Plot the data, model, residual</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">amilgmodel</span><span class="o">.</span><span class="n">norm_centered_image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                          <span class="n">interval</span><span class="o">=</span><span class="n">MinMaxInterval</span><span class="p">(),</span> 
                          <span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normalized Data&#39;</span><span class="p">)</span>
    <span class="n">im1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">amilgmodel</span><span class="o">.</span><span class="n">norm_centered_image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normalized Model&#39;</span><span class="p">)</span>
    <span class="n">im2</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">amilgmodel</span><span class="o">.</span><span class="n">norm_fit_image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normalized Residual (Data-Model)&#39;</span><span class="p">)</span>
    <span class="n">im3</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">amilgmodel</span><span class="o">.</span><span class="n">norm_resid_image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="p">[</span><span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">,</span> <span class="n">im3</span><span class="p">]:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">.95</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">.05</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">firstfile</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Each image has been normalized by the peak pixel value of the data, and the data and model are displayed on a square root stretch to emphasize the fainter features. By looking at the residual (data - model) image, we can see that the model is a good fit to the data. This model achieves better contrast than ground-based NRM, but has not reached the binary contrast science requirements of AMI. The faint vertical striping in the background of the residual image is 1/f noise (flicker noise), which is an active area of improvement for the NIRISS/AMI team, as is the best method of correcting for charge migration.</p>
<hr style="border:1px solid gray"> </hr><a class="reference internal image-reference" href="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_footer.png"><img alt="stsci_logo" src="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_footer.png" style="width: 200px;" /></a>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jwst-pipeline-notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRISS/AMI"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../../NIRCAM/Imaging/JWPipeNB-nircam-imaging.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">NIRCam Imaging Pipeline Notebook</p>
      </div>
    </a>
    <a class="right-next"
       href="../Imaging/JWPipeNB-niriss-imaging.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">NIRISS Imaging Pipeline Notebook</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">NIRISS AMI Pipeline Notebook</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">1. Configuration</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-dependencies-and-parameters">Install dependencies and parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-crds-context-and-server">Set CRDS context and server</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#package-imports">2. Package Imports</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-convenience-functions">Define convenience functions</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-mode-setup-ignore-if-not-using-demo-data">3. Demo Mode Setup (ignore if not using demo data)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-setup">4. Directory Setup</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#detector1-pipeline">5. Detector1 Pipeline</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-data">Exploring the data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#image2-pipeline">6. Image2 Pipeline</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ami3-pipeline">7. AMI3 Pipeline</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-asdf-file">Create ASDF File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-association-files">Create Association Files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-ami3-stage-of-the-pipeline">Run AMI3 stage of the pipeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-which-pipeline-steps-were-run">Verify which pipeline steps were run</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-results">8. Visualize the results</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-interferometric-observables">Plot interferometric observables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#display-the-best-fit-model">Display the best-fit model</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>