

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>NIRISS SOSS Pipeline Notebook &#8212; JWST Pipeline Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRISS/SOSS/JWPipeNB-niriss-soss';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="NIRISS Wide Field Slitless Spectroscopy (WFSS) Pipeline Notebook" href="../WFSS/JWPipeNB-niriss-wfss.html" />
    <link rel="prev" title="NIRISS Imaging Pipeline Notebook" href="../Imaging/JWPipeNB-niriss-imaging.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="JWST Pipeline Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="JWST Pipeline Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../README.html">
                    JWST Pipeline Notebooks
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/Coronagraphy/JWPipeNB-MIRI-Coron.html">MIRI Coronagraphy Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/Imaging/JWPipeNB-MIRI-imaging.html">MIRI Imaging Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/Imaging-TSO/JWPipeNB-MIRI-imaging-TSO.html">MIRI Imaging TSO Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/LRS-slit/JWPipeNB-MIRI-LRS-slit.html">MIRI LRS Slit Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/LRS-slitless-TSO/JWPipeNB-MIRI-LRS-slitless-TSO.html">MIRI LRS Slitless TSO Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS/JWPipeNB-MIRI-MRS.html">MIRI MRS Notebook</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCAM</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCAM/Coronagraphy/JWPipeNB-nircam-coronagraphy.html">NIRCam Coronagraphy Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCAM/Imaging/JWPipeNB-nircam-imaging.html">NIRCam Imaging Notebook</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../AMI/JWPipeNB-niriss-ami.html">NIRISS AMI Pipeline Notebook</a></li>









<li class="toctree-l1"><a class="reference internal" href="../Imaging/JWPipeNB-niriss-imaging.html">NIRISS Imaging Pipeline Notebook</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">NIRISS Single Object Slitless Spectroscopy Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WFSS/JWPipeNB-niriss-wfss.html">NIRISS Wide Field Slitless Spectroscopy (WFSS) Pipeline Notebook</a></li>










</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSPEC/BOTS/JWPipeNB-NIRSpec-BOTS.html">NIRSpec BOTS Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSPEC/FSlit/JWPipeNB-NIRSpec-FS.html">NIRSpec Fixed Slit Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSPEC/IFU/JWPipeNB-NIRSpec-IFU.html">NIRSpec IFU Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSPEC/MOS/JWPipeNB-NIRSpec-MOS.html">NIRSpec MOS Notebook</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jwst-pipeline-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jwst-pipeline-notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRISS/SOSS/JWPipeNB-niriss-soss.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRISS/SOSS/JWPipeNB-niriss-soss.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>NIRISS SOSS Pipeline Notebook</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">1. Configuration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-dependencies-and-parameters">Install dependencies and parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-crds-context-and-server">Set CRDS context and server</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#package-imports">2. Package Imports</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-convenience-functions">Define convenience functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-mode-setup-ignore-if-not-using-demo-data">3. Demo Mode Setup (ignore if not using demo data)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-setup">4. Directory Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#detector1-pipeline">5. Detector1 Pipeline</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-data">Exploring the data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spec2-pipeline">6. Spec2 Pipeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tso3-pipeline">7. TSO3 Pipeline</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-association-files">Create Association Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-tso3-stage-of-the-pipeline">Run TSO3 stage of the pipeline</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-which-pipeline-steps-were-run">Verify which pipeline steps were run</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-results">8. Visualize the results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-plotting-functions">Define plotting functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gather-the-data">Gather the data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-target-acquisition-images">Examine Target Acquisition images</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-detector1-products">Examine Detector1 products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-spec2-products">Examine Spec2 products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-tso3-products">Examine TSO3 products</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <a class="reference internal image-reference" href="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_header.png"><img alt="stsci_logo" src="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_header.png" style="width: 900px;" /></a>
<section id="niriss-soss-pipeline-notebook">
<h1>NIRISS SOSS Pipeline Notebook<a class="headerlink" href="#niriss-soss-pipeline-notebook" title="Permalink to this heading">#</a></h1>
<p><strong>Authors</strong>: R. Cooper, A. Carter, N. Espinoza, T. Baines<br>
<strong>Last Updated</strong>: November 7, 2025<br>
<strong>Pipeline Version</strong>: 1.20.2 (Build 12.1)</p>
<p><strong>Purpose</strong>:<br>
This notebook provides a framework for processing Near-Infrared
Imager and Slitless Spectrograph (NIRISS) Single Object Slitless Spectrograph (SOSS) data through all
three James Webb Space Telescope (JWST) pipeline stages.  Data is assumed
to be located in one observation folder according to paths set up below.
It should not be necessary to edit any cells other than in the
<span class="xref myst">Configuration</span> section unless modifying the standard
pipeline processing options.</p>
<p><strong>Data</strong>:<br>
This notebook uses an example dataset from Early Release Observation (ER0) <a class="reference external" href="https://www.stsci.edu/jwst/science-execution/program-information">Program
2734</a> (PI: K. Pontoppidan).
This program consists of time series observations (TSO) of confirmed exoplanets HAT-P-18b and WASP-96b,
intended to demonstrate the power and precision of the JWST TSO modes. In this notebook, we will reduce the
NIRISS SOSS observations of transiting exoplanet WASP-96b.</p>
<p>Example input data to use will be downloaded automatically unless
disabled (i.e., to use local files instead).</p>
<p><strong>JWST pipeline version and CRDS context</strong>:<br>
This notebook was written for the above-specified pipeline version and associated
build context for this version of the JWST Calibration Pipeline. Information about
this and other contexts can be found in the JWST Calibration Reference Data System
(CRDS <a class="reference external" href="https://jwst-crds.stsci.edu/">server</a>). If you use different pipeline versions,
please refer to the table <a class="reference external" href="https://jwst-crds.stsci.edu/display_build_contexts/">here</a>
to determine what context to use. To learn more about the differences for the pipeline,
read the relevant
<a class="reference external" href="https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline/jwst-operations-pipeline-build-information#references">documentation</a>.<br></p>
<p>Please note that pipeline software development is a continuous process, so results
in some cases may be slightly different if a subsequent version is used. <strong>For optimal
results, users are strongly encouraged to reprocess their data using the most recent
pipeline version and
<a class="reference external" href="https://jwst-crds.stsci.edu/display_build_contexts/">associated CRDS context</a>,
taking advantage of bug fixes and algorithm improvements.</strong>
Any <a class="reference external" href="https://jwst-docs.stsci.edu/known-issues-with-jwst-data/niriss-known-issues/niriss-soss-known-issues">known issues</a> for this build are noted in the notebook.<BR></p>
<p><strong>Visualization</strong>:<br>
This notebook uses the <code class="docutils literal notranslate"><span class="pre">batman</span></code> package (Pypi batman-package) for analysis of the SOSS data.
Some versions of this package may be incompatible with certain python versions and CPU architectures.
If issues are encountered with this package it can be disabled in the ‘Package Imports’ section below;
the function to make the final data product visualization must then be called without the <code class="docutils literal notranslate"><span class="pre">modelparams</span></code> argument.</p>
<p><strong>Updates</strong>:<br>
This notebook is regularly updated as improvements are made to the
pipeline. Find the most up to date version of this notebook at:
https://github.com/spacetelescope/jwst-pipeline-notebooks/</p>
<p><strong>Recent Changes</strong>:<br>
November 07, 2025: original notebook released<br></p>
<hr style="border:1px solid gray"> </hr><section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><span class="xref myst">Configuration</span></p></li>
<li><p><span class="xref myst">Package Imports</span></p></li>
<li><p><span class="xref myst">Demo Mode Setup (ignore if not using demo data)</span></p></li>
<li><p><span class="xref myst">Directory Setup</span></p></li>
<li><p><span class="xref myst">Detector 1 Pipeline</span></p></li>
<li><p><span class="xref myst">Spec2 Pipeline</span></p></li>
<li><p><span class="xref myst">TSO3 Pipeline</span></p></li>
<li><p><span class="xref myst">Visualize the data</span></p></li>
</ol>
<hr style="border:1px solid gray"> </hr></section>
<section id="configuration">
<h2>1. Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<section id="install-dependencies-and-parameters">
<h3>Install dependencies and parameters<a class="headerlink" href="#install-dependencies-and-parameters" title="Permalink to this heading">#</a></h3>
<p>To make sure that the pipeline version is compatabile with the steps
discussed below and the required dependencies and packages are installed,
you can create a fresh conda environment and install the provided
<code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">niriss_soss_pipeline</span> <span class="n">python</span><span class="o">=</span><span class="mf">3.13</span>
<span class="n">conda</span> <span class="n">activate</span> <span class="n">niriss_soss_pipeline</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>Set the basic parameters to use with this notebook. These will affect
what data is used, where data is located (if already in disk), and
pipeline modules run in this data. The list of parameters are:</p>
<ul class="simple">
<li><p>demo_mode</p></li>
<li><p>directories with data</p></li>
<li><p>pipeline modules</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic import necessary for configuration</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
Note that <code>demo_mode</code> must be set appropriately below.
</div>
<p>Set <code>demo_mode = True </code> to run in demonstration mode. In this
mode this notebook will download example data from the Barbara A.
Mikulski Archive for Space Telescopes (<a class="reference external" href="https://archive.stsci.edu/">MAST</a>)
and process it through the
pipeline. This will all happen in a local directory unless modified
in <span class="xref myst">Section 3</span>
below.</p>
<p>Set <code>demo_mode = False</code> if you want to process your own data
that has already been downloaded and provide the location of the data.<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set parameters for demo_mode and processing steps.</span>

<span class="c1"># -----------------------------Demo Mode---------------------------------</span>
<span class="n">demo_mode</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running in demonstration mode using online example data!&#39;</span><span class="p">)</span>

<span class="c1"># --------------------------User Mode Directories------------------------</span>
<span class="c1"># If demo_mode = False, look for user data in these paths</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="c1"># Set directory paths for processing specific data; these will need</span>
    <span class="c1"># to be changed to your local directory setup (below are given as</span>
    <span class="c1"># examples)</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Point to location of science observation data.</span>
    <span class="c1"># Assumes uncalibrated data in sci_dir/uncal/ and results in stage1,</span>
    <span class="c1"># stage2, stage3 directories</span>
    <span class="n">sci_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;JWSTData/PID_2734/&#39;</span><span class="p">)</span>

<span class="c1"># --------------------------Set Processing Steps--------------------------</span>
<span class="c1"># Individual pipeline stages can be turned on/off here.  Note that a later</span>
<span class="c1"># stage won&#39;t be able to run unless data products have already been</span>
<span class="c1"># produced from the prior stage.</span>

<span class="c1"># Science processing</span>
<span class="n">dodet1</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_detector1</span>
<span class="n">dospec2</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_spec2</span>
<span class="n">dotso3</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_tso3</span>
<span class="n">doviz</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Visualize calwebb_tso3 output</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-crds-context-and-server">
<h3>Set CRDS context and server<a class="headerlink" href="#set-crds-context-and-server" title="Permalink to this heading">#</a></h3>
<p>Before importing <code>CRDS</code> and <code>JWST</code> modules, we need
to configure our environment. This includes defining a CRDS cache
directory in which to keep the reference files that will be used by the
calibration pipeline.</p>
<p>If the root directory for the local CRDS cache directory has not been set
already, it will be set to create one in the home directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------------------------Set CRDS context and paths----------------------</span>
<span class="c1"># Each version of the calibration pipeline is associated with a specific CRDS</span>
<span class="c1"># context file. The pipeline will select the appropriate context file behind</span>
<span class="c1"># the scenes while running. However, if you wish to override the default context</span>
<span class="c1"># file and run the pipeline with a different context, you can set that using</span>
<span class="c1"># the CRDS_CONTEXT environment variable. Here we show how this is done,</span>
<span class="c1"># although we leave the line commented out in order to use the default context.</span>
<span class="c1"># If you wish to specify a different context, uncomment the line below.</span>
<span class="c1">#os.environ[&#39;CRDS_CONTEXT&#39;] = &#39;jwst_1464.pmap&#39;  # CRDS context for 1.20.2</span>

<span class="c1"># Check whether the local CRDS cache directory has been set.</span>
<span class="c1"># If not, set it to the user home directory</span>
<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;crds&#39;</span><span class="p">)</span>
    
<span class="c1"># Check whether the CRDS server URL has been set.  If not, set it.</span>
<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://jwst-crds.stsci.edu&#39;</span>

<span class="c1"># Echo CRDS path in use</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRDS local filepath: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRDS file server: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="package-imports">
<h2>2. Package Imports<a class="headerlink" href="#package-imports" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the entire available screen width for this notebook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;style&gt;.container { width:95% !important; }&lt;/style&gt;&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic system utilities for interacting with files</span>
<span class="c1"># ----------------------General Imports------------------------------------</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># Numpy for calculations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Pandas for loading data into tables</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># Astroquery for downloading demo files</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Observations</span>

<span class="c1"># For visualizing data</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">ManualInterval</span><span class="p">,</span> <span class="n">LogStretch</span><span class="p">,</span>
                                   <span class="n">ImageNormalize</span><span class="p">,</span> <span class="n">simple_norm</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">batman</span> <span class="c1"># Transit modeling</span>

<span class="c1"># For file manipulation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>

<span class="c1"># For JWST calibration pipeline</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwst</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">crds</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Detector1Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spec2Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tso3Pipeline</span>

<span class="c1"># JWST pipeline utilities</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst</span><span class="w"> </span><span class="kn">import</span> <span class="n">datamodels</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.associations</span><span class="w"> </span><span class="kn">import</span> <span class="n">asn_from_list</span>  <span class="c1"># Tools for creating association files</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.associations.lib.rules_level3_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">DMS_Level3_Base</span>  <span class="c1"># Definition of a Lvl3 association file</span>

<span class="c1"># Echo pipeline version and CRDS context in use</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JWST Calibration Pipeline Version: </span><span class="si">{</span><span class="n">jwst</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using CRDS Context: </span><span class="si">{</span><span class="n">crds</span><span class="o">.</span><span class="n">get_context_name</span><span class="p">(</span><span class="s1">&#39;jwst&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="define-convenience-functions">
<h3>Define convenience functions<a class="headerlink" href="#define-convenience-functions" title="Permalink to this heading">#</a></h3>
<p>These functions are used within the notebook and assist with selecting certain kinds of input data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sort files into types: TA, spectrum, and F277W</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sort_files</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="n">tafiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scifiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">f277wfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">exptype</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;EXP_TYPE&#39;</span><span class="p">)</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;FILTER&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">exptype</span> <span class="o">==</span> <span class="s1">&#39;NIS_TACQ&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">exptype</span> <span class="o">==</span> <span class="s1">&#39;NIS_TACONFIRM&#39;</span><span class="p">)):</span>
            <span class="n">tafiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">exptype</span> <span class="o">==</span> <span class="s1">&#39;NIS_SOSS&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filt</span> <span class="o">==</span> <span class="s1">&#39;CLEAR&#39;</span><span class="p">)):</span>
            <span class="n">scifiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">exptype</span> <span class="o">==</span> <span class="s1">&#39;NIS_SOSS&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filt</span> <span class="o">==</span> <span class="s1">&#39;F277W&#39;</span><span class="p">)):</span>
            <span class="n">f277wfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tafiles</span><span class="p">,</span> <span class="n">scifiles</span><span class="p">,</span> <span class="n">f277wfiles</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start a timer to keep track of runtime</span>
<span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="demo-mode-setup-ignore-if-not-using-demo-data">
<h2>3. Demo Mode Setup (ignore if not using demo data)<a class="headerlink" href="#demo-mode-setup-ignore-if-not-using-demo-data" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<p>If running in demonstration mode, set up the program information to
retrieve the uncalibrated data automatically from MAST using
<a class="reference external" href="https://astroquery.readthedocs.io/en/latest/mast/mast.html">astroquery</a>.
MAST has a dedicated service for JWST data retrieval, so the archive can
be searched by instrument keywords rather than just filenames or proposal IDs.<br></p>
<p>The list of searchable keywords for filtered JWST MAST queries
is <a class="reference external" href="https://mast.stsci.edu/api/v0/_jwst_inst_keywd.html">here</a>.<br></p>
<p>For this notebook, we will examine a single TSO of the target, which uses the GR700XD/CLEAR grating/filter combination.
Note that the TSO data are typically split into multiple files to faciliate data processing; for more information see the documentation about <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/file_naming.html#segmented-files">Segmented Products</a>.</p>
<p>We will start with the uncalibrated data products. The files we are interested in are named
<code class="docutils literal notranslate"><span class="pre">jw02734002001_04101_00001-segNNN_nis_uncal.fits</span></code>, where <em>NNN</em> refers to the
segment number.</p>
<p>More information about the JWST file naming conventions can be found at:
https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/file_naming.html</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the program information and paths for demo program</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running in demonstration mode and will download example data from MAST!&#39;</span><span class="p">)</span>
    
    <span class="c1"># --------------Program and observation information--------------</span>
    <span class="n">program</span> <span class="o">=</span> <span class="s1">&#39;02734&#39;</span>
    <span class="n">instr</span> <span class="o">=</span> <span class="s1">&#39;NIRISS/SOSS&#39;</span>
    <span class="n">filt_pupil</span> <span class="o">=</span> <span class="s1">&#39;CLEAR;GR700XD&#39;</span>
    <span class="n">targname</span> <span class="o">=</span> <span class="s1">&#39;WASP-96&#39;</span>

    <span class="c1"># --------------Program and observation directories--------------</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;nis_soss_demo_data&#39;</span><span class="p">)</span>
    <span class="n">sci_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;PID_2734&#39;</span><span class="p">)</span>
    <span class="n">uncal_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;uncal&#39;</span><span class="p">)</span>  <span class="c1"># Uncalibrated pipeline inputs should be here</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">)</span>

    <span class="c1"># Create directory if it does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Identify list of science (SCI) uncalibrated files associated with visits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obtain a list of observation IDs for the specified demo program</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="c1"># Science data</span>
    <span class="n">sci_obs_id_table</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">instrument_name</span><span class="o">=</span><span class="p">[</span><span class="n">instr</span><span class="p">],</span>
                                                   <span class="n">proposal_id</span><span class="o">=</span><span class="p">[</span><span class="n">program</span><span class="p">],</span>
                                                   <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">filt_pupil</span><span class="p">],</span>  <span class="c1"># Data for specific filter/pupil</span>
                                                   <span class="n">obs_id</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jw&#39;</span> <span class="o">+</span> <span class="n">program</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">],</span>
                                                   <span class="n">target_name</span><span class="o">=</span><span class="n">targname</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn the list of visits into a list of uncalibrated data files</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="c1"># Define types of files to select</span>
    <span class="n">file_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uncal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;product_type&#39;</span><span class="p">:</span> <span class="s1">&#39;SCIENCE&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">:</span> <span class="s1">&#39;UNCAL&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;calib_level&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]}}</span>

    <span class="c1"># Science files</span>
    <span class="n">sci_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop over visits identifying uncalibrated files that are associated</span>
    <span class="c1"># with them</span>
    <span class="k">for</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sci_obs_id_table</span><span class="p">):</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">exposure</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filetype</span><span class="p">,</span> <span class="n">query_dict</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">filtered_products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">productType</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;product_type&#39;</span><span class="p">],</span>
                                                             <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">],</span>
                                                             <span class="n">calib_level</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;calib_level&#39;</span><span class="p">])</span>
            <span class="n">sci_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filtered_products</span><span class="p">[</span><span class="s1">&#39;dataURI&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Science files selected for downloading: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sci_files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Download all the uncal files and place them into the appropriate
directories.</p>
<div class="alert alert-block alert-warning">
Warning: If this notebook is halted during this step the downloaded file
may be incomplete, and cause crashes later on!
</div><div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">sci_files</span><span class="p">:</span>
        <span class="n">sci_manifest</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                                  <span class="n">local_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
<section id="directory-setup">
<h2>4. Directory Setup<a class="headerlink" href="#directory-setup" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<p>Set up detailed paths to input/output stages here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define output subdirectories to keep science data products organized</span>
<span class="c1"># -----------------------------Science Directories------------------------------</span>
<span class="n">uncal_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;uncal&#39;</span><span class="p">)</span>  <span class="c1"># Uncalibrated pipeline inputs should be here</span>
<span class="n">det1_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage1&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_detector1 pipeline outputs will go here</span>
<span class="n">spec2_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage2&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_spec2 pipeline outputs will go here</span>
<span class="n">tso3_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage3&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_tso3 pipeline outputs will go here</span>

<span class="c1"># We need to check that the desired output directories exist, and if not create them</span>
<span class="c1"># Ensure filepaths for input data exist</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">spec2_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">spec2_dir</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tso3_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tso3_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Print the exposure parameters of all potential input files:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uncal_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">,</span> <span class="s1">&#39;*_uncal.fits&#39;</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">uncal_files</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="c1"># print file name</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># Print out exposure info</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instrument: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filter: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pupil: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">pupil</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exposure type: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of integrations: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">nints</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">nints</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Integration range: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">integration_start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">integration_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exposure start time (UTC): </span><span class="si">{</span><span class="n">Time</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fits</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of groups: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">ngroups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Readout pattern: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">readpatt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Since this is a NIRISS SOSS observation, the first four files are target aquisition (TA) exposures.
Target acquisition is performed in a 64x64 pixel subarray before the target is moved
to its position in the science subarray. The TA exposures have exposure type <code class="docutils literal notranslate"><span class="pre">NIS_TACQ</span></code> or <code class="docutils literal notranslate"><span class="pre">NIS_TACONFIRM</span></code> and use the F480M filter.
These exposures, particularly the final confirmation image, can be helpful for diagnosing potential problems with the data.
For more information about the SOSS TA procedure, see the <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-imager-and-slitless-spectrograph/niriss-operations/niriss-target-acquisition">NIRISS TA documentation</a>.</p>
<p>The following three exposures are our time series observation, split into three segments: <code class="docutils literal notranslate"><span class="pre">seg001</span></code> through <code class="docutils literal notranslate"><span class="pre">seg003</span></code> in the filenames. These exposures use the CLEAR/GR700XD filter/pupil combination and consist of 280 integrations in total, each composed of 14 groups up the ramp, corresponding to a total exposure time of 6.41 hours.
Each exposure uses the <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-imager-and-slitless-spectrograph/niriss-instrumentation/niriss-detector-overview/niriss-detector-readout-patterns"><code class="docutils literal notranslate"><span class="pre">NISRAPID</span></code> readout pattern</a>.</p>
<p>The final exposure uses the F277W filter and was obtained because it is useful for masking order-zero sources and to isolate the first spectral order in the $2.4 \ \mu m-2.8 \ \mu m$
wavelength range, where they overlap significantly in the CLEAR exposures. We will process the F277W exposure through stage 1 in this notebook, but the background subtraction step in the second stage does not currently work with these exposures.</p>
<p>For more information about how JWST exposures are defined by up-the-ramp sampling, see the
<a class="reference external" href="https://jwst-docs.stsci.edu/understanding-exposure-times">Understanding Exposure Times JDox article</a>.</p>
<p>In this notebook, we will focus on processing the CLEAR/GR700XD exposures (though we will also process the single F277W exposure through Stage 1), so we can update the list of uncalibrated files to remove the TA exposures:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
<section id="detector1-pipeline">
<h2>5. Detector1 Pipeline<a class="headerlink" href="#detector1-pipeline" title="Permalink to this heading">#</a></h2>
<p>Run the data through the
<a class="reference external" href="https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline-overview/stages-of-jwst-data-processing/calwebb_detector1">Detector1</a>
stage of the pipeline to apply detector level calibrations and create a
countrate data product where slopes are fitted to the integration ramps.
These <code class="docutils literal notranslate"><span class="pre">_rateints.fits</span></code> products are 3D (nintegrations x nrows x ncols)
and contain the fitted ramp slopes for each integration.
2D countrate data products (<code class="docutils literal notranslate"><span class="pre">_rate.fits</span></code>) are also
created (nrows x ncols) which have been averaged over all
integrations.</p>
<p>The following Detector1 steps are available for NIRISS SOSS:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">group_scale</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dq_init</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">saturation</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">superbias</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refpix</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">linearity</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dark_current</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jump</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clean_flicker_noise</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ramp_fit</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gain_scale</span></code></p></li>
</ol>
<p>By default, these Detector1 steps are currently skipped for NIRISS SOSS exposures: <code class="docutils literal notranslate"><span class="pre">group_scale</span></code>, <code class="docutils literal notranslate"><span class="pre">clean_flicker_noise</span></code>, and <code class="docutils literal notranslate"><span class="pre">gain_scale</span></code>.</p>
<p>Each observing mode of JWST has different requirements when it comes to correcting for detector effects.
The <code class="docutils literal notranslate"><span class="pre">clean_flicker_noise</span></code> step was designed to remove 1/f noise from calibrated ramp images, but SOSS
users have found its performance insufficient due to the lack of non-illuminated
background pixels in the SOSS subarrays. A more rigorous group-level subtraction is likely needed, and is currently in development by the SOSS team.
By default, this step is currently skipped.</p>
<p>It is also unclear whether TSO science benefits from the dark current step in its current implementation.
In the following example we leave the step on, but it can easily be turned off as shown.</p>
<p>For more information about each step and a full list of step arguments, please refer to the official documentation on <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_detector1.html">ReadtheDocs</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the Detector1 pipeline should be configured</span>

<span class="c1"># Boilerplate dictionary setup</span>
<span class="n">det1dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

<span class="c1"># Step names are copied here for reference</span>
<span class="n">det1_steps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group_scale&#39;</span><span class="p">,</span> <span class="s1">&#39;dq_init&#39;</span><span class="p">,</span> <span class="s1">&#39;saturation&#39;</span><span class="p">,</span> <span class="s1">&#39;superbias&#39;</span><span class="p">,</span> <span class="s1">&#39;refpix&#39;</span><span class="p">,</span>
              <span class="s1">&#39;linearity&#39;</span><span class="p">,</span> <span class="s1">&#39;dark_current&#39;</span><span class="p">,</span> <span class="s1">&#39;jump&#39;</span><span class="p">,</span> <span class="s1">&#39;clean_flicker_noise&#39;</span><span class="p">,</span>
              <span class="s1">&#39;ramp_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;gain_scale&#39;</span><span class="p">]</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped</span>
<span class="c1"># Optionally, skip the dark step</span>
<span class="c1"># det1dict[&#39;dark_current&#39;][&#39;skip&#39;] = True</span>

<span class="c1"># Overrides for various reference files</span>
<span class="c1"># Files should be in the base local directory or provide full path</span>
<span class="c1">#det1dict[&#39;dq_init&#39;][&#39;override_mask&#39;] = &#39;myfile.fits&#39;  # Bad pixel mask</span>
<span class="c1">#det1dict[&#39;saturation&#39;][&#39;override_saturation&#39;] = &#39;myfile.fits&#39;  # Saturation</span>
<span class="c1">#det1dict[&#39;linearity&#39;][&#39;override_linearity&#39;] = &#39;myfile.fits&#39;  # Linearity</span>
<span class="c1">#det1dict[&#39;dark_current&#39;][&#39;override_dark&#39;] = &#39;myfile.fits&#39;  # Dark current subtraction</span>
<span class="c1">#det1dict[&#39;jump&#39;][&#39;override_gain&#39;] = &#39;myfile.fits&#39;  # Gain used by jump step</span>
<span class="c1">#det1dict[&#39;ramp_fit&#39;][&#39;override_gain&#39;] = &#39;myfile.fits&#39;  # Gain used by ramp fitting step</span>
<span class="c1">#det1dict[&#39;jump&#39;][&#39;override_readnoise&#39;] = &#39;myfile.fits&#39;  # Read noise used by jump step</span>
<span class="c1">#det1dict[&#39;ramp_fit&#39;][&#39;override_readnoise&#39;] = &#39;myfile.fits&#39;  # Read noise used by ramp fitting step</span>

<span class="c1"># Turn on multi-core processing (off by default). Choose what fraction of cores to use (quarter, half, or all)</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">][</span><span class="s1">&#39;maximum_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;half&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Run Detector1 stage of pipeline:</p>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Detector1 stage of pipeline, specifying:</span>
<span class="c1"># output directory to save *_rateints.fits files</span>
<span class="c1"># save_results flag set to True so the *rateints.fits files are saved</span>

<span class="k">if</span> <span class="n">dodet1</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">uncal</span> <span class="ow">in</span> <span class="n">uncal_files</span><span class="p">:</span>
        <span class="n">rate_result</span> <span class="o">=</span> <span class="n">Detector1Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">uncal</span><span class="p">,</span>
                                             <span class="n">output_dir</span><span class="o">=</span><span class="n">det1_dir</span><span class="p">,</span>
                                             <span class="n">steps</span><span class="o">=</span><span class="n">det1dict</span><span class="p">,</span>
                                             <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Detector1 processing&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for Detector1: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="exploring-the-data">
<h3>Exploring the data<a class="headerlink" href="#exploring-the-data" title="Permalink to this heading">#</a></h3>
<p>Identify <code class="docutils literal notranslate"><span class="pre">*_rateints.fits</span></code> files and verify which pipeline steps were run and
which calibration reference files were applied.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dodet1</span><span class="p">:</span>
    <span class="c1"># find rateints files</span>
    <span class="n">rateints_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">,</span> <span class="s1">&#39;*_rateints.fits&#39;</span><span class="p">)))</span>
    <span class="c1"># Restrict to selected filter if applicable</span>
    <span class="c1">#rateints_files = select_filter_files(rateints_files, use_filter)</span>
    
    <span class="c1"># Read in the first file as datamodel as an example</span>
    <span class="n">rateints</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Check which steps were run</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">rateints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">cal_step</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check which CRDS version and reference files were used to calibrate the dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dodet1</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">rateints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">rateints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">rateints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="spec2-pipeline">
<h2>6. Spec2 Pipeline<a class="headerlink" href="#spec2-pipeline" title="Permalink to this heading">#</a></h2>
<p>In the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_spec2.html">Spec2 stage of the pipeline</a>,
each exposure is corrected with further instrumental calibrations, and then a 1D spectrum is extracted. The steps applied to NIRISS SOSS exposures are, in order:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">assign_wcs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">background</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">srctype</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">straylight</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flat_field</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pathloss</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">extract_1d</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">photom</span></code></p></li>
</ol>
<p>Note that while most JWST spectroscopic modes perform the photometric calibration (<code class="docutils literal notranslate"><span class="pre">photom</span></code>) followed by spectral extraction (<code class="docutils literal notranslate"><span class="pre">extract_1d</span></code>),
the order of these steps is switched for SOSS so that the overlapping spectral orders can be disentangled before they are converted to flux units, as required for the <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2022PASP..134i4502D/abstract">Algorithm to Treat Order ContAmination (ATOCA)</a>.</p>
<p>The Spec2 Pipeline can produce <code class="docutils literal notranslate"><span class="pre">*_x1d.fits</span></code> or <code class="docutils literal notranslate"><span class="pre">*_x1dints.fits</span></code> files, depending on whether the input files are
<code class="docutils literal notranslate"><span class="pre">*_rate.fits</span></code> or <code class="docutils literal notranslate"><span class="pre">*_rateints.fits</span></code>. These products are the 1D extracted spectra which will be used as input to the following pipeline stage. In this case, we are interested in the time series of observations, so we want to preserve the multiple integrations by using the <code class="docutils literal notranslate"><span class="pre">*_rateints.fits</span></code> files as input.</p>
<p>The Spec2 Pipeline can also save <code class="docutils literal notranslate"><span class="pre">*_cal.fits</span></code> or <code class="docutils literal notranslate"><span class="pre">*_calints.fits</span></code>, which are 2D or 3D fully calibrated images, again depending on the dimensions of the input.</p>
<p>For more information about each step and a full list of step arguments, please refer to the official documentation on <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_spec1.html">ReadtheDocs</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_spec2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the Spec2 pipeline should be configured.</span>

<span class="c1"># Boilerplate dictionary setup</span>
<span class="n">spec2dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

<span class="c1"># Step names are copied here for reference</span>
<span class="n">spec2steps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;assign_wcs&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;bkg_subtract&#39;</span><span class="p">,</span>
              <span class="s1">&#39;srctype&#39;</span><span class="p">,</span>
              <span class="s1">&#39;straylight&#39;</span><span class="p">,</span>
              <span class="s1">&#39;flat_field&#39;</span><span class="p">,</span>
              <span class="s1">&#39;pathloss&#39;</span><span class="p">,</span>
              <span class="s1">&#39;extract_1d&#39;</span><span class="p">,</span>
              <span class="s1">&#39;photom&#39;</span><span class="p">]</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped (example)</span>
<span class="c1"># spec2dict[&#39;bkg_subtract&#39;][&#39;skip&#39;] = True</span>

<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;bkg_subtract&#39;</span><span class="p">][</span><span class="s1">&#39;soss_source_percentile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">50.0</span>

<span class="c1"># Overrides for various reference files</span>
<span class="c1"># Files should be in the base local directory or provide full path</span>
<span class="c1">#spec2dict[&#39;flat_field&#39;][&#39;override_flat&#39;] = &#39;myfile.fits&#39;  # Pixel flatfield</span>
</pre></div>
</div>
</div>
</div>
<p>Find and sort the input files, ensuring use of absolute paths. At this time we will discard the last exposure, the F277W spectrum, from the list of files, as it cannot currently be processed through Stage 2. We will also remove the TA exposures from the list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use files from the detector1 output folder</span>
<span class="n">rateints_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">,</span> <span class="s1">&#39;jw*rateints.fits&#39;</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">)):</span>
    <span class="n">rateints_files</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

<span class="c1"># Discard any TA exposures and the final F277W exposure from the list</span>
<span class="n">tafiles</span><span class="p">,</span> <span class="n">scifiles</span><span class="p">,</span> <span class="n">f277wfiles</span> <span class="o">=</span> <span class="n">sort_files</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">)</span>
<span class="n">rateints_files</span> <span class="o">=</span> <span class="n">scifiles</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rateints_files</span><span class="p">))</span><span class="si">}</span><span class="s2"> science files&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Spec2 stage of pipeline, specifying:</span>
<span class="c1"># output directory to save files</span>

<span class="k">if</span> <span class="n">dospec2</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">rateints</span> <span class="ow">in</span> <span class="n">rateints_files</span><span class="p">:</span>
        <span class="n">calints_result</span> <span class="o">=</span> <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">rateints</span><span class="p">,</span>
                                            <span class="n">output_dir</span><span class="o">=</span><span class="n">spec2_dir</span><span class="p">,</span>
                                            <span class="n">steps</span><span class="o">=</span><span class="n">spec2dict</span><span class="p">,</span>
                                            <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping Spec2 processing.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for Spec2: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_spec2</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Verify which pipeline steps were run:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dospec2</span><span class="p">:</span>
    <span class="c1"># Identify *_calints.fits files</span>
    <span class="n">calints_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spec2_dir</span><span class="p">,</span> <span class="s1">&#39;*_calints.fits&#39;</span><span class="p">)))</span>
    <span class="c1"># Restrict to selected filter if applicable</span>

    <span class="c1"># Read in the first file as datamodel as an example</span>
    <span class="n">calints</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">calints_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Check which steps were run</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">calints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">cal_step</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check which reference files were used to calibrate the dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dospec2</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">calints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">calints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">calints</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
<section id="tso3-pipeline">
<h2>7. TSO3 Pipeline<a class="headerlink" href="#tso3-pipeline" title="Permalink to this heading">#</a></h2>
<p>In the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_tso3.html">TSO3 stage of the pipeline</a>, an association of calibrated TSO exposures is used to produce calibrated time-series spectra of the target. By default his stage consists of three steps for SOSS TSOs:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">outlier_detection</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">extract_1d</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">white_light</span></code></p></li>
</ol>
<p>This stage also includes an optional <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pixel_replace/main.html">pixel replacement step</a> (<code class="docutils literal notranslate"><span class="pre">pixel_replace</span></code>) that is off by default for SOSS, but can be enabled to reduce the noise introduced by bad pixels in the spectrum. To run it, uncomment the relevant line in the tso3dict below.</p>
<p>In order to run the TSO3 stage, an <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/associations/overview.html">Association</a> file
must first be created to instruct the pipeline to process the segments of the time series together.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_tso3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the TSO3 pipeline should be configured</span>
<span class="c1"># Boilerplate dictionary setup</span>
<span class="n">tso3dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

<span class="c1"># Options for each step (example)</span>
<span class="c1">#tso3dict[&#39;outlier_detection&#39;][&#39;snr&#39;] = &#39;5.0 4.0&#39; # Signal-to-noise thresholds for bad pixel identification</span>
<span class="c1">#tso3dict[&#39;extract_1d&#39;][&#39;soss_atoca&#39;] = False  # Turn off the ATOCA algorithm for order contamination (default=True)</span>
<span class="c1">#tso3dict[&#39;whitelight&#39;][&#39;min_wavelength&#39;] = 0.8 # minimum wavelength from which to sum the flux array</span>
<span class="n">tso3dict</span><span class="p">[</span><span class="s1">&#39;extract_1d&#39;</span><span class="p">][</span><span class="s1">&#39;save_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">tso3dict</span><span class="p">[</span><span class="s1">&#39;white_light&#39;</span><span class="p">][</span><span class="s1">&#39;save_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># tso3dict[&#39;pixel_replace&#39;][&#39;skip&#39;] = False # Run the pixel replacement step</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped (example)</span>
<span class="c1">#tso3dict[&#39;white_light&#39;][&#39;skip&#39;] = True</span>

<span class="c1"># Overrides for various reference files (example)</span>
<span class="c1"># Files should be in the base local directory or provide full path</span>
<span class="c1">#tso3dict[&#39;extract_1d&#39;][&#39;override_extract1d&#39;] = &#39;myx1dfile.fits&#39;  # override spectral extraction parameters</span>
</pre></div>
</div>
</div>
</div>
<p>Find and sort all of the input files, ensuring use of absolute paths</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TSO3 takes the calints.fits files output by Spec2</span>

<span class="n">calints_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spec2_dir</span><span class="p">,</span> <span class="s1">&#39;jw*calints.fits&#39;</span><span class="p">)))</span>
<span class="n">calints_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">calints</span><span class="p">)</span> <span class="k">for</span> <span class="n">calints</span> <span class="ow">in</span> <span class="n">calints_files</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calints_files</span><span class="p">))</span><span class="si">}</span><span class="s1"> science files to process&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="create-association-files">
<h3>Create Association Files<a class="headerlink" href="#create-association-files" title="Permalink to this heading">#</a></h3>
<p>An association file lists the exposures to calibrate together in <code class="docutils literal notranslate"><span class="pre">Stage</span> <span class="pre">3</span></code>
of the pipeline. Note that an association file is available for download
from MAST, with a filename of <code class="docutils literal notranslate"><span class="pre">*_asn.json</span></code>, though it may require additional manipulation.</p>
<p>Here we create a <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/associations/level3_asn_technical.html">Level 3 association</a> file that will tell the pipeline to process the segments of the time series together. Since we only have a single time series, we only need one association file.</p>
<p>Note that the final output products will have a rootname that is specified by the <code class="docutils literal notranslate"><span class="pre">product_name</span></code>
in the association file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create Level 3 Association</span>
<span class="k">if</span> <span class="n">dotso3</span><span class="p">:</span>
    <span class="c1"># Get the program, target name from the header of one file</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">calints_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">program</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PROGRAM&#39;</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TARGNAME&#39;</span><span class="p">]</span>
    <span class="c1"># Create and save the asn file to the TSO3 directory</span>
    <span class="n">asnfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tso3_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;level3_</span><span class="si">{</span><span class="n">program</span><span class="si">}</span><span class="s1">_asn.json&#39;</span><span class="p">)</span>
    <span class="n">asn</span> <span class="o">=</span> <span class="n">asn_from_list</span><span class="o">.</span><span class="n">asn_from_list</span><span class="p">(</span><span class="n">calints_files</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">DMS_Level3_Base</span><span class="p">,</span> <span class="n">product_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">asn</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;asn_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;tso3&#39;</span>
    <span class="n">asn</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;program&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">program</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">asn</span><span class="o">.</span><span class="n">dump</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">asnfile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;Level 3 association successfully created and saved to: </span><span class="si">{</span><span class="n">asnfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Examine the ASN file.</span>
<span class="k">if</span> <span class="n">dotso3</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_obj</span><span class="p">:</span>
        <span class="n">asnfile_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f_obj</span><span class="p">)</span>
    <span class="n">expanded_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asnfile_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">expanded_json</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-tso3-stage-of-the-pipeline">
<h3>Run TSO3 stage of the pipeline<a class="headerlink" href="#run-tso3-stage-of-the-pipeline" title="Permalink to this heading">#</a></h3>
<p>From the four exposures listed in the association file, the
<code class="docutils literal notranslate"><span class="pre">TSO3</span></code> stage of the pipeline will produce:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">*_cfrints.fits</span></code> files from the <code class="docutils literal notranslate"><span class="pre">outlier_detection</span></code> step containing cosmic-ray-flagged images with updated DQ arrays for each input <code class="docutils literal notranslate"><span class="pre">calints</span></code> file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">*_x1dints.fits</span></code> file from the <code class="docutils literal notranslate"><span class="pre">extract_1d</span></code> step containing extracted spectra for all integrations in the input exposures</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">*_whtlt.ecsv</span></code> file from the <code class="docutils literal notranslate"><span class="pre">white_light</span></code> step containing an ASCII catalog of wavelength-integrated white-light flux as a function of time</p></li>
</ul>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Stage 3</span>
<span class="k">if</span> <span class="n">dotso3</span><span class="p">:</span>
    <span class="n">tso3_result</span> <span class="o">=</span> <span class="n">Tso3Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span>
                                    <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">output_dir</span><span class="o">=</span><span class="n">tso3_dir</span><span class="p">,</span>
                                    <span class="n">steps</span><span class="o">=</span><span class="n">tso3dict</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping TSO3 processing&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for TSO3: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_tso3</span><span class="si">:</span><span class="s2">0.0f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="verify-which-pipeline-steps-were-run">
<h3>Verify which pipeline steps were run<a class="headerlink" href="#verify-which-pipeline-steps-were-run" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dotso3</span><span class="p">:</span>
    <span class="c1"># Identify *x1dints.fits file and open as datamodel</span>
    <span class="n">x1dints</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tso3_dir</span><span class="p">,</span> <span class="s2">&quot;*_x1dints.fits&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1dints</span><span class="p">)</span> <span class="k">as</span> <span class="n">x1d_model</span><span class="p">:</span>
        <span class="c1"># Check which steps were run</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">x1d_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">cal_step</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check which reference files were used to calibrate the dataset</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dotso3</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">x1d_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">x1d_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">x1d_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="visualize-the-results">
<h2>8. Visualize the results<a class="headerlink" href="#visualize-the-results" title="Permalink to this heading">#</a></h2>
<section id="define-plotting-functions">
<h3>Define plotting functions<a class="headerlink" href="#define-plotting-functions" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">prepare_spectra</span><span class="p">(</span><span class="n">filelist</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Join segmented 1D spectra and their corresponding timestamps</span>
<span class="sd">    and wavelengths to form single arrays. If only one file given, </span>
<span class="sd">    just extract quantities and return them in suitable shape for plotting.</span>
<span class="sd">    Handles x1dints products from either spec2 or tso3.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The contents of the returned dictionary are structured as follows:</span>
<span class="sd">        specdict = {</span>
<span class="sd">                    &quot;ORDER1&quot; : {&quot;FLUX&quot; : arr(nints, npix),</span>
<span class="sd">                                &quot;FLUX_ERROR&quot; : arr(nints, npix),</span>
<span class="sd">                                &quot;WAVELENGTH&quot; : arr(nints, npix),</span>
<span class="sd">                                &quot;INT_TIMES&quot; : arr(nints),</span>
<span class="sd">                                }</span>
<span class="sd">                    &quot;ORDER2&quot; : ...</span>
<span class="sd">                    }</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filelist: str, list of str</span>
<span class="sd">        Name(s) of x1dints file(s) to join. </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    specdict: dict</span>
<span class="sd">        Nested dictionary containing dict of spectral data for each order. See Notes for contents</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Check inputs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filelist</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">filelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">filelist</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="p">]</span>
    <span class="c1"># Prepare a dictionary for outputs</span>
    <span class="n">specdict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># Find out how many orders are contained in the dataproducts</span>
    <span class="n">ordlst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">hdulist</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ordlst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;SPORDER&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
    <span class="n">ordersinfile</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ordlst</span><span class="p">)</span>
    <span class="c1"># Loop over the *requested* orders</span>
    <span class="k">for</span> <span class="n">nord</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Loop over input files</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
                <span class="n">specidxlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">spec</span><span class="p">))</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">specidxlist</span><span class="p">[</span><span class="n">nord</span><span class="p">::</span><span class="n">ordersinfile</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">segflux</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spec_table</span><span class="o">.</span><span class="n">FLUX</span>
                    <span class="n">segfluxerr</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spec_table</span><span class="o">.</span><span class="n">FLUX_ERROR</span>
                    <span class="n">seginttimes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spec_table</span><span class="p">[</span><span class="s1">&#39;TDB-MID&#39;</span><span class="p">]</span>
                    <span class="c1"># wavelength array for each integration is the same, but we include them all for completeness</span>
                    <span class="n">segwavel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spec_table</span><span class="o">.</span><span class="n">WAVELENGTH</span>
                    <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                        <span class="n">fullflux</span> <span class="o">=</span> <span class="n">segflux</span>
                        <span class="n">fullfluxerr</span> <span class="o">=</span> <span class="n">segfluxerr</span>
                        <span class="n">fulltimes</span> <span class="o">=</span> <span class="n">seginttimes</span>
                        <span class="n">fullwavels</span> <span class="o">=</span> <span class="n">segwavel</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fullflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">fullflux</span><span class="p">,</span> <span class="n">segflux</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">fullfluxerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">fullfluxerr</span><span class="p">,</span> <span class="n">segfluxerr</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">fullwavels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">fullwavels</span><span class="p">,</span> <span class="n">segwavel</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">fulltimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">fulltimes</span><span class="p">,</span> <span class="n">seginttimes</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        
        <span class="c1"># Populate the dictionary</span>
        <span class="n">specdict</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ORDER</span><span class="si">{</span><span class="n">nord</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullflux</span>
        <span class="n">specdict</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ORDER</span><span class="si">{</span><span class="n">nord</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;FLUX_ERROR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullfluxerr</span>
        <span class="n">specdict</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ORDER</span><span class="si">{</span><span class="n">nord</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullwavels</span>
        <span class="n">specdict</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ORDER</span><span class="si">{</span><span class="n">nord</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;INT_TIMES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fulltimes</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order </span><span class="si">{</span><span class="n">nord</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> dimensions: </span><span class="si">{</span><span class="n">fullflux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> integrations, </span><span class="si">{</span><span class="n">fullflux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> wavelengths&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">specdict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">display_soss_im</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">intnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">groupnum</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">lognormalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a SOSS image.</span>

<span class="sd">    Can display 2D (e.g. rate), 3D (e.g. calints), 4D (e.g. uncal) images.</span>
<span class="sd">    Defaults to show the first integration of 3D files; first integration/</span>
<span class="sd">    last group of 4D files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename: str</span>
<span class="sd">        Name of file to display</span>
<span class="sd">    intnum: int</span>
<span class="sd">        Integration number in each file to display. Default is 0.</span>
<span class="sd">    groupnum: int</span>
<span class="sd">        Group number to display, if relevant. Default is -1 (last group)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Open file as a datamodel</span>
    <span class="k">with</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
        <span class="c1"># Read the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># Get some other useful info</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">bunit_data</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span>
        <span class="n">pupil</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">pupil</span>
        <span class="n">targname</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">catalog_name</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intnum</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">intnum</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># if intnum is between -1 and the first dimension</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">intnum</span><span class="p">]</span> <span class="c1"># now 2d </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid integration number &#39;</span><span class="si">{</span><span class="n">intnum</span><span class="si">}</span><span class="s2">&#39; for data with shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupnum</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">groupnum</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">groupnum</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid group number &#39;</span><span class="si">{</span><span class="n">groupnum</span><span class="si">}</span><span class="s2">&#39; for data with shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Make the figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">lognormalize</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># sigma_clipped_data = sigma_clip(data)</span>
        <span class="c1"># vmin = np.nanmin(sigma_clipped_data)</span>
        <span class="c1"># vmax = np.nanmax(sigma_clipped_data)</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># norm = simple_norm(data, vmin=vmin, vmax=vmax)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                              <span class="n">interval</span><span class="o">=</span><span class="n">ManualInterval</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="o">-</span><span class="p">(</span><span class="n">vmin</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="o">+</span><span class="p">(</span><span class="n">vmin</span><span class="p">)),</span>
                              <span class="n">stretch</span><span class="o">=</span><span class="n">LogStretch</span><span class="p">())</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">titlestring</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">targname</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pupil</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titlestring</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X pixel&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y pixel&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">display_spectrum</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">intnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a SOSS spectrum.</span>

<span class="sd">    This function take either a single file or a list of files,</span>
<span class="sd">    in which case it will assume they are a single TSO and concatenate </span>
<span class="sd">    the segments to produce a single set of extracted measurements.</span>
<span class="sd">    Can display an averaged spectrum (&#39;x1d&#39;) or a single integration of a </span>
<span class="sd">    multi-integration spectrum (&#39;x1dints&#39;).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename: str or list of str</span>
<span class="sd">        Name of file to display</span>
<span class="sd">    intnum: int</span>
<span class="sd">        Integration number in each file to display. Default is 0.</span>
<span class="sd">    order: int</span>
<span class="sd">        Which spectral order to plot. Options are 1, 2, and 3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Check inputs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="p">]</span>
    <span class="c1"># If multiple segments, join the spectra</span>
    <span class="c1"># We assume they are in the correct order already...</span>
    <span class="n">specdict</span> <span class="o">=</span> <span class="n">prepare_spectra</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    
    <span class="c1"># Set up the plot.</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">ordr</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
        <span class="n">orderdict</span> <span class="o">=</span> <span class="n">specdict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ORDER</span><span class="si">{</span><span class="n">ordr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">orderdict</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span>
        <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">orderdict</span><span class="p">[</span><span class="s1">&#39;FLUX_ERROR&#39;</span><span class="p">]</span>
        <span class="n">wavel</span> <span class="o">=</span> <span class="n">orderdict</span><span class="p">[</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wavel</span><span class="p">[</span><span class="n">intnum</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="n">intnum</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">fluxerr</span><span class="p">[</span><span class="n">intnum</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Order </span><span class="si">{</span><span class="n">ordr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\mu$m]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux [MJy]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">spectrum_timeseries</span><span class="p">(</span><span class="n">specfiles</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a SOSS spectrum timeseries.</span>

<span class="sd">    This function creates a plot of flux as a function of both wavelength and time,</span>
<span class="sd">    to visualize how the flux changes over the duration of the time series. The flux</span>
<span class="sd">    at each wavelength is normalized by default to emphasize the transit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    specfiles: str or list of str</span>
<span class="sd">        Name of file(s) containing a time-series of spectra</span>
<span class="sd">    normalize: bool</span>
<span class="sd">        If True, normalize the flux at each wavelength by an approximate out-of-transit flux</span>
<span class="sd">        Default=True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Get data </span>
    <span class="n">specdict</span> <span class="o">=</span> <span class="n">prepare_spectra</span><span class="p">(</span><span class="n">specfiles</span><span class="p">)</span>
    
    <span class="n">flux</span> <span class="o">=</span> <span class="n">specdict</span><span class="p">[</span><span class="s2">&quot;ORDER1&quot;</span><span class="p">][</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span>
    <span class="n">wavel</span> <span class="o">=</span> <span class="n">specdict</span><span class="p">[</span><span class="s2">&quot;ORDER1&quot;</span><span class="p">][</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
    <span class="n">times</span> <span class="o">=</span> <span class="n">specdict</span><span class="p">[</span><span class="s2">&quot;ORDER1&quot;</span><span class="p">][</span><span class="s2">&quot;INT_TIMES&quot;</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>

        <span class="c1"># Average flux at each wavelength for first 100 integrations (assumed out-of-transit)</span>
        <span class="n">first100</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="mi">100</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Normalize the flux to emphasize the transit</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span class="o">/</span><span class="n">first100</span>
        <span class="n">sigma_clipped_data</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="c1"># Trim last row/column for mesh plotting</span>
    <span class="n">fluxtrim</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Map times in MJD to time from midtransit</span>
    <span class="c1"># Transit ephemera from Carter et al. 2024 (doi:10.1038/s41550-024-02292-x)</span>
    <span class="n">T_c</span> <span class="o">=</span> <span class="mf">2459787.5567843</span> <span class="o">-</span> <span class="mf">2400000.5</span>
    
    <span class="n">reltime</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span> <span class="o">-</span> <span class="n">T_c</span><span class="p">)</span> <span class="o">*</span> <span class="mi">24</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">reltime</span><span class="p">,</span> <span class="n">wavel</span><span class="p">,</span> <span class="n">fluxtrim</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">reltime</span><span class="p">,</span> <span class="n">wavel</span><span class="p">,</span> <span class="n">fluxtrim</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time from Mid-Transit [hr]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\mu$m]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">display_lightcurve</span><span class="p">(</span><span class="n">whtlt_file</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">modelparams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a SOSS whitelight curve.</span>

<span class="sd">    This function displays the total flux over all wavelengths for </span>
<span class="sd">    each integration in the time series, for each order. Optionally, </span>
<span class="sd">    we can pass `batman` model parameters to overplot a transit model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    whtlt_file: str</span>
<span class="sd">        Name of file(s) containing a time-series of spectra</span>
<span class="sd">    order: int</span>
<span class="sd">        Which spectral order to plot. Options are 1, 2, and 3.</span>
<span class="sd">    modelparams: batman.TransitParams()</span>
<span class="sd">        Transit model parameters to plot with the data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read the file into a pandas dataframe</span>
    <span class="n">whitelight_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">whtlt_file</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s1">&#39;skip&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">)</span>
    <span class="c1"># Check inputs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="p">]</span>
    <span class="c1"># Set up the figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>
    
    <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">whitelight_df</span><span class="p">[</span><span class="s1">&#39;BJD_TDB&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">modelparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Plot a simple transit model using the best-fit parameters from the Carter et al. 2024 paper</span>
        <span class="n">transitmodel</span> <span class="o">=</span> <span class="n">batman</span><span class="o">.</span><span class="n">TransitModel</span><span class="p">(</span><span class="n">modelparams</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>    <span class="c1"># initializes model</span>
        <span class="n">modelflux</span> <span class="o">=</span> <span class="n">transitmodel</span><span class="o">.</span><span class="n">light_curve</span><span class="p">(</span><span class="n">modelparams</span><span class="p">)</span>         <span class="c1"># calculates light curve</span>
        <span class="n">reltime</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span> <span class="o">-</span> <span class="n">modelparams</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="mi">24</span>
    
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ordr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">whitelight_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;whitelight_flux_order_</span><span class="si">{</span><span class="n">ordr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="c1"># Normalize to have an out-of-transit flux of ~1</span>
        <span class="n">fluxnorm</span> <span class="o">=</span> <span class="n">flux</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
        
        <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Order </span><span class="si">{</span><span class="n">ordr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modelparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reltime</span><span class="p">,</span> <span class="n">fluxnorm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reltime</span><span class="p">,</span> <span class="n">modelflux</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time to Mid-Transit [hr]&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">fluxnorm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;BJD [TDB]&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">whtlt_file</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="gather-the-data">
<h3>Gather the data<a class="headerlink" href="#gather-the-data" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="c1"># Get all the filenames</span>
    <span class="n">rateintsfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">,</span> <span class="s1">&#39;*rateints.fits&#39;</span><span class="p">)))</span>
    <span class="n">tafiles</span><span class="p">,</span> <span class="n">scifiles</span><span class="p">,</span> <span class="n">f277wfiles</span> <span class="o">=</span> <span class="n">sort_files</span><span class="p">(</span><span class="n">rateintsfiles</span><span class="p">)</span>
    <span class="n">rateintsfiles</span> <span class="o">=</span> <span class="n">scifiles</span>
    <span class="n">calintsfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spec2_dir</span><span class="p">,</span> <span class="s1">&#39;*calints.fits&#39;</span><span class="p">)))</span>
    <span class="n">x1d_spec2files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spec2_dir</span><span class="p">,</span> <span class="s1">&#39;*x1dints.fits&#39;</span><span class="p">)))</span>
    <span class="n">x1d_tso3file</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tso3_dir</span><span class="p">,</span> <span class="s1">&#39;*x1dints.fits&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">whtltfile</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tso3_dir</span><span class="p">,</span> <span class="s1">&#39;*whtlt.ecsv&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="examine-target-acquisition-images">
<h3>Examine Target Acquisition images<a class="headerlink" href="#examine-target-acquisition-images" title="Permalink to this heading">#</a></h3>
<p>We will not do any analysis of the TA images in this instance, but we will check them briefly to confirm that the source appears at the center of the final TACONFIRM image. These 4D uncal files contain a single integration composed of 13 groups up the ramp, so we will look at the last group of each file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">doviz</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tafiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
    <span class="c1"># Prepare the figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ta_fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tafiles</span><span class="p">):</span>
        <span class="c1"># Plot the data</span>
        <span class="k">with</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ta_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">ta_dm</span><span class="p">:</span>
            <span class="n">ta_im</span> <span class="o">=</span> <span class="n">ta_dm</span><span class="o">.</span><span class="n">data</span>
            <span class="c1"># Exclude outlier pixels</span>
            <span class="n">sigma_clipped_data</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">ta_im</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">imshape</span> <span class="o">=</span> <span class="n">ta_im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span>
            <span class="c1"># normalize, adjusting the limits a bit</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">vmin</span><span class="p">)),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">vmax</span><span class="p">)))</span>

            <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ta_im</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">ta_dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">bunit_data</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ta_dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">imshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>
    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">])</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can see that the source is being dithered in the first three images, and is nicely centered in the final image, as indicated by the black ‘x’ at the center of the array. The white pixels are those replaced by NaNs by the Detector1 pipeline due to saturation, outliers, or other data quality issues.</p>
</section>
<section id="examine-detector1-products">
<h3>Examine Detector1 products<a class="headerlink" href="#examine-detector1-products" title="Permalink to this heading">#</a></h3>
<p>We will begin by looking at the output of the first pipeline stage, the <code class="docutils literal notranslate"><span class="pre">rateints</span></code> files. As the 2D spectra over the duration of the time series will look very similar, we will only plot the first.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="n">display_soss_im</span><span class="p">(</span><span class="n">rateintsfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We are displaying these images on a logarithmic scale to be able to see the features of both the cross-dispersed spectral traces and the background. To see them on a linear scale, pass the argument <code class="docutils literal notranslate"><span class="pre">lognormalize=False</span></code>.</p>
<p>Orders 1, 2, and 3 are clearly visible in this image, along with some faint background sources. Order 1 extends across the full subarray and covers wavelengths from 0.9 $\mu m$ to 2.8 $\mu m$. The Order 2 trace, covering 0.6$ \mu m$ to 1.4$ \mu m$, overlaps with Order 1 at the longer-wavelength end of the traces. Order 3 peaks at ~0.6 $ \mu m$, though it is very faint.</p>
<p>For bright targets that would saturate the detector with the longer readout times of the SUBSTRIP256 subarray, users can elect to use the SUBSTRIP96 array. The 96-pixel vertical dimension of this subarray covers only the Order 1. For more information about the optics and spectral traces, see the <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-imager-and-slitless-spectrograph/niriss-instrumentation/niriss-gr700xd-grism">GR700X grism documentation</a>.</p>
<p>Although we did not extract a spectrum from it, it is interesting to look at the F277W spectral image:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">doviz</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f277wfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
    <span class="n">display_soss_im</span><span class="p">(</span><span class="n">f277wfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Compared to the CLEAR image above, we can clearly see that the Order 0 trace extends over only a small portion of the subarray, and Orders 2 and 3 are entirely absent. This is expected, because the left side of the subarray (in DMS orientation) corresponds to the longer wavelengths that SOSS is sensitive to, and the F277W filter covers only 2.413 $\mu m$ to 3.143 $\mu m$. This allows users to isolate the first order spectrum in the range where the first and second order overlap considerably.</p>
<p>We can also see several potentially contaminating zeroth-order sources in the image (the Order 0 for our target does not fall on the detector). Characterizing these sources in the F277W image can allow users to model and remove them in the full wavelength coverage spectra, although this capability is not currently included in the pipeline. Best practices for obtaining an F277W exposure are included in the <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-imager-and-slitless-spectrograph/niriss-observing-strategies/niriss-soss-recommended-strategies#NIRISSSOSSRecommendedStrategies-f277wAddinganoptionalF277Wexposuretoyourobservingprogram">SOSS Recommended Strategies</a>.</p>
<p>The 1/f noise (vertical striping) is also more apparent in this exposure because of the lower signal relative to the background.</p>
</section>
<section id="examine-spec2-products">
<h3>Examine Spec2 products<a class="headerlink" href="#examine-spec2-products" title="Permalink to this heading">#</a></h3>
<p>Next we will look at the outputs of the second pipeline stage: the calibrated <code class="docutils literal notranslate"><span class="pre">calints</span></code> images and the preliminary <code class="docutils literal notranslate"><span class="pre">x1dints</span></code> extracted spectra. For more information about the structure and contents of these data products, see the documentation about <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/science_products.html#extracted-1-d-spectroscopic-data-x1d-and-x1dints">x1d/x1dints</a> and <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/science_products.html#calibrated-data-cal-and-calints">calints</a> files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="n">display_soss_im</span><span class="p">(</span><span class="n">calintsfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>The SOSS sky background is characterized by a smooth rising gradient towards longer wavelengths, with a sharp discontinuity at around X=700 (corresponding to 2.1 $\mu m$ in Order 1) caused by the edges of the pick-off mirror (POM). The background varies with sky position and relative pointing due to the contribution of zodiacal light. Because of the variation in relative intensity on either side of the discontinuity, an empirical model cannot be simply linearly scaled to match a given observation. However, it is important to remove the background for most SOSS science use cases, so in the absence of a contemporaneous background exposure, the Spec2 <code class="docutils literal notranslate"><span class="pre">bkg_subtract</span></code> step finds the best match for each exposure from a library of empirical models scaled independently on either side of the discontinuity.</p>
<p>We can see that the background is considerably lower in the background-subtracted <code class="docutils literal notranslate"><span class="pre">calints</span></code> image compared to the previous <code class="docutils literal notranslate"><span class="pre">rateints</span></code> image, and the discontinuity is not as prominent, though some structure remains. The NIRISS team intends to continue improving the background subtraction algorithm in the future.</p>
<p>Now, let’s look at one of the extracted spectra.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="n">display_spectrum</span><span class="p">(</span><span class="n">x1d_spec2files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that not all of the “features” of this spectrum are absorption lines; many are due to bad pixels in the spectrum. As mentioned in the <span class="xref myst">TSO3 Pipeline</span> section, there is an optional pixel replacement step that may reduce this type of noise.</p>
<p>This is the first integration of the time series, but we are especially interested in how the spectrum changes over the duration of the observations. Let’s look at the spectrum as a function of both wavelength and time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="n">spectrum_timeseries</span><span class="p">(</span><span class="n">x1d_spec2files</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In this plot, the flux at each wavelength is normalized so that the decrease in flux caused by the transiting exoplanet is emphasized.</p>
<p>If we pass the argument <code class="docutils literal notranslate"><span class="pre">normalize=False</span></code> to the plotting function, the transit is much less obvious but we can see some interesting spectral features, as well as how the flux decreases at longer wavelengths.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="n">spectrum_timeseries</span><span class="p">(</span><span class="n">x1d_spec2files</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="examine-tso3-products">
<h3>Examine TSO3 products<a class="headerlink" href="#examine-tso3-products" title="Permalink to this heading">#</a></h3>
<p>Lastly, we will examine the products of the third and final pipeline stage: the final <code class="docutils literal notranslate"><span class="pre">x1dints</span></code> spectra and the white light (<code class="docutils literal notranslate"><span class="pre">whtlt</span></code>) curve for orders 1 and 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="n">display_spectrum</span><span class="p">(</span><span class="n">x1d_tso3file</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="n">display_spectrum</span><span class="p">(</span><span class="n">x1d_tso3file</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>By eye, there is not much difference apparent between the Stage 2 x1dints files and the Stage 3 x1dints files; the main difference is that the outlier detection step has now been run. However, it is worth noting that in Order 2, measurements beyond ~1 $\mu m$ are not reliable due to contamination from Order 1.</p>
<p>We can also make the 2d transit plot again, using the final extracted spectrum:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="n">spectrum_timeseries</span><span class="p">(</span><span class="n">x1d_tso3file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Lastly, let’s look at the white light curve. In this file, the flux at each wavelength has been summed to give us a single value at each timestamp.</p>
<p>We will plot the white light curve for orders 1 and 2, along with a simple transit model using the <code class="docutils literal notranslate"><span class="pre">batman</span></code> package (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2015PASP..127.1161K/abstract">Kreidberg 2015</a>). We adopt all of our planetary parameters from <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2023ApJ...944L..56M/abstract">McGruder et al. 2023</a>, except for the ratio of the planet radius to the stellar radius ($R_{p}/R_{*}$), which is from <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2023ApJS..265....4K/abstract">Kokori et al. 2023</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">doviz</span><span class="p">:</span>
    <span class="c1"># Set up the model parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">batman</span><span class="o">.</span><span class="n">TransitParams</span><span class="p">()</span>
    <span class="n">params</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="mf">2456258.06272</span> <span class="o">-</span> <span class="mf">2400000.5</span>       <span class="c1"># time of inferior conjunction</span>
    <span class="n">params</span><span class="o">.</span><span class="n">per</span> <span class="o">=</span> <span class="mf">3.4252567</span>                        <span class="c1"># orbital period</span>
    <span class="n">params</span><span class="o">.</span><span class="n">rp</span> <span class="o">=</span> <span class="mf">0.1175</span>                            <span class="c1"># planet radius (in units of stellar radii)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">9.13</span>                               <span class="c1"># semi-major axis (in units of stellar radii)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">inc</span> <span class="o">=</span> <span class="mf">85.45</span>                            <span class="c1"># orbital inclination (in degrees)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">ecc</span> <span class="o">=</span> <span class="mf">0.</span>                               <span class="c1"># eccentricity</span>
    <span class="n">params</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mf">90.</span>                                <span class="c1"># longitude of periastron (in degrees)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">]</span>                       <span class="c1"># limb darkening coefficients [u1, u2]</span>
    <span class="n">params</span><span class="o">.</span><span class="n">limb_dark</span> <span class="o">=</span> <span class="s2">&quot;quadratic&quot;</span>                <span class="c1"># limb darkening model</span>

    <span class="c1"># Display the light curves and models</span>
    <span class="n">display_lightcurve</span><span class="p">(</span><span class="n">whtltfile</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">modelparams</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Since the model parameters were derived from a different reduction that used the same data, it makes sense that this model looks like a pretty good fit to the data by eye. Further model fitting is beyond the scope of this notebook, but can also be done using <code class="docutils literal notranslate"><span class="pre">batman</span></code> or a variety of other open-source software packages.</p>
<hr style="border:1px solid gray"> </hr><a class="reference internal image-reference" href="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_footer.png"><img alt="stsci_logo" src="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_footer.png" style="width: 200px;" /></a>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jwst-pipeline-notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRISS/SOSS"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../Imaging/JWPipeNB-niriss-imaging.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">NIRISS Imaging Pipeline Notebook</p>
      </div>
    </a>
    <a class="right-next"
       href="../WFSS/JWPipeNB-niriss-wfss.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">NIRISS Wide Field Slitless Spectroscopy (WFSS) Pipeline Notebook</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">1. Configuration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-dependencies-and-parameters">Install dependencies and parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-crds-context-and-server">Set CRDS context and server</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#package-imports">2. Package Imports</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-convenience-functions">Define convenience functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-mode-setup-ignore-if-not-using-demo-data">3. Demo Mode Setup (ignore if not using demo data)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-setup">4. Directory Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#detector1-pipeline">5. Detector1 Pipeline</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-data">Exploring the data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spec2-pipeline">6. Spec2 Pipeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tso3-pipeline">7. TSO3 Pipeline</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-association-files">Create Association Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-tso3-stage-of-the-pipeline">Run TSO3 stage of the pipeline</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-which-pipeline-steps-were-run">Verify which pipeline steps were run</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-results">8. Visualize the results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-plotting-functions">Define plotting functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gather-the-data">Gather the data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-target-acquisition-images">Examine Target Acquisition images</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-detector1-products">Examine Detector1 products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-spec2-products">Examine Spec2 products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-tso3-products">Examine TSO3 products</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>