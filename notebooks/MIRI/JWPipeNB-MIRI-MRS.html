

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>MIRI MRS Pipeline Notebook &#8212; JWST Pipeline Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/MIRI/JWPipeNB-MIRI-MRS';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/stsci_logo2.png" class="logo__image only-light" alt="JWST Pipeline Notebooks - Home"/>
    <script>document.write(`<img src="../../_static/stsci_logo2.png" class="logo__image only-dark" alt="JWST Pipeline Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    JWST Pipeline Notebooks $${\color{red}UNDERâ€”CONSTRUCTION}$$
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Example</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../example_notebook/example_notebook.html">Draft: Notebook title</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jwst-pipeline-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jwst-pipeline-notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/MIRI/JWPipeNB-MIRI-MRS.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/MIRI/JWPipeNB-MIRI-MRS.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>MIRI MRS Pipeline Notebook</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-configuration-a-class-anchor-id-intro-a">1.<font color="white">-</font>Configuration<a class="anchor" id="intro"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-crds-context-and-server">Set CRDS context and server</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-package-imports-a-class-anchor-id-intro-a">2.<font color="white">-</font>Package Imports<a class="anchor" id="intro"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-convenience-functions">Define convenience functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-demo-mode-setup-a-class-anchor-id-intro-a-ignore-if-not-using-demo-data">3.<font color="white">-</font>Demo Mode Setup<a class="anchor" id="intro"></a> (ignore if not using demo data)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-directory-setup-a-class-anchor-id-intro-a">4.<font color="white">-</font>Directory Setup<a class="anchor" id="intro"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-detector1-pipeline-a-class-anchor-id-det1-a">5.<font color="white">-</font>Detector1 Pipeline<a class="anchor" id="det1"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrating-science-files">Calibrating Science Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrating-background-files">Calibrating Background Files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-spec2-pipeline-a-class-anchor-id-spec2-a">6.<font color="white">-</font>Spec2 Pipeline<a class="anchor" id="spec2"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-spec3-pipeline-a-class-anchor-id-spec3-a">7.<font color="white">-</font>Spec3 Pipeline<a class="anchor" id="spec3"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-plot-the-spectra-a-class-anchor-id-plots-a">8.<font color="white">-</font>Plot the spectra<a class="anchor" id="plots"></a></a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <a class="reference internal image-reference" href="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_header.png"><img alt="stsci_logo" src="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_header.png" style="width: 900px;" /></a>
<p><a id="title_ID"></a></p>
<section id="miri-mrs-pipeline-notebook">
<h1>MIRI MRS Pipeline Notebook<a class="headerlink" href="#miri-mrs-pipeline-notebook" title="Permalink to this heading">#</a></h1>
<p><strong>Authors</strong>: David Law, Kirsten Larson; MIRI branch<br>
<strong>Last Updated</strong>: September 24, 2024<br>
<strong>Pipeline Version</strong>: 1.15.1 (Build 11.0)</p>
<p><strong>Purpose</strong>:<BR>
This notebook provides a framework for processing generic Mid-Infrared
Instrument (MIRI) Medium Resolution Spectroscopy (MRS) data through all
three James Webb Space Telescope (JWST) pipeline stages.  Data is assumed
to be located in two observation folders (science and background)
according to paths set up below.  It should not be necessary to edit any
cells other than in the <span class="xref myst">Configuration</span> section
unless modifying the standard pipeline processing options.</p>
<p><strong>Data</strong>:<BR>
This example is set up to use observations of the LMC planetary nebula
SMP LMC 058 obtained by Proposal ID (PID) 1523 Observation 3. This is a
point source that uses a standard 4-point dither in all three grating
settings.  It incorporates a dedicated background in observation 4.
Example input data to use will be downloaded automatically unless
disabled (i.e., to use local files instead).</p>
<p><strong>JWST pipeline version and CRDS context</strong>:<BR>
This notebook was written for the
calibration pipeline version given above.  If you use it with a different pipeline
version or specify a non-default reference file context please see the relevant
release notes
(<a class="reference external" href="https://github.com/spacetelescope/jwst">here for pipeline</a>,
<a class="reference external" href="https://jwst-crds.stsci.edu/">here for CRDS</a>) for possibly relevant
changes.<BR></p>
<p><strong>Updates</strong>:<BR>
This notebook is regularly updated as improvements are made to the
pipeline. Find the most up to date version of this notebook at:
https://github.com/spacetelescope/jwst-pipeline-notebooks/</p>
<p><strong>Recent Changes</strong>:<br>
Sep 1 2022: Add some commentary and example on how to use multicore
processing in Detector 1<br>
Sep 12 2022: Disable unnecessary cube/1d spectra production for
individual science exposures in Spec 2<br>
Oct 14 2022: Include residual fringe correction in spec2 (note that this
will CRASH earlier pipeline versions!)<br>
Jun 29 2023: Update to latest 1.11.0 pipeline with photom, outlier
detection, and x1d changes, add CRDS path options.  Change to SMP LMC 058
demo.<br>
Oct 11 2023: Update to 1.12.3 pipeline with 1d spectral residual fringe
and auto-centroid options, 2d pixel replacement, and a variety of new
cube build options.<br>
Nov 17 2023: Incorporate CRDS default parameters for detector1 and
spec2<br>
Nov 20 2023: Significant revisions to allow use of associations in spec2,
allow choice of pixel-based background subtraction.<br>
Nov 24 2023: Additional comments and plotting examples.<br>
Jan 31 2024: Update to 1.13.4 pipeline, enabling spectral leak
correction<br>
Jul 1 2024: Migrate from MRS_FlightNB1 notebook, adapt to .call()
format, add post-hook example, add demo mode capability.<br>
Oct 11 2024: Update to Build 11.0 (jwst 1.15.1); move pixel_replacement to spec3 and enable by default, add option for bad pixel self-calibration in spec2.</p>
<hr style="border:1px solid gray"> </hr><section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><span class="xref myst">Configuration</span></p></li>
<li><p><span class="xref myst">Package Imports</span></p></li>
<li><p><span class="xref myst">Demo Mode Setup</span></p></li>
<li><p><span class="xref myst">Directory Setup</span></p></li>
<li><p><span class="xref myst">Detector1 Pipeline</span></p></li>
<li><p><span class="xref myst">Spec2 Pipeline</span></p></li>
<li><p><span class="xref myst">Spec3 Pipeline</span></p></li>
<li><p><span class="xref myst">Plot the spectra</span></p></li>
</ol>
<hr style="border:1px solid gray"> </hr></section>
<section id="font-color-white-font-configuration-a-class-anchor-id-intro-a">
<h2>1.<font color='white'>-</font>Configuration<a class="anchor" id="intro"></a><a class="headerlink" href="#font-color-white-font-configuration-a-class-anchor-id-intro-a" title="Permalink to this heading">#</a></h2>
<p>Set basic parameters to use with notebook. These will affect
what data is used, where data is located (if already in disk),
pipeline modules run in this data, and type of background
subtraction (if any). The list of parameters are:</p>
<ul class="simple">
<li><p>demo_mode</p></li>
<li><p>channel</p></li>
<li><p>band</p></li>
<li><p>directories with data</p></li>
<li><p>pipeline modules</p></li>
<li><p>Backgroud subtraction method</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic import necessary for configuration</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
Note that <code>demo_mode</code> must be set appropriately below.
</div>
<p>Set <code>demo_mode = True </code> to run in demonstration mode. In this mode this
notebook will download example data from the
Barbara A. Mikulski Archive for Space Telescopes (MAST) and process it through the pipeline.
This will all happen in a local directory unless modified
in <span class="xref myst">Section 3</span> below.</p>
<p>Set <code>demo_mode = False</code> if you want to process your own data that has already
been downloaded and provide the location of the data.<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set parameters for demo_mode, channel, band, data mode directories, and </span>
<span class="c1"># processing steps.</span>

<span class="c1"># -----------------------------Demo Mode---------------------------------</span>
<span class="n">demo_mode</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running in demonstration mode using online example data!&#39;</span><span class="p">)</span>

<span class="c1"># --------------------------User Mode Directories------------------------</span>
<span class="c1"># If demo_mode = False, look for user data in these paths</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="c1"># Set directory paths for processing specific data; these will need</span>
    <span class="c1"># to be changed to your local directory setup (below are given as</span>
    <span class="c1"># examples)</span>
    <span class="n">user_home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>

    <span class="c1"># Point to where science observation data are</span>
    <span class="c1"># Assumes uncalibrated data in sci_dir/uncal/ and results in stage1,</span>
    <span class="c1"># stage2, stage3 directories</span>
    <span class="n">sci_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_home_dir</span><span class="p">,</span> <span class="s1">&#39;FlightData/APT1523/data/Obs003/&#39;</span><span class="p">)</span>

    <span class="c1"># Point to where background observation data are</span>
    <span class="c1"># Assumes uncalibrated data in bg_dir/uncal/ and results in stage1,</span>
    <span class="c1"># stage2, stage3 directories</span>
    <span class="n">bg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_home_dir</span><span class="p">,</span> <span class="s1">&#39;FlightData/APT1523/data/Obs004/&#39;</span><span class="p">)</span>
    <span class="c1">#bg_dir = &#39;&#39; # If no background observation, use an empty string</span>

<span class="c1"># --------------------------Set Processing Steps--------------------------</span>
<span class="c1"># Whether or not to process only data from a given MRS band/channel (useful</span>
<span class="c1"># if overriding reference files)</span>
<span class="c1"># Note that BOTH parameters must be set in order to work</span>
<span class="n">use_ch</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># &#39;12&#39; or &#39;34&#39;</span>
<span class="n">use_band</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># &#39;SHORT&#39;, &#39;MEDIUM&#39;, or &#39;LONG&#39;</span>

<span class="c1"># Individual pipeline stages can be turned on/off here.  Note that a later</span>
<span class="c1"># stage won&#39;t be able to run unless data products have already been</span>
<span class="c1"># produced from the prior stage.</span>

<span class="c1"># Science processing</span>
<span class="n">dodet1</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_detector1</span>
<span class="n">dospec2</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_spec2</span>
<span class="n">dospec3</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_spec3</span>

<span class="c1"># Background processing</span>
<span class="n">dodet1bg</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_detector1</span>
<span class="n">dospec2bg</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># calwebb_spec2 (needed for Master Background subtraction)</span>

<span class="c1"># How should background subtraction using any dedicated backgrounds be done?</span>
<span class="c1"># If none are selected, cubes will not be background subtracted.  1d spectra</span>
<span class="c1"># will always use local annular background subtraction for point sources.</span>
<span class="c1"># Note that if using master-background subtraction, background observations</span>
<span class="c1"># must be selected above to process through spec2 (dospec2bg = True).</span>
<span class="n">master_bg</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Master-background subtraction in spec3 (subtract spectrum generated from the backgrounds).  This is the default pipeline setting.</span>
<span class="n">pixel_bg</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Pixel-based background subtraction in spec2 (direct pixel subtraction).</span>
</pre></div>
</div>
</div>
</div>
<section id="set-crds-context-and-server">
<h3>Set CRDS context and server<a class="headerlink" href="#set-crds-context-and-server" title="Permalink to this heading">#</a></h3>
<p>Before importing <code>CRDS</code> and <code>JWST</code> modules, we need to configure our environment. This includes defining a CRDS cache directory in which to keep the reference files that will be used by the calibration pipeline.</p>
<p>If the root directory for the local CRDS cache directory has not been set already, it will be set to create one in the home directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------------------------Set CRDS context and paths----------------------</span>

<span class="c1"># Set CRDS reference file context.  Leave commented-out to use the default context</span>
<span class="c1"># (latest reference files associated with the calibration pipeline version)</span>
<span class="c1"># or set a specific context here.</span>
<span class="c1">#%env CRDS_CONTEXT  jwst_1295.pmap</span>

<span class="c1"># Check whether the local CRDS cache directory has been set.</span>
<span class="c1"># If not, set it to the user home directory</span>
<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;crds&#39;</span><span class="p">)</span>
<span class="c1"># Check whether the CRDS server URL has been set.  If not, set it.</span>
<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://jwst-crds.stsci.edu&#39;</span>

<span class="c1"># Echo CRDS path and context in use</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CRDS local filepath:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CRDS file server:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="font-color-white-font-package-imports-a-class-anchor-id-intro-a">
<h2>2.<font color='white'>-</font>Package Imports<a class="anchor" id="intro"></a><a class="headerlink" href="#font-color-white-font-package-imports-a-class-anchor-id-intro-a" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the entire available screen width for this notebook</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;style&gt;.container { width:95% !important; }&lt;/style&gt;&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic system utilities for interacting with files</span>
<span class="c1"># ----------------------General Imports------------------------------------</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Numpy for doing calculations</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># -----------------------Astropy Imports-----------------------------------</span>
<span class="c1"># Astropy utilities for opening FITS and ASCII files, and downloading demo files</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Observations</span>

<span class="c1"># -----------------------Plotting Imports----------------------------------</span>
<span class="c1"># Matplotlib for making plots</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --------------JWST Calibration Pipeline Imports---------------------------</span>
<span class="c1"># Import the base JWST and calibration reference data packages</span>
<span class="kn">import</span> <span class="nn">jwst</span>
<span class="kn">import</span> <span class="nn">crds</span>

<span class="c1"># JWST pipelines (each encompassing many steps)</span>
<span class="kn">from</span> <span class="nn">jwst.pipeline</span> <span class="kn">import</span> <span class="n">Detector1Pipeline</span>
<span class="kn">from</span> <span class="nn">jwst.pipeline</span> <span class="kn">import</span> <span class="n">Spec2Pipeline</span>
<span class="kn">from</span> <span class="nn">jwst.pipeline</span> <span class="kn">import</span> <span class="n">Spec3Pipeline</span>

<span class="c1"># JWST pipeline utilities</span>
<span class="kn">from</span> <span class="nn">jwst</span> <span class="kn">import</span> <span class="n">datamodels</span>  <span class="c1"># JWST datamodels</span>
<span class="kn">from</span> <span class="nn">jwst.associations</span> <span class="kn">import</span> <span class="n">asn_from_list</span> <span class="k">as</span> <span class="n">afl</span>  <span class="c1"># Tools for creating association files</span>
<span class="kn">from</span> <span class="nn">jwst.associations.lib.rules_level2_base</span> <span class="kn">import</span> <span class="n">DMSLevel2bBase</span>  <span class="c1"># Definition of a Lvl2 association file</span>
<span class="kn">from</span> <span class="nn">jwst.associations.lib.rules_level3_base</span> <span class="kn">import</span> <span class="n">DMS_Level3_Base</span>  <span class="c1"># Definition of a Lvl3 association file</span>

<span class="kn">from</span> <span class="nn">jwst.stpipe</span> <span class="kn">import</span> <span class="n">Step</span>  <span class="c1"># Import the wrapper class for pipeline steps</span>

<span class="c1"># Echo pipeline version and CRDS context in use</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;JWST Calibration Pipeline Version = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jwst</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using CRDS Context = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crds</span><span class="o">.</span><span class="n">get_context_name</span><span class="p">(</span><span class="s1">&#39;jwst&#39;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<section id="define-convenience-functions">
<h3>Define convenience functions<a class="headerlink" href="#define-convenience-functions" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a convenience function to select only files of a given channel/band from an input set</span>
<span class="k">def</span> <span class="nf">select_ch_band_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">use_ch</span><span class="p">,</span> <span class="n">use_band</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">use_ch</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">use_band</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)):</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)):</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">verify</span><span class="p">()</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CHANNEL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">use_ch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;BAND&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">use_band</span><span class="p">)):</span>
                    <span class="n">keep</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">keep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">files_culled</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files_culled</span> <span class="o">=</span> <span class="n">files</span>
        
    <span class="k">return</span> <span class="n">files_culled</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start a timer to keep track of runtime</span>
<span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="font-color-white-font-demo-mode-setup-a-class-anchor-id-intro-a-ignore-if-not-using-demo-data">
<h2>3.<font color='white'>-</font>Demo Mode Setup<a class="anchor" id="intro"></a> (ignore if not using demo data)<a class="headerlink" href="#font-color-white-font-demo-mode-setup-a-class-anchor-id-intro-a-ignore-if-not-using-demo-data" title="Permalink to this heading">#</a></h2>
<p>If running in demonstration mode, set up the program information to
retrieve the uncalibrated data automatically from MAST using
<a class="reference external" href="https://astroquery.readthedocs.io/en/latest/mast/mast.html">astroquery</a>.
MAST allows for flexibility of searching by the proposal ID and the
observation ID instead of just filenames.<br></p>
<p>More information about the JWST file naming conventions can be found at:
https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/file_naming.html</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the program information and paths for demo program</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running in demonstration mode and will download example data from MAST!&#39;</span><span class="p">)</span>
    <span class="n">program</span> <span class="o">=</span> <span class="s2">&quot;01523&quot;</span>
    <span class="n">sci_observtn</span> <span class="o">=</span> <span class="s2">&quot;003&quot;</span>
    <span class="n">back_observtn</span> <span class="o">=</span> <span class="s2">&quot;004&quot;</span>
    <span class="n">visit</span> <span class="o">=</span> <span class="s2">&quot;001&quot;</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;mrs_demo_data&#39;</span><span class="p">)</span>
    <span class="n">download_dir</span> <span class="o">=</span> <span class="n">basedir</span>
    <span class="n">sci_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;Obs&#39;</span> <span class="o">+</span> <span class="n">sci_observtn</span><span class="p">)</span>
    <span class="n">bg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;Obs&#39;</span> <span class="o">+</span> <span class="n">back_observtn</span><span class="p">)</span>
    <span class="n">uncal_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;uncal&#39;</span><span class="p">)</span>
    <span class="n">uncal_bgdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="s1">&#39;uncal&#39;</span><span class="p">)</span>

    <span class="c1"># Ensure filepaths for input data exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">uncal_bgdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">uncal_bgdir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Identify list of science (SCI) and background (BG) uncalibrated files associated with visits.</p>
<div class="alert alert-block alert-warning">
Selects only <i>mirifu</i> data (ignores MIRI imager).
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obtain a list of observation IDs for the specified demo program</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="c1"># Science data</span>
    <span class="n">sci_obs_id_table</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">instrument_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;MIRI/IFU&quot;</span><span class="p">],</span>
                                                   <span class="n">provenance_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CALJWST&quot;</span><span class="p">],</span>  <span class="c1"># Executed observations</span>
                                                   <span class="n">obs_id</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jw&#39;</span> <span class="o">+</span> <span class="n">program</span> <span class="o">+</span> <span class="s1">&#39;-o&#39;</span> <span class="o">+</span> <span class="n">sci_observtn</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">]</span>
                                                   <span class="p">)</span>

    <span class="c1"># Background data</span>
    <span class="n">bg_obs_id_table</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">instrument_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;MIRI/IFU&quot;</span><span class="p">],</span>
                                                  <span class="n">provenance_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CALJWST&quot;</span><span class="p">],</span>  <span class="c1"># Executed observations</span>
                                                  <span class="n">obs_id</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jw&#39;</span> <span class="o">+</span> <span class="n">program</span> <span class="o">+</span> <span class="s1">&#39;-o&#39;</span> <span class="o">+</span> <span class="n">back_observtn</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">]</span>
                                                  <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn the list of visits into a list of uncalibrated data files</span>
<span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="c1"># Define types of files to select</span>
    <span class="n">file_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uncal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;product_type&#39;</span><span class="p">:</span> <span class="s1">&#39;SCIENCE&#39;</span><span class="p">,</span> <span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">:</span> <span class="s1">&#39;UNCAL&#39;</span><span class="p">,</span> <span class="s1">&#39;calib_level&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]}}</span>

    <span class="c1"># Science files</span>
    <span class="n">sci_files_to_download</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over visits identifying uncalibrated files that are associated with them</span>
    <span class="k">for</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sci_obs_id_table</span><span class="p">):</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">exposure</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filetype</span><span class="p">,</span> <span class="n">query_dict</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">filtered_products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">productType</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;product_type&#39;</span><span class="p">],</span>
                                                             <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">],</span>
                                                             <span class="n">calib_level</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;calib_level&#39;</span><span class="p">])</span>
            <span class="n">sci_files_to_download</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filtered_products</span><span class="p">[</span><span class="s1">&#39;dataURI&#39;</span><span class="p">])</span>

    <span class="c1"># Background files</span>
    <span class="n">bg_files_to_download</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over visits identifying uncalibrated files that are associated with them</span>
    <span class="k">for</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="p">(</span><span class="n">bg_obs_id_table</span><span class="p">):</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">exposure</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filetype</span><span class="p">,</span> <span class="n">query_dict</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">filtered_products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">productType</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;product_type&#39;</span><span class="p">],</span>
                                                             <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">],</span>
                                                             <span class="n">calib_level</span><span class="o">=</span><span class="n">query_dict</span><span class="p">[</span><span class="s1">&#39;calib_level&#39;</span><span class="p">])</span>
            <span class="n">bg_files_to_download</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filtered_products</span><span class="p">[</span><span class="s1">&#39;dataURI&#39;</span><span class="p">])</span>

    <span class="c1"># Cull to a unique list of files that contain &#39;mirifu&#39; in the filename</span>
    <span class="c1"># (i.e., not MIRI imager)</span>
    <span class="n">sci_files_to_download</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sci_files_to_download</span> <span class="k">if</span> <span class="s1">&#39;mirifu&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">bg_files_to_download</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bg_files_to_download</span> <span class="k">if</span> <span class="s1">&#39;mirifu&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Science files selected for downloading: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sci_files_to_download</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Background selected for downloading: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bg_files_to_download</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Download all the uncal files and place them into the appropriate directories.</p>
<div class="alert alert-block alert-warning">
Warning: If this notebook is halted during this step the downloaded file may be incomplete, and cause crashes later on!
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">demo_mode</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">sci_files_to_download</span><span class="p">:</span>
        <span class="n">sci_manifest</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">local_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">bg_files_to_download</span><span class="p">:</span>
        <span class="n">bg_manifest</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">local_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uncal_bgdir</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
<section id="font-color-white-font-directory-setup-a-class-anchor-id-intro-a">
<h2>4.<font color='white'>-</font>Directory Setup<a class="anchor" id="intro"></a><a class="headerlink" href="#font-color-white-font-directory-setup-a-class-anchor-id-intro-a" title="Permalink to this heading">#</a></h2>
<p>Set up detailed paths to input/output stages here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define output subdirectories to keep science data products organized</span>
<span class="n">uncal_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;uncal&#39;</span><span class="p">)</span>  <span class="c1"># Uncalibrated pipeline inputs should be here</span>
<span class="n">det1_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage1&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_detector1 pipeline outputs will go here</span>
<span class="n">spec2_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage2&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_spec2 pipeline outputs will go here</span>
<span class="n">spec3_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;stage3&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_spec3 pipeline outputs will go here</span>

<span class="c1"># Output subdirectories to keep background data products organized</span>
<span class="n">uncal_bgdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="s1">&#39;uncal&#39;</span><span class="p">)</span>  <span class="c1"># Uncalibrated pipeline inputs should be here</span>
<span class="n">det1_bgdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="s1">&#39;stage1&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_detector1 pipeline outputs will go here</span>
<span class="n">spec2_bgdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="s1">&#39;stage2&#39;</span><span class="p">)</span>  <span class="c1"># calwebb_spec2 pipeline outputs will go here</span>

<span class="c1"># We need to check that the desired output directories exist, and if not create them</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">spec2_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">spec2_dir</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">spec3_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">spec3_dir</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">bg_dir</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">det1_bgdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">det1_bgdir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">spec2_bgdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">spec2_bgdir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
If there is no background folder, ensure we don't try to process it.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">bg_dir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">dodet1bg</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dospec2bg</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
<section id="font-color-white-font-detector1-pipeline-a-class-anchor-id-det1-a">
<h2>5.<font color='white'>-</font>Detector1 Pipeline<a class="anchor" id="det1"></a><a class="headerlink" href="#font-color-white-font-detector1-pipeline-a-class-anchor-id-det1-a" title="Permalink to this heading">#</a></h2>
<p>In this section we process our data through the calwebb_detector1
pipeline to create Stage 1 data products (i.e., uncalibrated slope
images of the form *rate.fits).  These data products have units of DN/s.<BR><BR>
See https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline/stages-of-jwst-data-processing/calwebb_detector1</p>
<div class="alert alert-block alert-warning">
To override certain steps and reference files, use the examples provided below.<br>
E.g., turn on detection of cosmic ray showers.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the Detector1 pipeline should be configured</span>

<span class="c1"># Boilerplate dictionary setup</span>
<span class="n">det1dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;group_scale&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;dq_init&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;emicorr&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;saturation&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;ipc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;firstframe&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;lastframe&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;reset&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;linearity&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;rscd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;dark_current&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;refpix&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;charge_migration&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">],</span> <span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;ramp_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;gain_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped (example)</span>
<span class="c1">#det1dict[&#39;emicorr&#39;][&#39;skip&#39;] = True</span>

<span class="c1"># Overrides for various reference files</span>
<span class="c1"># Files should be in the base local directory or provide full path</span>
<span class="c1">#det1dict[&#39;dq_init&#39;][&#39;override_mask&#39;] = &#39;myfile.fits&#39; # Bad pixel mask</span>
<span class="c1">#det1dict[&#39;saturation&#39;][&#39;override_saturation&#39;] = &#39;myfile.fits&#39; # Saturation</span>
<span class="c1">#det1dict[&#39;reset&#39;][&#39;override_reset&#39;] = &#39;myfile.fits&#39; # Reset</span>
<span class="c1">#det1dict[&#39;linearity&#39;][&#39;override_linearity&#39;] = &#39;myfile.fits&#39; # Linearity</span>
<span class="c1">#det1dict[&#39;rscd&#39;][&#39;override_rscd&#39;] = &#39;myfile.fits&#39; # RSCD</span>
<span class="c1">#det1dict[&#39;dark_current&#39;][&#39;override_dark&#39;] = &#39;myfile.fits&#39; # Dark current subtraction</span>
<span class="c1">#det1dict[&#39;jump&#39;][&#39;override_gain&#39;] = &#39;myfile.fits&#39; # Gain used by jump step</span>
<span class="c1">#det1dict[&#39;ramp_fit&#39;][&#39;override_gain&#39;] = &#39;myfile.fits&#39; # Gain used by ramp fitting step</span>
<span class="c1">#det1dict[&#39;jump&#39;][&#39;override_readnoise&#39;] = &#39;myfile.fits&#39; # Read noise used by jump step</span>
<span class="c1">#det1dict[&#39;ramp_fit&#39;][&#39;override_readnoise&#39;] = &#39;myfile.fits&#39; # Read noise used by ramp fitting step</span>

<span class="c1"># Turn on multi-core processing for jump step (off by default).  Choose what fraction of cores to use (quarter, half, or all)</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">][</span><span class="s1">&#39;maximum_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;half&#39;</span>

<span class="c1"># Turn on detection of cosmic ray showers if desired (off by default)</span>
<span class="c1">#det1dict[&#39;jump&#39;][&#39;find_showers&#39;] = True</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
Below an example of how to insert custom pipeline steps using the
pre-hook/post-hook framework.
<p>For more information see <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline/tips-and-tricks-for-working-with-the-jwst-pipeline">Tips and Trick for working with the JWST Pipeline</a>
</div></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a new step called XplyStep that multiplies everything by 1.0</span>
<span class="c1"># I.e., it does nothing, but could be changed to do something more interesting.</span>
<span class="k">class</span> <span class="nc">XplyStep</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">class_alias</span> <span class="o">=</span> <span class="s1">&#39;xply&#39;</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sci</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span>
        <span class="n">sci</span> <span class="o">=</span> <span class="n">sci</span> <span class="o">*</span> <span class="mf">1.0</span>
        <span class="n">result</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">sci</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Multiplied everything by one in custom step!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="c1"># And here we&#39;ll insert it into our pipeline dictionary to be run at the end right after the gain_scale step</span>
<span class="n">det1dict</span><span class="p">[</span><span class="s1">&#39;gain_scale&#39;</span><span class="p">][</span><span class="s1">&#39;post_hooks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">XplyStep</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="calibrating-science-files">
<h3>Calibrating Science Files<a class="headerlink" href="#calibrating-science-files" title="Permalink to this heading">#</a></h3>
<p>Look for input science files and run calwebb_detector1 pipeline using the call method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Look for input files of the form *uncal.fits from the science observation</span>
<span class="n">sstring</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uncal_dir</span><span class="p">,</span> <span class="s1">&#39;jw*mirifu*uncal.fits&#39;</span><span class="p">)</span>
<span class="n">uncal_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sstring</span><span class="p">)))</span>
<span class="c1"># Check that these are the band/channel to use</span>
<span class="n">uncal_files</span> <span class="o">=</span> <span class="n">select_ch_band_files</span><span class="p">(</span><span class="n">uncal_files</span><span class="p">,</span> <span class="n">use_ch</span><span class="p">,</span> <span class="n">use_band</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uncal_files</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; science input files&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the pipeline on these input files by a simple loop over files using</span>
<span class="c1"># our custom parameter dictionary</span>
<span class="k">if</span> <span class="n">dodet1</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">uncal_files</span><span class="p">:</span>
        <span class="n">Detector1Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">det1dict</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">det1_dir</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Detector1 processing for SCI data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calibrating-background-files">
<h3>Calibrating Background Files<a class="headerlink" href="#calibrating-background-files" title="Permalink to this heading">#</a></h3>
<p>Look for input background files and run calwebb_detector1
pipeline using the call method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now let&#39;s look for input files of the form *uncal.fits from the background</span>
<span class="c1"># observations</span>
<span class="n">sstring</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uncal_bgdir</span><span class="p">,</span> <span class="s1">&#39;jw*mirifu*uncal.fits&#39;</span><span class="p">)</span>
<span class="n">uncal_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sstring</span><span class="p">)))</span>
<span class="c1"># Check that these are the band/channel to use</span>
<span class="n">uncal_files</span> <span class="o">=</span> <span class="n">select_ch_band_files</span><span class="p">(</span><span class="n">uncal_files</span><span class="p">,</span> <span class="n">use_ch</span><span class="p">,</span> <span class="n">use_band</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uncal_files</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; background input files&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the pipeline on these input files by a simple loop over files using</span>
<span class="c1"># our custom parameter dictionary</span>
<span class="k">if</span> <span class="n">dodet1bg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">uncal_files</span><span class="p">:</span>
        <span class="n">Detector1Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">det1dict</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">det1_bgdir</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Detector1 processing for BG data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
</section>
<section id="font-color-white-font-spec2-pipeline-a-class-anchor-id-spec2-a">
<h2>6.<font color='white'>-</font>Spec2 Pipeline<a class="anchor" id="spec2"></a><a class="headerlink" href="#font-color-white-font-spec2-pipeline-a-class-anchor-id-spec2-a" title="Permalink to this heading">#</a></h2>
<p>In this section we process our countrate (slope) image products from
Stage 1 (calwebb_detector1) through the Spec2 (calwebb_spec2) pipeline
in order to produce Stage 2
data products (i.e., calibrated slope images and quick-look data cubes
and 1d spectra).  These data products have units of MJy/sr (or Jy for
extracted point-source spectra).</p>
<p>See https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline/stages-of-jwst-data-processing/calwebb_spec2</p>
<div class="alert alert-block alert-warning">
If pixel-based background subtraction was chosen above, this will be
applied during this stage.
<p>To override certain steps and reference files use the examples below.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_spec2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the Spec2 pipeline should be configured.</span>

<span class="c1"># Boilerplate dictionary setup</span>
<span class="n">spec2dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;assign_wcs&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;badpix_selfcal&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;bkg_subtract&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;flat_field&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;srctype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;straylight&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;fringe&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;photom&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;residual_fringe&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;pixel_replace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;cube_build&#39;</span><span class="p">],</span> <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;extract_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped (example)</span>
<span class="c1">#spec2dict[&#39;straylight&#39;][&#39;skip&#39;] = True</span>

<span class="c1"># Pixel-based background usage was set up above, propagate that here</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pixel_bg</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;bkg_subtract&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">spec2dict</span><span class="p">[</span><span class="s1">&#39;bkg_subtract&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Overrides for various reference files</span>
<span class="c1"># Files should be in the base local directory or provide full path</span>
<span class="c1">#spec2dict[&#39;assign_wcs&#39;][&#39;override_distortion&#39;] = &#39;myfile.asdf&#39; # Spatial distortion (ASDF file)</span>
<span class="c1">#spec2dict[&#39;assign_wcs&#39;][&#39;override_regions&#39;] = &#39;myfile.asdf&#39; # IFU slice regions on detector (ASDF file)</span>
<span class="c1">#spec2dict[&#39;assign_wcs&#39;][&#39;override_specwcs&#39;] = &#39;myfile.asdf&#39; # Spectral distortion (ASDF file)</span>
<span class="c1">#spec2dict[&#39;assign_wcs&#39;][&#39;override_wavelengthrange&#39;] = &#39;myfile.asdf&#39; # Wavelength channel mapping (ASDF file)</span>
<span class="c1">#spec2dict[&#39;flat_field&#39;][&#39;override_flat&#39;] = &#39;myfile.fits&#39; # Pixel flatfield</span>
<span class="c1">#spec2dict[&#39;straylight&#39;][&#39;override_mrsxartcorr&#39;] = &#39;myfile.fits&#39; # Cross-artifact model parameters</span>
<span class="c1">#spec2dict[&#39;fringe&#39;][&#39;override_fringe&#39;] = &#39;myfile.fits&#39; # Static fringe-flat</span>
<span class="c1">#spec2dict[&#39;photom&#39;][&#39;override_photom&#39;] = &#39;myfile.fits&#39; # Photometric calibration array</span>
<span class="c1">#spec2dict[&#39;cube_build&#39;][&#39;override_cubepar&#39;] = &#39;myfile.fits&#39; # Cube-building parameters</span>
<span class="c1">#spec2dict[&#39;extract_1d&#39;][&#39;override_extract1d&#39;] = &#39;myfile.asdf&#39; # Spectral extraction parameters (ASDF file)</span>
<span class="c1">#spec2dict[&#39;extract_1d&#39;][&#39;override_apcorr&#39;] = &#39;myfile.asdf&#39; # Aperture correction parameters (ASDF file)</span>

<span class="c1"># Turn on 2d residual fringe correction (off by default)</span>
<span class="c1"># This can sometimes improve residual fringing in science results, but takes</span>
<span class="c1"># a long time to run and often does not work as well as 1d residual fringe</span>
<span class="c1"># correction (in calwebb_spec3)</span>
<span class="c1">#spec2dict[&#39;residual_fringe&#39;][&#39;skip&#39;] = False</span>

<span class="c1"># Turn on bad pixel self-calibration, where all exposures on a given detector are used to find and</span>
<span class="c1"># flag bad pixels that may have been missed by the bad pixel mask.</span>
<span class="c1"># This step is experimental, and works best when dedicated background observations are included</span>
<span class="c1">#spec2dict[&#39;badpix_selfcal&#39;][&#39;skip&#39;] = False</span>
<span class="c1">#spec2dict[&#39;badpix_selfcal&#39;][&#39;flagfrac_upper&#39;]=0.005 # Fraction of pixels to flag (dial as desired; 1.0 would be 100% of pixels)</span>
</pre></div>
</div>
</div>
</div>
<p>Define a function to create association files for Stage 2. This will enable use of the pixel-based background subtraction, if chosen above. This requires <em>one</em> input SCI file, but can have multiple input background files.</p>
<div class="alert alert-block alert-warning">
Note that the background will not be applied properly to all files if more than *one* SCI file is included in the association.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">writel2asn</span><span class="p">(</span><span class="n">onescifile</span><span class="p">,</span> <span class="n">bgfiles</span><span class="p">,</span> <span class="n">selfcalfiles</span><span class="p">,</span> <span class="n">asnfile</span><span class="p">,</span> <span class="n">prodname</span><span class="p">):</span>
    <span class="c1"># Define the basic association of science files</span>
    <span class="n">asn</span> <span class="o">=</span> <span class="n">afl</span><span class="o">.</span><span class="n">asn_from_list</span><span class="p">([</span><span class="n">onescifile</span><span class="p">],</span> <span class="n">rule</span><span class="o">=</span><span class="n">DMSLevel2bBase</span><span class="p">,</span> <span class="n">product_name</span><span class="o">=</span><span class="n">prodname</span><span class="p">)</span>  <span class="c1"># Wrap in array since input was single exposure</span>

    <span class="c1">#Channel/band configuration for this sci file</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">onescifile</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">verify</span><span class="p">()</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">this_channel</span><span class="p">,</span> <span class="n">this_band</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CHANNEL&#39;</span><span class="p">],</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;BAND&#39;</span><span class="p">]</span>

    <span class="c1"># If backgrounds were provided, find which are appropriate to this</span>
    <span class="c1"># channel/band and add to association</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">bgfiles</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">verify</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CHANNEL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">this_channel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BAND&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">this_band</span><span class="p">)):</span>
                <span class="n">asn</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;background&#39;</span><span class="p">})</span>
                
    <span class="c1"># If provided with a list of files to use for bad pixel self-calibration, find which</span>
    <span class="c1"># are appropriate to this detector and add to association</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">selfcalfiles</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">verify</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CHANNEL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">this_channel</span><span class="p">):</span>
                <span class="n">asn</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;selfcal&#39;</span><span class="p">})</span>                

    <span class="c1"># Write the association to a json file</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">serialized</span> <span class="o">=</span> <span class="n">asn</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Find and sort all of the input files, ensuring use of absolute paths</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sstring</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">det1_dir</span><span class="p">,</span> <span class="s1">&#39;jw*mirifu*rate.fits&#39;</span><span class="p">)</span>  <span class="c1"># Use files from the detector1 output folder</span>
<span class="n">ratefiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sstring</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratefiles</span><span class="p">)):</span>
    <span class="n">ratefiles</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">ratefiles</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
<span class="n">ratefiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ratefiles</span><span class="p">)</span>
<span class="c1"># Check that these are the band/channel to use</span>
<span class="n">ratefiles</span> <span class="o">=</span> <span class="n">select_ch_band_files</span><span class="p">(</span><span class="n">ratefiles</span><span class="p">,</span> <span class="n">use_ch</span><span class="p">,</span> <span class="n">use_band</span><span class="p">)</span>

<span class="c1"># Background Files</span>
<span class="n">sstring</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">det1_bgdir</span><span class="p">,</span> <span class="s1">&#39;jw*mirifu*rate.fits&#39;</span><span class="p">)</span>
<span class="n">bgfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sstring</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">)):</span>
    <span class="n">bgfiles</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
<span class="n">bgfiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">)</span>
<span class="c1"># Check that these are the band/channel to use</span>
<span class="n">bgfiles</span> <span class="o">=</span> <span class="n">select_ch_band_files</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">,</span> <span class="n">use_ch</span><span class="p">,</span> <span class="n">use_band</span><span class="p">)</span>

<span class="c1"># Define any files to use for self-calibration (if step enabled)</span>
<span class="c1"># Typically this is all science and background exposures</span>
<span class="n">selfcalfiles</span> <span class="o">=</span> <span class="n">ratefiles</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">selfcalfiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selfcalfiles</span><span class="p">,</span> <span class="n">bgfiles</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratefiles</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; science files&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; background files&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selfcalfiles</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; potential selfcal files&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Step through each of the science files, using relevant associated backgrounds in calwebb_spec2 processing.</p>
<div class="alert alert-block alert-warning">
The background files are used in this step to perform pixel-based background subtraction (if desired), otherwise background subtraction is done later with Spec3 files.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To save runtime, make a new version of our spec2 parameter dictionary</span>
<span class="c1"># that turns off creation of quicklook cubes and 1d spectra for science</span>
<span class="c1"># data</span>
<span class="n">spec2dict_sci</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">spec2dict</span><span class="p">)</span>
<span class="n">spec2dict_sci</span><span class="p">[</span><span class="s1">&#39;cube_build&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">spec2dict_sci</span><span class="p">[</span><span class="s1">&#39;extract_1d&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">if</span> <span class="n">dospec2</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">ratefiles</span><span class="p">:</span>
        <span class="n">asnfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;l2asn.json&#39;</span><span class="p">)</span>
        <span class="n">writel2asn</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">bgfiles</span><span class="p">,</span> <span class="n">selfcalfiles</span><span class="p">,</span> <span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;Level2&#39;</span><span class="p">)</span>
        <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">spec2dict_sci</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">spec2_dir</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Spec2 processing for SCI data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
Reduce the backgrounds individually.  This will be needed for the Master Background step in calwebb_spec3, but is unnecessary if doing calwebb_spec2 pixel based background instead.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dospec2bg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">bgfiles</span><span class="p">:</span>
        <span class="n">asnfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bg_dir</span><span class="p">,</span> <span class="s1">&#39;l2asn.json&#39;</span><span class="p">)</span>
        <span class="n">writel2asn</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">bgfiles</span><span class="p">,</span> <span class="n">selfcalfiles</span><span class="p">,</span> <span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;Level2&#39;</span><span class="p">)</span>
        <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">spec2dict</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">spec2_bgdir</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Spec2 processing for BG data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for Spec2: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_spec2</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
<section id="font-color-white-font-spec3-pipeline-a-class-anchor-id-spec3-a">
<h2>7.<font color='white'>-</font>Spec3 Pipeline<a class="anchor" id="spec3"></a><a class="headerlink" href="#font-color-white-font-spec3-pipeline-a-class-anchor-id-spec3-a" title="Permalink to this heading">#</a></h2>
<p>In this section weâ€™ll run the Spec3 (calwebb_spec3) pipeline to produce a
composite data cube and extracted spectrumfrom all dithered exposures.
We will need to create an association file from all science (*cal.fits)
and background (*x1d.fits) data in order for the pipeline to use them
appropriately.<br></p>
<p>Note that the data cubes created by the JWST pipeline are in SURFACE
BRIGHTNESS units (MJy/steradian), not flux units. What that means is
that if you intend to sum spectra within an aperture you need to be sure
to multiply by the pixel area in steradians first in order to get a
spectrum in flux units. This correction is already build into the pipeline
Extract1D algorithm.
The nominal pixel area in steradians is provided in the
<code>PIXAR_SR</code> keyword and can be found in the SCI
extension header.<BR></p>
<p>Spectral extraction for point sources uses a conical aperture extraction whose radius increases with wavelength, with annular background subtraction and aperture correction.  Spectral extraction for extended sources sums the entire image at each wavelength plane (note this is different for each channel). <BR></p>
<p>See https://jwst-docs.stsci.edu/jwst-science-calibration-pipeline/stages-of-jwst-data-processing/calwebb_spec3</p>
<div class="alert alert-block alert-warning">
If master background subtraction was selected above this will be applied
during this stage.<BR><BR>
To override certain steps and reference files use the examples below.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_spec3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a dictionary to define how the Spec3 pipeline should be configured</span>

<span class="c1"># Boilerplate dictionary setup</span>
<span class="n">spec3dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;assign_mtwcs&#39;</span><span class="p">],</span> <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;master_background&#39;</span><span class="p">],</span> <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;outlier_detection&#39;</span><span class="p">],</span> <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;mrs_imatch&#39;</span><span class="p">],</span> <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;cube_build&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;pixel_replace&#39;</span><span class="p">],</span> <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;extract_1d&#39;</span><span class="p">],</span> <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;spectral_leak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>

<span class="c1"># Overrides for whether or not certain steps should be skipped (example)</span>
<span class="c1">#spec3dict[&#39;outlier_detection&#39;][&#39;skip&#39;] = True</span>

<span class="c1"># Master background usage was set up above, propagate that here</span>
<span class="k">if</span> <span class="p">(</span><span class="n">master_bg</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;master_background&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;master_background&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Overrides for various reference files</span>
<span class="c1"># Files should be in the base local directory or provide full path</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;override_cubepar&#39;] = &#39;myfile.fits&#39;  # Cube-building parameters</span>
<span class="c1">#spec3dict[&#39;extract_1d&#39;][&#39;override_extract1d&#39;] = &#39;myfile.asdf&#39;  # Spectral extraction parameters (ASDF file)</span>
<span class="c1">#spec3dict[&#39;extract_1d&#39;][&#39;override_apcorr&#39;] = &#39;myfile.asdf&#39;  # Aperture correction parameters (ASDF file)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
Set certain parameters here to:
<ul class="simple">
<li><p>adjusting performance for the outlier detection step</p></li>
<li><p>adjust the cube building step</p></li>
<li><p>adjust the 1d spectral extraction</p></li>
</ul>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Options for adjusting performance for the outlier detection step</span>
<span class="c1">#spec3dict[&#39;outlier_detection&#39;][&#39;kernel_size&#39;] = &#39;11 1&#39;  # Dial this to adjust the detector kernel size</span>
<span class="c1">#spec3dict[&#39;outlier_detection&#39;][&#39;threshold_percent&#39;] = 99.5  # Dial this to be more/less aggressive in outlier flagging (values closer to 100% are less aggressive)</span>

<span class="c1"># Run pixel replacement code to extrapolate values for otherwise bad pixels</span>
<span class="c1"># This can help mitigate 5-10% negative dips in spectra of bright sources</span>
<span class="c1"># Use the &#39;mingrad&#39; algorithm</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;pixel_replace&#39;</span><span class="p">][</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;pixel_replace&#39;</span><span class="p">][</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mingrad&#39;</span>
<span class="c1">#spec3dict[&#39;pixel_replace&#39;][&#39;save_results&#39;] = True # Enable if desired to write out these files for spot checking</span>

<span class="c1"># Options for adjusting the cube building step</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;output_file&#39;] = &#39;mycube&#39;  # Custom output name</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;cube_build&#39;</span><span class="p">][</span><span class="s1">&#39;output_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;band&#39;</span>  <span class="c1"># &#39;band&#39;, &#39;channel&#39; (default), or &#39;multi&#39; type cube output.  &#39;band&#39; is best for 1d residual fringe correction.</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;channel&#39;] = &#39;1&#39;  # Build everything from just channel 1 into a single cube (we could also choose &#39;2&#39;,&#39;3&#39;,&#39;4&#39;, or &#39;ALL&#39;)</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;weighting&#39;] = &#39;drizzle&#39;  # Algorithm used: &#39;emsm&#39; or &#39;drizzle&#39; (default)</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;coord_system&#39;] = &#39;ifualign&#39;  # Cube rotation: &#39;ifualign&#39;, &#39;skyalign&#39; (default), or &#39;internal_cal&#39;</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;scalexy&#39;] = 0.5  # Output cube spaxel scale (arcsec) if setting it by hand</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;scalew&#39;] = 0.002  # Output cube voxel depth in wavelength (micron) if setting it by hand</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;ra_center&#39;] = 65.0  # Force cube to be centered at this R.A.</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;dec_center&#39;] = -35.0  # Force cube to be centered at this Decl.</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;cube_pa&#39;] = 45.0  # Force cube to have this position angle</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;nspax_x&#39;] = 61  # Force cube to have this number of spaxels in cube X direction</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;nspax_y&#39;] = 61  # Force cube to have this number of spaxels in cube Y direction</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;wavemin&#39;] = 4.8  # Custom minimum wavelength for the cube</span>
<span class="c1">#spec3dict[&#39;cube_build&#39;][&#39;wavemax&#39;] = 6.3  # Custom maximum wavelength for the cube</span>

<span class="c1"># Options for adjusting the 1d spectral extraction</span>
<span class="c1">#spec3dict[&#39;extract_1d&#39;][&#39;ifu_set_srctype&#39;] = &#39;POINT&#39; # Force a certain type of spectral extraction (&#39;POINT&#39; or &#39;EXTENDED&#39;)</span>
<span class="c1">#spec3dict[&#39;extract_1d&#39;][&#39;ifu_rscale&#39;] = 2  # Number of FWHM to use for point-source conical aperture extraction radius (default is 2)</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;extract_1d&#39;</span><span class="p">][</span><span class="s1">&#39;ifu_autocen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Enable auto-centering of the extraction aperture (default is True)</span>
<span class="c1">#spec3dict[&#39;extract_1d&#39;][&#39;center_xy&#39;] = (20,20)  # Override aperture location if desired</span>
<span class="n">spec3dict</span><span class="p">[</span><span class="s1">&#39;extract_1d&#39;</span><span class="p">][</span><span class="s1">&#39;ifu_rfcorr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Turn on 1d residual fringe correction (default is False)</span>
</pre></div>
</div>
</div>
</div>
<p>Define a function to create association files for Stage 3.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">writel3asn</span><span class="p">(</span><span class="n">scifiles</span><span class="p">,</span> <span class="n">bgfiles</span><span class="p">,</span> <span class="n">asnfile</span><span class="p">,</span> <span class="n">prodname</span><span class="p">):</span>
    <span class="c1"># Define the basic association of science files</span>
    <span class="n">asn</span> <span class="o">=</span> <span class="n">afl</span><span class="o">.</span><span class="n">asn_from_list</span><span class="p">(</span><span class="n">scifiles</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">DMS_Level3_Base</span><span class="p">,</span> <span class="n">product_name</span><span class="o">=</span><span class="n">prodname</span><span class="p">)</span>

    <span class="c1"># Add background files to the association</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">bgfiles</span><span class="p">:</span>
        <span class="n">asn</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;expname&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s1">&#39;exptype&#39;</span><span class="p">:</span> <span class="s1">&#39;background&#39;</span><span class="p">})</span>

    <span class="c1"># Write the association to a json file</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">serialized</span> <span class="o">=</span> <span class="n">asn</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Find and sort all of the input files, ensuring use of absolute paths</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Science Files need the cal.fits files</span>
<span class="n">sstring</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spec2_dir</span><span class="p">,</span> <span class="s1">&#39;jw*mirifu*cal.fits&#39;</span><span class="p">)</span>
<span class="n">calfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sstring</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">calfiles</span><span class="p">)):</span>
    <span class="n">calfiles</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">calfiles</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
<span class="n">calfiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calfiles</span><span class="p">)</span>
<span class="c1"># Check that these are the band/channel to use</span>
<span class="n">calfiles</span> <span class="o">=</span> <span class="n">select_ch_band_files</span><span class="p">(</span><span class="n">calfiles</span><span class="p">,</span> <span class="n">use_ch</span><span class="p">,</span> <span class="n">use_band</span><span class="p">)</span>

<span class="c1"># Background Files need the x1d.fits files for Master Background subtraction</span>
<span class="n">sstring</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spec2_bgdir</span><span class="p">,</span> <span class="s1">&#39;jw*mirifu*x1d.fits&#39;</span><span class="p">)</span>
<span class="n">bgfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sstring</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">)):</span>
    <span class="n">bgfiles</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
<span class="n">bgfiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">)</span>
<span class="c1"># Check that these are the band/channel to use</span>
<span class="n">bgfiles</span> <span class="o">=</span> <span class="n">select_ch_band_files</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">,</span> <span class="n">use_ch</span><span class="p">,</span> <span class="n">use_band</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calfiles</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; science files to process&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bgfiles</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; background files to process&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Make an association file that includes all of the different exposures. If using Master Background subtraction include the background data.</p>
<div class="alert alert-block alert-warning">
Note that science data must be of type cal.fits and background exposures must be of type x1d.fits
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">asnfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_dir</span><span class="p">,</span> <span class="s1">&#39;l3asn.json&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">dospec3</span><span class="p">:</span>
    <span class="n">writel3asn</span><span class="p">(</span><span class="n">calfiles</span><span class="p">,</span> <span class="n">bgfiles</span><span class="p">,</span> <span class="n">asnfile</span><span class="p">,</span> <span class="s1">&#39;Level3&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Run calwebb_spec3 using the call method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dospec3</span><span class="p">:</span>
    <span class="n">Spec3Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">spec3dict</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">spec3_dir</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Spec3 processing&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the time benchmark</span>
<span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime so far: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time0</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime for Spec3: </span><span class="si">{</span><span class="n">time1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_spec3</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr></section>
<section id="font-color-white-font-plot-the-spectra-a-class-anchor-id-plots-a">
<h2>8.<font color='white'>-</font>Plot the spectra<a class="anchor" id="plots"></a><a class="headerlink" href="#font-color-white-font-plot-the-spectra-a-class-anchor-id-plots-a" title="Permalink to this heading">#</a></h2>
<p>Here weâ€™ll plot the spectra to see what our source looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find and sort all of the input files</span>

<span class="c1"># Science Files</span>
<span class="c1"># Use the final extracted spectra (x1d.fits)</span>
<span class="n">sstring</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spec3_dir</span><span class="p">,</span> <span class="s1">&#39;*x1d.fits&#39;</span><span class="p">)))</span>
<span class="n">x1dfiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">sstring</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make normal plots</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1"># Interactive plots</span>
<span class="c1">#%matplotlib notebook</span>

<span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x1dfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1dfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">objname</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARGPROP&#39;</span><span class="p">]</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">objname</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>

<span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">x1dfiles</span><span class="p">:</span>
    <span class="n">x1d</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">x1ddata</span> <span class="o">=</span> <span class="n">x1d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">wave</span> <span class="o">=</span> <span class="n">x1ddata</span><span class="p">[</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">x1ddata</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="n">ymax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)])</span>

    <span class="c1"># labels</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">x1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CHANNEL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BAND&#39;</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="n">x1d</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;mrs_example_plot.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr><a class="reference internal image-reference" href="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_footer.png"><img alt="stsci_logo" src="https://github.com/spacetelescope/jwst-pipeline-notebooks/raw/main/_static/stsci_footer.png" style="width: 200px;" /></a>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jwst-pipeline-notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/MIRI"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-configuration-a-class-anchor-id-intro-a">1.<font color="white">-</font>Configuration<a class="anchor" id="intro"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-crds-context-and-server">Set CRDS context and server</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-package-imports-a-class-anchor-id-intro-a">2.<font color="white">-</font>Package Imports<a class="anchor" id="intro"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-convenience-functions">Define convenience functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-demo-mode-setup-a-class-anchor-id-intro-a-ignore-if-not-using-demo-data">3.<font color="white">-</font>Demo Mode Setup<a class="anchor" id="intro"></a> (ignore if not using demo data)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-directory-setup-a-class-anchor-id-intro-a">4.<font color="white">-</font>Directory Setup<a class="anchor" id="intro"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-detector1-pipeline-a-class-anchor-id-det1-a">5.<font color="white">-</font>Detector1 Pipeline<a class="anchor" id="det1"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrating-science-files">Calibrating Science Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrating-background-files">Calibrating Background Files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-spec2-pipeline-a-class-anchor-id-spec2-a">6.<font color="white">-</font>Spec2 Pipeline<a class="anchor" id="spec2"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-spec3-pipeline-a-class-anchor-id-spec3-a">7.<font color="white">-</font>Spec3 Pipeline<a class="anchor" id="spec3"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-plot-the-spectra-a-class-anchor-id-plots-a">8.<font color="white">-</font>Plot the spectra<a class="anchor" id="plots"></a></a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>